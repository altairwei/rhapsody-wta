# 1DPI 样品的差异状态分析 (Differential State analysis)

## 数据准备

`muscat` 包要求输入数据需要预先经过处理，比如整合、聚类和细胞注释等等，因此这里我们直接加载已经处理过的 `Seurat` 对象。

```{r message=FALSE}
library(magrittr)

obj <- readRDS("../../results/IntegratedAnalysis/1DPI-All/Seurat_Object_Combined.rds")
sce <- rhapsodykit::prepare_muscat_sce(obj, group_make_names = TRUE)
```

## 数据概览

差异状态分析依赖于细胞亚群的大小，因此群体规模太小的亚群应该事先排除掉。

```{r}
cluster_stats <- table(sce$cluster_id, sce$sample_id)
t(cluster_stats)
```

### 相对细胞群集丰度

```{r warning=FALSE}
cluster_prop <- prop.table(cluster_stats, 2)
cluster_prop_df <- reshape2::melt(
  cluster_prop,
  varnames = c("cluster_id", "sample_id"),
  value.name = "frequency",
  as.is = TRUE
)

cluster_prop_df$cluster_id <- factor(type.convert(cluster_prop_df$cluster_id))
cluster_prop_df$group_id <- sce$group_id[match(cluster_prop_df$sample_id, sce$sample_id)]

cluster_prop_df %>%
  ggplot2::ggplot(ggplot2::aes(
    x = sample_id, y = frequency, fill = cluster_id)) +
  ggplot2::scale_y_continuous(breaks = seq(0, 1, 0.2), expand = c(0, 0)) +
  ggplot2::facet_wrap("group_id", ncol = 1, scales = "free_y") +
  ggplot2::geom_bar(stat = "identity", col = "white",  width = 1, size = 0.2) + 
  ggplot2::scale_x_discrete(expand = c(0, 0)) +
  ggplot2::coord_flip() +
  ggplot2::theme(
    aspect.ratio = NULL, 
    panel.grid = ggplot2::element_blank(), panel.spacing = grid::unit(1, "mm"), 
    strip.text = ggplot2::element_blank(),  strip.background = ggplot2::element_blank())
```

### 样本细胞数量

```{r}
# cell counts by sample
sample_cells_df <- reshape2::melt(table(sce$sample_id), varnames = "sample_id", value.name = "n_cells")
sample_cells_df$group_id <- sce$group_id[match(sample_cells_df$sample_id, sce$sample_id)]

sample_cells_df %>%
  ggplot2::ggplot(ggplot2::aes(
    x = sample_id, y = n_cells, fill = group_id)) +
  ggplot2::scale_y_continuous("nb. of cells", limits = c(0, 7500), 
        breaks = seq(0, 7500, 2500), expand = c(0, 0)) +
  ggplot2::facet_wrap("group_id", ncol = 1, scales = "free_y") +
  ggplot2::geom_bar(stat = "identity", col = "white",  width = 1, size = 0.2) + 
  ggplot2::scale_x_discrete(expand = c(0, 0)) +
  ggplot2::coord_flip() +
  ggplot2::theme(aspect.ratio = NULL, 
    panel.grid = ggplot2::element_blank(), panel.spacing = grid::unit(1, "mm"), 
    strip.text = ggplot2::element_blank(),  strip.background = ggplot2::element_blank())
```


## 差异状态分析

### 将单细胞聚合成 pseudo-bulk 数据

差异状态分析有两类方法，其中之一是基于聚合数据的差异基因表达方法。

所以我们首先将单细胞数据聚合成 pseudo-bulk 数据：

```{r warning=FALSE}
pb_list <- list(
  "counts" = rhapsodykit::calculate_pseudo_bulk(sce, "counts"),
  "logcounts" = rhapsodykit::calculate_pseudo_bulk(sce, "logcounts"),
  "cpm" = rhapsodykit::calculate_pseudo_bulk(sce, "cpm")
  #"vstresiduals" = rhapsodykit::calculate_pseudo_bulk(sce, "vstresiduals")
)
```

变量 `pb` 实际上也是一个 `SingleCellExperiment` 对象，每一个 assay 都是一个 cluster 的 pseudo-bulk 数据。

我们需要通过 MDS plot 查看一下 pseudo-bulk 是否能够反应样本间的相似性：

```{r}
mds_plot_list <- lapply(pb_list, function(pb) {
  pb_mds <- muscat::pbMDS(pb)
  pb_mds +
    ggplot2::scale_shape_manual(values = c(15, 8, 10)) +
    ggplot2::theme(legend.position = "right", legend.box = "horizontal")
})
```

首先我们看看 `logcounts` 类型 pseudo-bulk 数据：

```{r}
mds_plot_list$logcounts
```

理论上，MDS 的第一个维度应该将 cluster 分开，第二个维度应该讲 group 分开。从结果上来看，MDS1 确实将 cluster 分开了；而 MDS2 也将 group 区分开，1DPI-MOCK 在 cluster 中总是靠下，1DPI-PNR2 靠中，1DPI-TR4 总是靠上。

然后是 `counts` 类型：

```{r}
mds_plot_list$counts
```

从 `counts` 类型数据的 MDS 图来看，我们可以很清晰的认识到 cluster 就是沿着 MDS1 被分开的。但是 group 在 MDS2 上的趋势不是很明显。

接着是 `cpm` 类型：

```{r}
mds_plot_list$cpm
```

我们可以发现 `cpm` 和 `counts` 类型数据的 MDS 图非常相似。因为本质上它们两者是一致的，并且都没有经过归一化，所以不适合用来画 MDS 图。

### 样品水平的分析: 基于聚合的方法

当我们组装好 pseudo-bulk 数据后，就可以开展基于聚合的差异状态分析了。基于聚合的差异状态方法依赖于 bulk RNA-Seq 领域已经常用的差异基表达分析方法，而这些方法对输入数据的数值类型是有要求的吗，比如：

-   limma-voom 和 edgeR 处理 pseudo-bulk counts；DESeq2 应该也是处理 pseudo-bulk counts
-   limma-trend 处理 library-size 归一化并且 log 转化后的 counts 平均值

各种差异状态分析方法依赖的数值类型可以参考 [HelenaLC/muscat-comparison](https://github.com/HelenaLC/muscat-comparison) 仓库库中 `scripts/meth_pars.R` 文件内容:

```{r eval=FALSE, include=FALSE}
pb <- dplyr::bind_rows(
    expand.grid(
        stringsAsFactors = FALSE,
        assay = "counts", fun = "sum", scale = FALSE, 
        method = c("edgeR", "limma-voom"),
        treat = c(FALSE, TRUE)
    ),
    expand.grid(
        stringsAsFactors = FALSE, scale = FALSE,
        assay = c("logcounts", "vstresiduals"),
        fun = "mean", method = "limma-trend"
    ),
    data.frame(
        stringsAsFactors = FALSE, scale = TRUE,
        assay = "cpm", fun = "sum", method = "edgeR",
        treat = c(FALSE, TRUE)
    )
)
```

可以使用 `muscat::pbDS` 函数完成任务，不过当要比较的 group 超过两个时，我们需要首先构建 design 矩阵以及 contrast 矩阵：

我们看看实验相关的信息，主要是 sample 属于哪个 group ：

```{r message=FALSE}
S4Vectors::metadata(sce)$experiment_info
```

在需要提供的数据中，design 矩阵起着指示器的作用，它用于表明样本属于哪个组。而 `model.matrix` 的统计学含义以及用法可以参考 [Expressing design formula in R](https://genomicsclass.github.io/book/pages/expressing_design_formula.html) 。contrast 矩阵用于表明我们想要比较哪两个组，以 `stim-ctrl` 字符串的形式指定，实验组在 `-` 前，对照组在后。我在 `rhapsodykit` 中提供了一个方便的帮助函数，自动构建 design 和 contrast 矩阵。

```{r}
# run DS analysis
ds_res <- list(
  edgeR = rhapsodykit::pseudobulk_diff_state(
    sce, pb_list$counts,
    method = "edgeR",
    contrasts = c(
      "X1DPI.PNR2-X1DPI.MOCK",
      "X1DPI.TR4-X1DPI.MOCK",
      "X1DPI.PNR2-X1DPI.TR4"
    )
  ),
  DESeq2 = rhapsodykit::pseudobulk_diff_state(
    sce, pb_list$counts,
    method = "DESeq2",
    contrasts = c(
      "X1DPI.PNR2-X1DPI.MOCK",
      "X1DPI.TR4-X1DPI.MOCK",
      "X1DPI.PNR2-X1DPI.TR4"
    )
  )
)

str(ds_res$edgeR$table, max.level = 1)
```

差异基因表达分析的结果储存在 `res_list` 列表中，而其成员则是 `contrast` 参数所指定的比较组合。每个比较组合又是一个列表，并且包含了针对每个 cluster 的差异表达分析结果。

```{r}
# access results table for 1st comparison
cluster1 <- ds_res$DESeq2$table[["X1DPI.PNR2-X1DPI.MOCK"]][["1"]]
head(cluster1)
```

1DPI-PNR2 vs. 1DPI-MOCK 比较组合中 cluster 1 的差异基因表达结果如上所示。

### 细胞水平的分析: 混合模型

如果我们不愿意基于聚合来展开差异状态分析，还可以基于细胞水平数据通过 Mixed Models 来完成差异状态分析。`muscat` 主要实现了三种方法：

1.  fitting linear mixed models (LMMs) on log-normalized data with observational weights;
2.  fitting LMMs on variance-stabilized data;
3.  fitting generalized linear mixed models (GLMMs) directly on counts.

```{r message=FALSE, eval=FALSE}
# 1st approach
mm_dream = muscat::mmDS(sce, n_threads = 2, method = "dream", n_cells = 10, n_samples = 2, min_count = 1, min_cells = 20)

# 2nd & 3rd approach
mm_vst = muscat::mmDS(sce, n_threads = 2, method = "vst", vst = "sctransform")
mm_nbinom = muscat::mmDS(sce, n_threads = 2, method = "nbinom")

str(mm_dream)
```

### 寻找组间特异性标识基因

这里出现一个很有意义的问题：**如何找出 group 特异性的 DS 基因集**？

是否可以参考 Seurat 包鉴定 cluster 特异性 marker 的方法，将某个 group 与其余所有 group 一起比较。

阅读 `Seurat::FindAllMarkers` 源代码，找到鉴定 Marker 的方法。

> Seurat can help you find markers that define clusters via differential expression. By default, it identifies positive and negative markers of a single cluster (specified in `ident.1`), compared to all other cells.

也就是说，contrast 的一方是目标组，另一方是剩下所有样品。

```{r}
markers <- list(
  "PNR2"= rhapsodykit::find_group_marker_genes(sce, pb_list$counts, "X1DPI.PNR2" ,method = "DESeq2")
)

markers$PNR2 %>%
  rhapsodykit::diff_state_filter() %>%
  rhapsodykit::diff_state_summary()
```

## 处理结果

### 结果的过滤与概览

我们要对差异状态分析的结果进行过滤，我们基于基因表达的变化幅度和显著性来过滤：

```{r}
# filter FDR < 5%, abs(logFC) > 1 & sort by adj. p-value
ds_res$edgeR %>%
  rhapsodykit::diff_state_filter(0.05, 1) %>%
  rhapsodykit::diff_state_summary()
```

然后是 DESeq2 的分析结果：

```{r}
ds_res$DESeq2 %>%
  rhapsodykit::diff_state_filter(0.05, 1) %>%
  rhapsodykit::diff_state_summary()
```


### 计算表达频率

除了查看基因表达的变化幅度和显著性外，我们还可以看看基因表达的频率，即一个样本或组别中表达给定基因的细胞所占的比例。

```{r}
ds_res$edgeR %>%
  rhapsodykit::diff_state_filter(0.05, 1) %>%
  rhapsodykit::expr_freq_filter(sce) %>%
  rhapsodykit::diff_state_summary()
```

### 格式化结果

当比较的组别数量非常多时，我们就需要将它们转化为一个方便查看或者操作的格式。其中 `res` 必须是 `muscat::pbDS` 或 `muscat::mmDS` 的计算结果。

```{r eval=FALSE}
# tidy format; attach pre-computed expression frequencies
muscat::resDS(sce, res, bind = "row", frq = frq)

# big-table (wide) format; attach CPMs
muscat::resDS(sce, res, bind = "col", cpm = TRUE)

# compute expression frequencies on the fly
muscat::resDS(sce, res, frq = TRUE)
```

## 对结果可视化

### 可视化 DS 基因的数量

我们可以查看一下 edgeR 和 DESeq2 两种方法发现的差异基因数量：

```{r}
patchwork::wrap_plots(
  ds_res$edgeR %>%
    rhapsodykit::diff_state_filter() %>%
    rhapsodykit::genecount_diff_state() +
    ggplot2::ggtitle("edgeR"),
  ds_res$DESeq2 %>%
    rhapsodykit::diff_state_filter() %>%
    rhapsodykit::genecount_diff_state() +
    ggplot2::ggtitle("DESeq2"),
  ncol = 1,
  guides = "collect"
)
```

总体来说，edgeR 与 DESeq2 发现的基因数量大体趋势是一致的，只不过两种方法计算出的 p_adj.loc 可能有所差别。从 TR4 与 PNR2 相对于 MOCK 的转录反应来看，小麦胚芽鞘似乎都不知道 *Fusarium. graminearum* 以及进入体内了。

我们首先画一下 `X1DPI.PNR2-X1DPI.MOCK` 火山图：

```{r}
df_to_plot <- ds_res$edgeR %>% rhapsodykit::diff_state_format()
dplyr::filter(df_to_plot, contrast == "X1DPI.PNR2-X1DPI.MOCK") %>%
  rhapsodykit::volcano_diff_state(title = "1DPI-PNR2 vs. 1DPI-MOCK")
```

然后看一下 `X1DPI.TR4-X1DPI.MOCK` 的火山图：

```{r}
dplyr::filter(df_to_plot, contrast == "X1DPI.TR4-X1DPI.MOCK") %>%
  rhapsodykit::volcano_diff_state(title = "X1DPI.TR4-X1DPI.MOCK")
```

最后比较一下 `X1DPI.PNR2-X1DPI.TR4`:

```{r}
dplyr::filter(df_to_plot, contrast == "X1DPI.PNR2-X1DPI.TR4") %>%
  rhapsodykit::volcano_diff_state(title = "X1DPI.PNR2-X1DPI.TR4")
```


### 细胞亚群间的一致性

我们可以通过集合的可视化来看看细胞亚群之间的 DS 基因是否有交集：

```{r}
tbl_filtered <- ds_res$edgeR %>%
  rhapsodykit::diff_state_filter() %>%
  .$table %>% .[["X1DPI.PNR2-X1DPI.MOCK"]]

de_gs_by_k <- purrr::map(tbl_filtered, "gene")
UpSetR::upset(UpSetR::fromList(de_gs_by_k))
```

TODO: 那么如何使用 UpSetR 来查看不同 contrast 间基因集的差异呢？

### 表达量在降维图上的投影

既然知道了差异基因，那么我们可以尝试将表达量投影到降维散点图中。

```{r}
# pull top-4 DS genes across all clusters
top4 <- dplyr::bind_rows(tbl_filtered) %>% 
  dplyr::top_n(4, dplyr::desc(p_adj.loc)) %>% 
  dplyr::pull("gene") %>%
  .[1:4]

# for ea. gene in 'top4', plot t-SNE colored by its expression 
ps <- lapply(top4, function(gene) {
  Seurat::DefaultAssay(obj) <- "RNA"
  Seurat::FeaturePlot(
      obj, gene,
      reduction = "tsne",
      pt.size = 0.05,
      label = TRUE) +
    ggplot2::ggtitle(gene) +
    ggplot2::theme_bw(8) +
    ggplot2::theme(legend.position = "none")
})

# arrange plots
cowplot::plot_grid(plotlist = ps, ncol = 2, align = "vh")
```

### 细胞水平的可视化: 小提琴图

我们可以从细胞水平来看看这些 DS 基因的差异性分布：

```{r}
scater::plotExpression(sce[, sce$cluster_id == "14"],
  features = tbl_filtered$`14`$gene[seq_len(6)],
  x = "sample_id", colour_by = "group_id", ncol = 3) +
  ggplot2::guides(fill = ggplot2::guide_legend(override.aes = list(size = 5, alpha = 1))) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
```

用 `Seurat::VlnPlot` 画不出上面这个图。

### 样本水平的可视化: Pseudobulk 热图

如果我们基于聚合来做 DS 分析，那么我们天然会想到画一个热图：

```{r}
pb_arr <- abind::abind(as.list(pb_list$logcounts@assays@data), along = 3)

genes <- dplyr::bind_rows(tbl_filtered) %>%
  dplyr::pull("gene")

# top-5 DS genes per cluster
rhapsodykit::heatmap_cross_sample(
  pb_arr, genes,
  clusters = c("1", "14"),
  type = "logcounts",
  show_row_names = FALSE)
```

待改进之处：

-   添加横坐标 group 注释
-   将横坐标以 group 分割

TODO: 参考 (Crowell et al. 2020) Fig. 4D 绘制一幅热图，寻找差异表达模组。