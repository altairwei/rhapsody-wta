---
title: "Developmental Process of MOCK Samples"
author: "Altair Wei"
date: '2022-10-05'
output: html_document
---

```{r setup, include=FALSE}
library(SingleCellExperiment)
knitr::opts_chunk$set(echo = TRUE)
source("../scripts/TrajectoryUtilities.R")
plt <- reticulate::import("matplotlib.pyplot")
scv <- reticulate::import("scvelo")
```

```{python}
import scvelo as scv
import matplotlib.pyplot as plt
import scanpy as sc
```

```{r message=FALSE, warning=FALSE, results="hide"}
library(org.Taestivum.iwgsc.db)
orgdb <- org.Taestivum.iwgsc.db
```

## 1 准备数据集

```{r}
samples <- c(
  "0DPI-MOCK-1",
  "0DPI-MOCK-2",
  "1DPI-MOCK-1",
  "1DPI-MOCK-2",
  "2DPI-MOCK-1",
  "2DPI-MOCK-2",
  "3DPI-MOCK-1",
  "3DPI-MOCK-2"
)

data_folders <- structure(
  paste0("../results/RawOutput/", samples), names = samples)

data_list <- xfun::cache_rds(
  file = "velocity_mock_data_list.rds",
  dir = "../results/ObjectCache/TrajectoryInference/",
  expr = lapply(data_folders, function(base_dir) {
    loom_file = paste0(base_dir, "/Velocyto/", basename(base_dir), ".loom")
    SeuratWrappers::ReadVelocity(loom_file)
   })
)
```

```{r}
fixCellNames <- function(mtx_list) {
  lapply(mtx_list, function(mtx) {
    colnames(mtx) <- colnames(mtx) |>
      stringr::str_sub(end = -2L) |>
      stringr::str_replace(stringr::fixed(":"), "_")
    mtx
  })
}

spliced <- xfun::cache_rds(
  file = "velocity_mock_mtx_spliced.rds",
  dir = "../results/ObjectCache/TrajectoryInference/",
  expr = do.call(cbind, fixCellNames(lapply(data_list, "[[", "spliced")))
)

unspliced <- xfun::cache_rds(
  file = "velocity_mock_mtx_unspliced.rds",
  dir = "../results/ObjectCache/TrajectoryInference/",
  expr = do.call(cbind, fixCellNames(lapply(data_list, "[[", "unspliced")))
)

ambiguous <- xfun::cache_rds(
  file = "velocity_mock_mtx_ambiguous.rds",
  dir = "../results/ObjectCache/TrajectoryInference/",
  expr = do.call(cbind, fixCellNames(lapply(data_list, "[[", "ambiguous")))
)
```

```{r}
obj_mock <- readRDS(Sys.glob(
  "../results/ObjectCache/IntegrationAndAnnotation/obj_mock_annotated_*.rds"))
```

```{r}
sce_mock <- xfun::cache_rds(
  file = "sce_mock_spliced.rds",
  dir = "../results/ObjectCache/TrajectoryInference/",
  expr = local({
    obj_mock$cellType <- Seurat::Idents(obj_mock)
    sce <- Seurat::as.SingleCellExperiment(obj_mock, assay = "RNA")
    sce <- muscat::prepSCE(sce,
      kid = "ident", # subpopulation assignments
      gid = "group", # group IDs (ctrl/stim)
      sid = "sample", # sample IDs (ctrl/stim.1234)
      drop = FALSE
    )

    cell_names <- colnames(sce)
    gene_names <- rownames(sce)
    assay(sce, "spliced") <- spliced[gene_names, cell_names]
    assay(sce, "unspliced") <- unspliced[gene_names, cell_names]

    sce
  })
)
```

## 2 降维分析 {.tabset}

```{r}
sce_mock <- runDiffusionMap(sce_mock, dimred = "HARMONY")
sce_mock <- runPHATE(sce_mock, dimred = "HARMONY")
```

### UMAP

```{r}
scater::plotUMAP(sce_mock, colour_by = "cluster_id", point_size = 0.5) +
  ggplot2::guides(color = ggplot2::guide_legend(override.aes = list(size = 2))) +
  ggplot2::coord_fixed()
```

### t-SNE

```{r}
scater::plotTSNE(sce_mock, colour_by = "cluster_id", point_size = 0.5) +
  ggplot2::guides(color = ggplot2::guide_legend(override.aes = list(size = 2))) +
  ggplot2::coord_fixed()
```

### DiffusionMap

```{r}
scater::plotDiffusionMap(sce_mock, colour_by = "cluster_id", point_size = 0.5) +
  ggplot2::guides(color = ggplot2::guide_legend(override.aes = list(size = 2))) +
  ggplot2::coord_fixed()
```

### PHATE

```{r}
scater::plotReducedDim(sce_mock, dimred = "PHATE", colour_by = "cluster_id", point_size = 0.5) +
  ggplot2::guides(color = ggplot2::guide_legend(override.aes = list(size = 2))) +
  ggplot2::coord_fixed()
```

## 3 共变邻域分析

```{r}
obj_mock$time_val <- as.numeric(factor(
  obj_mock$time, levels = c("0DPI", "1DPI", "2DPI", "3DPI")))

obj_mock <- rcna::association.Seurat(
  seurat_object = obj_mock,
  test_var = "time_val",
  samplem_key = "sample",
  graph_use = "RNA_nn",
  batches = NULL,
  covs = NULL
)
```

### 时间系列

```{r fig.height=3, fig.width=11}
Seurat::DimPlot(obj_mock, reduction = "umap", split.by = "time") &
  ggplot2::coord_fixed()
```

### 表型关联结果 {.tabset}

```{r}
blue_to_orange <- rev(ggthemes::ggthemes_data[[
  c("tableau", "color-palettes", "ordered-diverging", "Orange-Blue Diverging")]][["value"]])
```

在下面的图中，每个单元格根据其邻域系数着色，即颜色对应于每个细胞相应邻域的丰度与样本属性的相关性。由于我们将时间编码成了数字，因此从蓝色到橙红色代表了 0DPI \~ 3DPI 的邻域系数。

#### UMAP

```{r fig.height=8, fig.width=16}
p1 <- Seurat::FeaturePlot(obj_mock, reduction = "umap", features = c("cna_ncorrs")) &
  ggplot2::scale_color_gradientn(colours = blue_to_orange) &
  ggplot2::coord_fixed()

p2 <- Seurat::DimPlot(obj_mock, reduction = "umap", group = "group") &
  ggplot2::coord_fixed()

p1[[1]] + p2 + patchwork::plot_layout(nrow = 1)
```

#### t-SNE

```{r fig.height=8, fig.width=16}
p1 <- Seurat::FeaturePlot(obj_mock, reduction = "tsne", features = c("cna_ncorrs")) &
  ggplot2::scale_color_gradientn(colours = blue_to_orange) &
  ggplot2::coord_fixed()

p2 <- Seurat::DimPlot(obj_mock, reduction = "tsne", group = "group") &
  ggplot2::coord_fixed()

p1[[1]] + p2 + patchwork::plot_layout(nrow = 1)
```

### Neighborhood loadings of NAM PCs

查看源代码可知，`NAM_nbhdXpc` 等于 `NAM_embeddings`，而 `NAM_sampleXpc` 等于 `NAM_loadings` 。

```{r fig.height=8, fig.width=14}
p <- Seurat::FeaturePlot(
    obj_mock, reduction = "umap",
    features = paste0("NAMPC_", 1:6),
    ncol = 3, order = TRUE) &
  ggplot2::scale_color_gradientn(colours = blue_to_orange) &
  ggplot2::coord_fixed()

p
```

### Variance explained by NAM PCs

```{r}
data.frame(
  sig2 = obj_mock@reductions$cna@misc$NAM_svs
          / sum(obj_mock@reductions$cna@misc$NAM_svs)) |>
    tibble::rowid_to_column('PC') |>
    ggplot2::ggplot(ggplot2::aes(PC, sig2)) + 
        ggplot2::geom_point() + 
        ggplot2::geom_line() + 
        ggplot2::theme_classic(base_size = 14) + 
        ggplot2::labs(y = 'Fraction of variance explained', x = 'NAM PC') + 
        ggplot2::scale_x_continuous(breaks = 1:20)
```

### Per-gene correlations to neighborhood coefficient

```{r}
ncorrs <- as(matrix(obj_mock$cna_ncorrs, ncol = 1), "dgCMatrix")
genes <- qlcMatrix::corSparse(ncorrs, t(obj_mock@assays$RNA@counts))
genes <- structure(as.numeric(genes), names = rownames(obj_mock@assays$RNA@counts))
genes <- sort(genes, decreasing = TRUE)
```

```{r}
gsea <- clusterProfiler::gseGO(
  genes,
  ont = "BP",
  OrgDb = org.Taestivum.iwgsc.db,
  keyType = "GID"
)

gsea <- clusterProfiler::simplify(gsea)
```

```{r fig.height=10, fig.width=10}
p <- gsea |>
  enrichplot::pairwise_termsim() |>
  enrichplot::treeplot(
    showCategory = 40, nCluster = 12,
    offset = 20, offset_tiplab = 1,
    label_format_cladelab = 5, color = "NES",
    geneClusterPanel = "dotplot", nWords = 0) +
  ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = c(0, 0), add = c(6, 0))) +
  ggplot2::scale_color_gradient2(low = "blue", mid = "white", high = "red", name = "NES") +
  ggplot2::coord_cartesian()
p
```

从上面的 GO 词条来看，这确实像是发育程序。

### Sample loadings of NAM PCs

```{r}
sample_df <- as.data.frame(obj_mock@reductions$cna@feature.loadings[, 1:2])
sample_df$sample <- stringr::str_extract(rownames(sample_df), "\\dDPI-MOCK")

ggplot2::ggplot(sample_df, ggplot2::aes(NAMPC_1, NAMPC_2, color = sample)) +
  ggplot2::geom_point()
```

## 4 UniTVelo 速率模型

```{r}
sce_mock <- sce_mock[, sce_mock$cluster_id %in% c(
  "Me_α", "Me_β", "Me_γ", "Me_δ", "Me_ε",
  "BS", "MPV", "Va_α", "Va_β", "Va_γ", "Va_δ"
)]

embed_umap <- reducedDim(sce_mock, "UMAP")

sce_mock <- sce_mock[,
  embed_umap[, 1L] < 10
    & embed_umap[, 1L] > -10
    & embed_umap[, 2L] < 10
]
```

### 降维可视化 {.tabset}

```{r}
sce_mock <- runDiffusionMap(sce_mock, dimred = "HARMONY", seed = 1117L)
sce_mock <- runPHATE(sce_mock, dimred = "HARMONY", seed = 2019, knn = 15, t = 30)
```

#### UMAP

```{r}
scater::plotReducedDim(sce_mock, dimred = "UMAP",
    point_size = 0.5,
    colour_by = "cellType",
    text_by = "cellType",
    text_size = 3) +
  ggplot2::guides(color = ggplot2::guide_legend(
    override.aes = list(size = 2))) +
  ggplot2::coord_fixed()
```


#### t-SNE

```{r}
scater::plotReducedDim(sce_mock, dimred = "TSNE",
    point_size = 0.5,
    colour_by = "cellType",
    text_by = "cellType",
    text_size = 3) +
  ggplot2::guides(color = ggplot2::guide_legend(
    override.aes = list(size = 2))) +
  ggplot2::coord_fixed()
```

#### PHATE

```{r}
scater::plotReducedDim(sce_mock, dimred = "PHATE",
    point_size = 0.5,
    colour_by = "cellType",
    text_by = "cellType",
    text_size = 3) +
  ggplot2::guides(color = ggplot2::guide_legend(
    override.aes = list(size = 2))) +
  ggplot2::coord_fixed()
```

#### DiffusionMap

```{r}
scater::plotReducedDim(sce_mock, dimred = "DiffusionMap",
    point_size = 0.5,
    colour_by = "cellType",
    text_by = "cellType",
    text_size = 3) +
  ggplot2::guides(color = ggplot2::guide_legend(
    override.aes = list(size = 2))) +
  ggplot2::coord_fixed()
```

### 共变邻域分析

```{r}
createCNAObject <- function(x, samplem_key, samplem_vars, dimred = "PCA", ...) {
  samplem_vars <- c(samplem_vars, samplem_key)
  colDf <- as.data.frame(colData(x))
  
  samplem_df <- colDf |>
    dplyr::select(tidyselect::one_of(samplem_vars)) |>
    unique() |>
    tibble::remove_rownames()

  obs_df <- tibble::rownames_to_column(colDf, 'CellID')

  if (nrow(samplem_df) == nrow(obs_df)) {
    stop(
        'Sample-level metadata is same length as cell-level metadata.       
         Please check that samplem_vars are sample-level covariates.'
    )
  }

  nngraph <- Seurat::FindNeighbors(
    reducedDim(x, dimred)[, 1:10], compute.SNN = FALSE,
    return.neighbor = FALSE, ...)$nn

  rcna_object <- list(
    samplem = samplem_df,
    obs = obs_df, 
    connectivities = nngraph,
    samplem_key = samplem_key,
    obs_key = 'CellID',
    N = nrow(samplem_df)
  )

  rcna_object
}

sce_mock$time_val <- as.numeric(factor(
  sce_mock$time, levels = c("0DPI", "1DPI", "2DPI", "3DPI")))

cnaObj <- createCNAObject(
  sce_mock, 
  samplem_key = "sample_id",
  samplem_vars = c(
    "time", "time_val"
  )
)

cnaRes <- rcna::association(
  data = cnaObj,
  y = cnaObj$samplem$time_val,
  batches = NULL,
  return_nam = TRUE
)

sce_mock$time_ncorrs <- cnaRes$ncorrs[colnames(sce_mock), , drop=TRUE]
```

#### 表型关联结果 {.tabset}

```{r}
blue_to_orange <- rev(ggthemes::ggthemes_data[[
  c("tableau", "color-palettes", "ordered-diverging", "Orange-Blue Diverging")]][["value"]])
```

##### UMAP

```{r}
scater::plotReducedDim(sce_mock, dimred = "UMAP",
    point_size = 0.5,
    colour_by = "time_ncorrs",
    text_by = "cellType",
    text_size = 3,
    show_violin = TRUE) +
  ggplot2::scale_color_gradientn(colours = blue_to_orange) +
  ggplot2::coord_fixed()
```

```{r}
scater::plotReducedDim(sce_mock, dimred = "UMAP",
    point_size = 0.5,
    colour_by = "group_id",
    text_by = "cellType",
    text_size = 3,
    show_violin = TRUE) +
  ggplot2::guides(color = ggplot2::guide_legend(
    override.aes = list(size = 2))) +
  ggplot2::coord_fixed()
```

##### t-SNE

```{r}
scater::plotReducedDim(sce_mock, dimred = "TSNE",
    point_size = 0.5,
    colour_by = "time_ncorrs",
    text_by = "cellType",
    text_size = 3,
    show_violin = TRUE) +
  ggplot2::scale_color_gradientn(colours = blue_to_orange) +
  ggplot2::coord_fixed()
```

##### PHATE

```{r}
scater::plotReducedDim(sce_mock, dimred = "PHATE",
    point_size = 0.5,
    colour_by = "time_ncorrs",
    text_by = "cellType",
    text_size = 3,
    show_violin = TRUE) +
  ggplot2::scale_color_gradientn(colours = blue_to_orange) +
  ggplot2::coord_fixed()
```

##### DiffusionMap

```{r}
scater::plotReducedDim(sce_mock, dimred = "DiffusionMap",
    point_size = 0.5,
    colour_by = "time_ncorrs",
    text_by = "cellType",
    text_size = 3,
    show_violin = TRUE) +
  ggplot2::scale_color_gradientn(colours = blue_to_orange) +
  ggplot2::coord_fixed()
```

### 运行 UniTVelo

注意：下面这段代码是在 GPU 服务器上运行的。

```{r}
adata <- cache_pickle(
  file = "unitvelo_mock_config_1.pickle",
  dir = "../results/ObjectCache/TrajectoryInference/",
  expr = runUniTVelo(
    sce_mock,
    label_key = "cluster_id",
    use.dimred = "HARMONY",
    assay.X = "logcounts",
    GPU = 0L,
    config = list(
      R2_ADJUST = TRUE,
      IROOT = NULL,
      FIT_OPTION = "1",
      AGENES_R2 = 1L
    )
  )
)
```

```{r eval=FALSE}
adata <- cache_pickle(
  file = "unitvelo_mock_config_2.pickle",
  dir = "../results/ObjectCache/TrajectoryInference/",
  expr = runUniTVelo(
    sce_mock,
    label_key = "cluster_id",
    use.dimred = "HARMONY",
    assay.X = "logcounts",
    GPU = 0L,
    config = list(
      VGENES = "offset",
      R2_ADJUST = FALSE,
      IROOT = NULL,
      FIT_OPTION = "1"
    )
  )
)
```

`config_2` 推断出的模型，其 latent_time 与 time_ncorrs 的关联性只有 0.8 ，要比 `config_1` 差一点。

```{r eval=FALSE}
adata <- cache_pickle(
  file = "unitvelo_mock_config_3.pickle",
  dir = "../results/ObjectCache/TrajectoryInference/",
  expr = runUniTVelo(
    sce_mock,
    label_key = "cluster_id",
    use.dimred = "HARMONY",
    assay.X = "logcounts",
    GPU = 0L,
    config = list(
      R2_ADJUST = TRUE,
      IROOT = NULL,
      FIT_OPTION = "2",
      ASSIGN_POS_U = FALSE
    )
  )
)
```

`config_3` 是独立模式，其结果与 `config_1` 以及 `config_2` 完全相反，并且与 time_ncorrs 的 pearson 相关性是 `-0.34` 。

```{r}
adata$obsm$update(list(
  X_tsne = reducedDim(sce_mock, "TSNE"),
  X_umap = reducedDim(sce_mock, "UMAP"),
  X_phate = reducedDim(sce_mock, "PHATE"),
  X_dc = reducedDim(sce_mock, "DiffusionMap")
))

adata$obs$cellType <- droplevels(sce_mock$cluster_id)
```

#### 速率流线 {.tabset}

##### UMAP

```{python fig.height=7, fig.width=7}
scv.pl.velocity_embedding_stream(
  r.adata, basis="umap", color="cellType", dpi=100, title='', figsize=(7, 7))
```

##### t-SNE

```{python fig.height=7, fig.width=7}
scv.pl.velocity_embedding_stream(
  r.adata, basis="tsne", color="cellType", dpi=100, title='', figsize=(7, 7))
```

##### PHATE

```{python fig.height=7, fig.width=7}
scv.pl.velocity_embedding_stream(
  r.adata, basis="phate", color="cellType", dpi=100, title='', figsize=(7, 7))
```

##### DiffusionMap

```{python fig.height=7, fig.width=7}
scv.pl.velocity_embedding_stream(
  r.adata, basis="dc", color="cellType", dpi=100, title='', figsize=(7, 7))
```

#### 隐时间 {.tabset}

```{r}
scv$tl$latent_time(adata, min_likelihood=NULL)
sce_mock$latent_time <- adata$obs$latent_time
```


##### UMAP

```{r}
scater::plotReducedDim(sce_mock, dimred = "UMAP",
    point_size = 0.5,
    colour_by = "latent_time",
    text_by = "cellType",
    text_size = 3,
    show_violin = TRUE) +
  ggplot2::scale_color_gradientn(colours = blue_to_orange) +
  ggplot2::coord_fixed()
```

##### t-SNE

```{r}
scater::plotReducedDim(sce_mock, dimred = "TSNE",
    point_size = 0.5,
    colour_by = "latent_time",
    text_by = "cellType",
    text_size = 3,
    show_violin = TRUE) +
  ggplot2::scale_color_gradientn(colours = blue_to_orange) +
  ggplot2::coord_fixed()
```

##### PHATE

```{r}
scater::plotReducedDim(sce_mock, dimred = "PHATE",
    point_size = 0.5,
    colour_by = "latent_time",
    text_by = "cellType",
    text_size = 3,
    show_violin = TRUE) +
  ggplot2::scale_color_gradientn(colours = blue_to_orange) +
  ggplot2::coord_fixed()
```

##### DiffusionMap

```{r}
scater::plotReducedDim(sce_mock, dimred = "DiffusionMap",
    point_size = 0.5,
    colour_by = "latent_time",
    text_by = "cellType",
    text_size = 3,
    show_violin = TRUE) +
  ggplot2::scale_color_gradientn(colours = blue_to_orange) +
  ggplot2::coord_fixed()
```

#### 表型与隐时间的关联

```{r}
colData(sce_mock) |>
  as.data.frame() |>
  dplyr::sample_frac(1) |>
  ggpubr::ggscatter(
    x = "time_ncorrs", y = "latent_time", group = NULL,
    color = "time", conf.int = TRUE,
    cor.coef = TRUE, cor.method = "pearson") +
  ggplot2::geom_smooth(method = lm, color = "black", fill = 'lightblue') +
  NULL
```

样本数量太大了，导致置信区间的 level 要设置的非常高才有可能看见。

#### 基因动态类型分析

```{r}
is_velo_genes <- adata$var[["velocity_genes"]]
velo_genes <- adata$var_names[is_velo_genes]
peak_time <- adata$var[["fit_t0"]][is_velo_genes]

hist(peak_time, prob = TRUE, breaks = 40)
lines(density(peak_time))
```

```{r}
repression <- velo_genes[peak_time < 0.05]
induction <- velo_genes[peak_time > 0.95]
transient <- velo_genes[peak_time > 0.05 & peak_time < 0.95]
```

```{python}
scv.pl.heatmap(
    r.adata, var_names=r.repression, sortby='latent_time', yticklabels=False,
    col_color='cellType', n_convolve=100)
```

```{python}
scv.pl.heatmap(
    r.adata, var_names=r.induction, sortby='latent_time', yticklabels=False,
    col_color='cellType', n_convolve=100)
```

```{python}
scv.pl.heatmap(
    r.adata, var_names=r.transient, sortby='latent_time', yticklabels=False,
    col_color='cellType', n_convolve=100)
```

### 细胞种群连接性

#### PAGA 连接图 {.tabset}

```{r}
sc <- reticulate::import("scanpy")
sc$tl$paga(adata, groups='cellType')
```

##### UMAP

```{r fig.height=7, fig.width=7}
plotPagaGraph(adata, basis="umap", threshold = 0.7, edge_cex = 2, node_cex = 3) +
  ggplot2::coord_fixed()
```

##### t-SNE

```{r fig.height=7, fig.width=7}
plotPagaGraph(adata, basis="tsne", threshold = 0.7, edge_cex = 2) +
  ggplot2::coord_fixed()
```

##### PHATE

```{r fig.height=7, fig.width=7}
plotPagaGraph(adata, basis="phate", threshold = 0.7, edge_cex = 2) +
  ggplot2::coord_fixed()
```

##### DiffusionMap

```{r fig.height=7, fig.width=7}
plotPagaGraph(adata, basis="dc", threshold = 0.7, edge_cex = 2) +
  ggplot2::coord_fixed()
```

#### PAGA 有向图 {.tabset}

```{python}
r.adata.uns['neighbors']['distances'] = r.adata.obsp['distances']
r.adata.uns['neighbors']['connectivities'] = r.adata.obsp['connectivities']

scv.tl.paga(r.adata, groups='cellType')
```

##### UMAP

```{r fig.width=7, fig.height=7}
plotPagaArrow(adata, basis = "umap", threshold = 0, edge_cex = 4, node_cex = 6) +
  ggplot2::coord_fixed()
```

##### t-SNE

```{r fig.width=7, fig.height=7}
plotPagaArrow(adata, basis = "tsne", threshold = 0, edge_cex = 4, node_cex = 6) +
  ggplot2::coord_fixed()
```

##### PHATE

```{r fig.width=7, fig.height=7}
plotPagaArrow(adata, basis = "phate", threshold = 0, edge_cex = 4, node_cex = 6, arrow_gap = 0.002) +
  ggplot2::coord_fixed()
```

#### DiffusionMap

```{r fig.width=7, fig.height=7}
plotPagaArrow(adata, basis = "dc", threshold = 0, edge_cex = 4, node_cex = 6, arrow_gap = 0.002) +
  ggplot2::coord_fixed()
```

