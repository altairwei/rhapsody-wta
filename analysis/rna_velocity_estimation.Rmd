---
title: "RNA Velocity Estimation"
author: "Altair Wei"
date: '2022-08-11'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(SingleCellExperiment)
source("../scripts/TrajectoryUtilities.R")
plt <- reticulate::import("matplotlib.pyplot")
scv <- reticulate::import("scvelo")
```

```{python}
import scvelo as scv
import matplotlib.pyplot as plt
```

## 1 数据处理

### 合并 velocyto 数据集

```{r}
samples <- c(
  "0DPI-MOCK-1",
  "0DPI-MOCK-2",

  "1DPI-MOCK-1",
  "1DPI-MOCK-2",
  "1DPI-PNR2-1",
  "1DPI-PNR2-2",
  "1DPI-TR4-1",
  "1DPI-TR4-2",

  "2DPI-MOCK-1",
  "2DPI-MOCK-2",
  "2DPI-PNR2-1",
  "2DPI-PNR2-2",
  "2DPI-TR4-1",
  "2DPI-TR4-2",

  "3DPI-MOCK-1",
  "3DPI-MOCK-2",
  "3DPI-PNR2-1",
  "3DPI-PNR2-3",
  "3DPI-TR4-1",
  "3DPI-TR4-2"
)

data_folders <- structure(
  paste0("../results/RawOutput/", samples), names = samples)

data_list <- xfun::cache_rds(
  file = "velocity_data_list.rds",
  dir = "../results/ObjectCache/TrajectoryInference/",
  expr = lapply(data_folders, function(base_dir) {
    loom_file = paste0(base_dir, "/Velocyto/", basename(base_dir), ".loom")
    SeuratWrappers::ReadVelocity(loom_file)
   })
)
```

```{r}
fixCellNames <- function(mtx_list) {
  lapply(mtx_list, function(mtx) {
    colnames(mtx) <- colnames(mtx) |>
      stringr::str_sub(end = -2L) |>
      stringr::str_replace(stringr::fixed(":"), "_")
    mtx
  })
}

spliced <- xfun::cache_rds(
  file = "velocity_mtx_spliced.rds",
  dir = "../results/ObjectCache/TrajectoryInference/",
  expr = do.call(cbind, fixCellNames(lapply(data_list, "[[", "spliced")))
)

unspliced <- xfun::cache_rds(
  file = "velocity_mtx_unspliced.rds",
  dir = "../results/ObjectCache/TrajectoryInference/",
  expr = do.call(cbind, fixCellNames(lapply(data_list, "[[", "unspliced")))
)

ambiguous <- xfun::cache_rds(
  file = "velocity_mtx_ambiguous.rds",
  dir = "../results/ObjectCache/TrajectoryInference/",
  expr = do.call(cbind, fixCellNames(lapply(data_list, "[[", "ambiguous")))
)
```

```{r}
obj <- readRDS(Sys.glob(
  "../results/ObjectCache/IntegrationAndAnnotation/obj_annotated_*.rds"))
```

### 添加到 SingleCellExperiment 对象

```{r}
sce <- xfun::cache_rds(
  file = "sce_spliced.rds",
  dir = "../results/ObjectCache/TrajectoryInference/",
  expr = local({
    obj$cellType <- Seurat::Idents(obj)
    sce <- Seurat::as.SingleCellExperiment(obj, assay = "RNA")
    sce <- muscat::prepSCE(sce,
      kid = "ident", # subpopulation assignments
      gid = "group", # group IDs (ctrl/stim)
      sid = "sample", # sample IDs (ctrl/stim.1234)
      drop = FALSE
    )

    cell_names <- colnames(sce)
    gene_names <- rownames(sce)
    assay(sce, "spliced") <- spliced[gene_names, cell_names]
    assay(sce, "unspliced") <- unspliced[gene_names, cell_names]

    sce
  })
)
```

```{r}
rm(obj, data_list, spliced, unspliced, ambiguous)
gc()
```

## 2 1DPI 样品分析

### 读取数据

```{r}
sce_sub <- sce[, sce$time == "1DPI"]
```

```{r run-scvelo}
adata <- runScVelo(
  sce_sub,
  mode = "dynamical",
  use.dimred = "HARMONY",
  assay.X = "logcounts",
  scvelo.params = list(
    filter_and_normalize = list(
      min_shared_counts = 20L, n_top_genes = 2000L),
    moments = list(n_pcs = 30L, n_neighbors = 30L)
  )
)
```

```{r update-embeddings}
adata$obsm$update(list(
  X_tsne = reducedDim(sce_sub, "TSNE"),
  X_umap = reducedDim(sce_sub, "UMAP")
))

adata$obs$cellType <- sce_sub$cluster_id
```

> Here, the proportions of spliced/unspliced counts are displayed. Depending on the protocol used (Drop-Seq, Smart-Seq), we typically have between 10%-25% of unspliced molecules containing intronic sequences. We also advice you to examine the variations on cluster level to verify consistency in splicing efficiency. 

```{python plot-prop, fig.height=4, fig.width=8}
scv.pl.proportions(r.adata, groupby="cellType", figsize = (8, 4))
```

### 速率估计

是否需要设置 `use_rep="X_harmony"` 呢？我感觉应该需要，否则 scVelo 会基于 PCA 来计算 neighbors

> Further, we need the first and second order moments (means and uncentered variances) computed among nearest neighbors in PCA space, summarized in `scv.pp.moments`, which internally computes `scv.pp.pca` and `scv.pp.neighbors`. First order is needed for deterministic velocity estimation, while stochastic estimation also requires second order moments.

```{r eval=FALSE}
scv$pp$moments(adata, n_pcs=30, n_neighbors=30, use_rep="X_harmony")
```

RNA 速度是基因表达空间中的矢量，代表单个细胞的运动方向和速度。正的 RNA 速度表示一个基因是上调的，在一些细胞中该基因的未成熟 mRNA 的丰度高于稳定状态下的预期值。反之，负的速度表示一个基因是下调的。

> Velocities are vectors in gene expression space and represent the direction and speed of movement of the individual cells. The velocities are obtained by modeling transcriptional dynamics of splicing kinetics, either stochastically (default) or deterministically (by setting `mode='deterministic'`). For each gene, a steady-state-ratio of pre-mature (unspliced) and mature (spliced) mRNA counts is fitted, which constitutes a constant transcriptional state. Velocities are then obtained as residuals from this ratio. Positive velocity indicates that a gene is up-regulated, which occurs for cells that show higher abundance of unspliced mRNA for that gene than expected in steady state. Conversely, negative velocity indicates that a gene is down-regulated.

```{r eval=FALSE}
scv$tl$recover_dynamics(adata)
scv$tl$velocity(adata, mode='dynamical')
```

> The combination of velocities across genes can then be used to estimate the future state of an individual cell. In order to project the velocities into a lower-dimensional embedding, transition probabilities of cell-to-cell transitions are estimated. That is, for each velocity vector we find the likely cell transitions that are accordance with that direction. The transition probabilities are computed using cosine correlation between the potential cell-to-cell transitions and the velocity vector, and are stored in a matrix denoted as velocity graph.

```{r eval=FALSE}
scv$tl$velocity_graph(adata)
```

### 速率流线 {.tabset}

#### t-SNE

```{python plot-stream-tsne, fig.height=7, fig.width=7}
scv.pl.velocity_embedding_stream(
  r.adata, basis="tsne", color="cellType", figsize= (7, 7))
```

#### UMAP

```{python plot-stream-umap, fig.height=7, fig.width=7}
scv.pl.velocity_embedding_stream(
  r.adata, basis="umap", color="cellType", figsize = (7, 7))
```

### 速率网格 {.tabset}

#### t-SNE

```{python plot-grid-tsne, fig.height=7, fig.width=7}
scv.pl.velocity_embedding_grid(
  r.adata, basis="tsne", color="cellType",
  arrow_length=3, arrow_size=1, figsize=(7, 7))
```

#### UMAP

```{python plot-grid-umap, fig.height=7, fig.width=7}
scv.pl.velocity_embedding_grid(
  r.adata, basis="umap", color="cellType",
  arrow_length=3, arrow_size=1, figsize=(7, 7))
```

### 速率细胞 {.tabset}

#### t-SNE

```{python plot-velo-tsne, fig.height=12, fig.width=12}
scv.pl.velocity_embedding(
  r.adata, basis="tsne", color="cellType", figsize=(12, 12),
  arrow_length=6, arrow_size=3, scale=2, dpi=300)
```

#### UMAP

```{python plot-velo-umap, fig.height=12, fig.width=12}
scv.pl.velocity_embedding(
  r.adata, basis="umap", color="cellType", figsize=(12, 12),
  arrow_length=6, arrow_size=3, scale=2, dpi=300)
```

### 隐时间 {.tabset}

> scVelo’s latent time is based only on its transcriptional dynamics and represents
the cell’s internal clock. It captures aspects of the actual time better than similarity-based diffusion pseudo-time.

#### t-SNE

```{python plot-latent-time-tsne, fig.height=7, fig.width=7}
scv.pl.scatter(r.adata, basis="tsne",
  color='latent_time', color_map='gnuplot',
  size=20, figsize=(7, 7))
```

#### UMAP

```{python plot-latent-time-umap, fig.height=7, fig.width=7}
scv.pl.scatter(r.adata, basis="umap",
  color='latent_time', color_map='gnuplot',
  size=20, figsize=(7, 7))
```

### 速度与连贯性 {.tabset}

#### t-SNE

```{python plot-confidence-tsne, fig.height=7, fig.width=14}
scv.tl.velocity_confidence(r.adata)
keys = 'velocity_length', 'velocity_confidence'
scv.pl.scatter(r.adata, c=keys, cmap='coolwarm', basis="tsne", perc=[5, 95], figsize=(7, 14))
```

#### UMAP

```{python plot-confidence-umap, fig.height=7, fig.width=14}
scv.tl.velocity_confidence(r.adata)
keys = 'velocity_length', 'velocity_confidence'
scv.pl.scatter(r.adata, c=keys, cmap='coolwarm', basis="umap", perc=[5, 95], figsize=(7, 14))
```

### 速率图 {.tabset}

#### t-SNE

```{python plot-velo-graph-tsne, fig.height=7, fig.width=7}
scv.pl.velocity_graph(r.adata, threshold=0.8, basis="tsne", color="cellType", figsize=(7, 7))
```

#### UMAP

```{python plot-velo-graph-umap, fig.height=7, fig.width=7}
scv.pl.velocity_graph(r.adata, threshold=.8, basis="umap", color="cellType", figsize=(7, 7))
```

### PAGA 图 {.tabset}

```{python run-paga}
r.adata.uns['neighbors']['distances'] = r.adata.obsp['distances']
r.adata.uns['neighbors']['connectivities'] = r.adata.obsp['connectivities']

scv.tl.paga(r.adata, groups='cellType')
df = scv.get_df(r.adata, 'paga/transitions_confidence', precision=2).T
```

```{r}
reticulate::py$df
```

#### t-SNE

```{python plot-paga-tsne, fig.width=7, fig.height=7}
scv.pl.paga(r.adata, basis='tsne', size=50, alpha=.1, legend_loc='on data',
            min_edge_width=2, node_size_scale=1.5, figsize=(7, 7))
```

#### UMAP

```{python plot-paga-umap, fig.width=7, fig.height=7}
scv.pl.paga(r.adata, basis='umap', size=50, alpha=.1, legend_loc='on data',
            min_edge_width=2, node_size_scale=1.5, figsize=(7, 7))
```

## 3 2DPI 样本分析

```{r}
sce_sub <- sce[, sce$time == "2DPI"]
```

```{r}
<<run-scvelo>>
```

```{r}
<<update-embeddings>>
```

```{python fig.height=4, fig.width=8}
<<plot-prop>>
```

### 速率流线 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=7}
<<plot-stream-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=7}
<<plot-stream-umap>>
```

### 速率网格 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=7}
<<plot-grid-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=7}
<<plot-grid-umap>>
```

### 速率细胞 {.tabset}

#### t-SNE

```{python fig.height=12, fig.width=12}
<<plot-velo-tsne>>
```

#### UMAP

```{python fig.height=12, fig.width=12}
<<plot-velo-umap>>
```

### 隐时间 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=7}
<<plot-latent-time-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=7}
<<plot-latent-time-umap>>
```

### 速度与连贯性 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=14}
<<plot-confidence-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=14}
<<plot-confidence-umap>>
```

### 速率图 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=7}
<<plot-velo-graph-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=7}
<<plot-velo-graph-umap>>
```

### PAGA 图 {.tabset}

```{python}
<<run-paga>>
```

#### t-SNE

```{python fig.width=7, fig.height=7}
<<plot-paga-tsne>>
```

#### UMAP

```{python fig.width=7, fig.height=7}
<<plot-paga-umap>>
```

## 4 3DPI 样本分析

```{r}
sce_sub <- sce[, sce$time == "3DPI"]
```

```{r}
<<run-scvelo>>
```

```{r}
<<update-embeddings>>
```

```{python fig.height=4, fig.width=8}
<<plot-prop>>
```

### 速率流线 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=7}
<<plot-stream-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=7}
<<plot-stream-umap>>
```

### 速率网格 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=7}
<<plot-grid-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=7}
<<plot-grid-umap>>
```

### 速率细胞 {.tabset}

#### t-SNE

```{python fig.height=12, fig.width=12}
<<plot-velo-tsne>>
```

#### UMAP

```{python fig.height=12, fig.width=12}
<<plot-velo-umap>>
```

### 隐时间 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=7}
<<plot-latent-time-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=7}
<<plot-latent-time-umap>>
```

### 速度与连贯性 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=14}
<<plot-confidence-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=14}
<<plot-confidence-umap>>
```

### 速率图 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=7}
<<plot-velo-graph-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=7}
<<plot-velo-graph-umap>>
```

### PAGA 图 {.tabset}

```{python}
<<run-paga>>
```

#### t-SNE

```{python fig.width=7, fig.height=7}
<<plot-paga-tsne>>
```

#### UMAP

```{python fig.width=7, fig.height=7}
<<plot-paga-umap>>
```


## 5 MOCK 样本分析

```{r}
sce_sub <- sce[, sce$treatment == "MOCK"]
```

```{r}
<<run-scvelo>>
```

```{r}
<<update-embeddings>>
```

```{python fig.height=4, fig.width=8}
<<plot-prop>>
```

### 速率流线 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=7}
<<plot-stream-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=7}
<<plot-stream-umap>>
```

### 速率网格 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=7}
<<plot-grid-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=7}
<<plot-grid-umap>>
```

### 速率细胞 {.tabset}

#### t-SNE

```{python fig.height=12, fig.width=12}
<<plot-velo-tsne>>
```

#### UMAP

```{python fig.height=12, fig.width=12}
<<plot-velo-umap>>
```

### 隐时间 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=7}
<<plot-latent-time-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=7}
<<plot-latent-time-umap>>
```

### 速度与连贯性 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=14}
<<plot-confidence-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=14}
<<plot-confidence-umap>>
```

### 速率图 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=7}
<<plot-velo-graph-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=7}
<<plot-velo-graph-umap>>
```

### PAGA 图 {.tabset}

```{python}
<<run-paga>>
```

#### t-SNE

```{python fig.width=7, fig.height=7}
<<plot-paga-tsne>>
```

#### UMAP

```{python fig.width=7, fig.height=7}
<<plot-paga-umap>>
```


## 6 PNR2 样本分析

```{r}
sce_sub <- sce[, sce$treatment == "PNR2"]
```

```{r}
<<run-scvelo>>
```

```{r}
<<update-embeddings>>
```

```{python fig.height=4, fig.width=8}
<<plot-prop>>
```

### 速率流线 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=7}
<<plot-stream-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=7}
<<plot-stream-umap>>
```

### 速率网格 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=7}
<<plot-grid-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=7}
<<plot-grid-umap>>
```

### 速率细胞 {.tabset}

#### t-SNE

```{python fig.height=12, fig.width=12}
<<plot-velo-tsne>>
```

#### UMAP

```{python fig.height=12, fig.width=12}
<<plot-velo-umap>>
```

### 隐时间 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=7}
<<plot-latent-time-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=7}
<<plot-latent-time-umap>>
```

### 速度与连贯性 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=14}
<<plot-confidence-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=14}
<<plot-confidence-umap>>
```

### 速率图 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=7}
<<plot-velo-graph-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=7}
<<plot-velo-graph-umap>>
```

### PAGA 图 {.tabset}

```{python}
<<run-paga>>
```

#### t-SNE

```{python fig.width=7, fig.height=7}
<<plot-paga-tsne>>
```

#### UMAP

```{python fig.width=7, fig.height=7}
<<plot-paga-umap>>
```


## 7 TR4 样本分析

```{r}
sce_sub <- sce[, sce$treatment == "TR4"]
```

```{r}
<<run-scvelo>>
```

```{r}
<<update-embeddings>>
```

```{python fig.height=4, fig.width=8}
<<plot-prop>>
```

### 速率流线 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=7}
<<plot-stream-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=7}
<<plot-stream-umap>>
```

### 速率网格 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=7}
<<plot-grid-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=7}
<<plot-grid-umap>>
```

### 速率细胞 {.tabset}

#### t-SNE

```{python fig.height=12, fig.width=12}
<<plot-velo-tsne>>
```

#### UMAP

```{python fig.height=12, fig.width=12}
<<plot-velo-umap>>
```

### 隐时间 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=7}
<<plot-latent-time-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=7}
<<plot-latent-time-umap>>
```

### 速度与连贯性 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=14}
<<plot-confidence-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=14}
<<plot-confidence-umap>>
```

### 速率图 {.tabset}

#### t-SNE

```{python fig.height=7, fig.width=7}
<<plot-velo-graph-tsne>>
```

#### UMAP

```{python fig.height=7, fig.width=7}
<<plot-velo-graph-umap>>
```

### PAGA 图 {.tabset}

```{python}
<<run-paga>>
```

#### t-SNE

```{python fig.width=7, fig.height=7}
<<plot-paga-tsne>>
```

#### UMAP

```{python fig.width=7, fig.height=7}
<<plot-paga-umap>>
```

