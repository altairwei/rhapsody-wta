---
title: "Integration of Mock Samples by Harmony"
author: "Altair Wei"
date: "2022/6/24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(magrittr)
source("../scripts/UtilityFunctions.R")
source("../scripts/EnrichmentUtilities.R")

library(reactable)
# setup reactable HTML dependencies
reactable::reactable(iris)
```

# MOCK 样本的整合与注释

## 1 加载数据

```{r}
samples <- c(
  "0DPI-MOCK-1",
  "0DPI-MOCK-2",

  "1DPI-MOCK-1",
  "1DPI-MOCK-2",
  "1DPI-PNR2-1",
  "1DPI-PNR2-2",
  "1DPI-TR4-1",
  "1DPI-TR4-2",

  "2DPI-MOCK-1",
  "2DPI-MOCK-2",
  "2DPI-PNR2-1",
  "2DPI-PNR2-2",
  "2DPI-TR4-1",
  "2DPI-TR4-2",

  "3DPI-MOCK-1",
  "3DPI-MOCK-2",
  "3DPI-PNR2-1",
  "3DPI-PNR2-2",
  "3DPI-PNR2-3",
  "3DPI-TR4-1",
  "3DPI-TR4-2"
)

names(samples) <- samples
```


```{r}
obj_list <- lapply(samples, function(sample) readRDS(
  Sys.glob(paste0(
    "../results/ObjectCache/QualityControl/",
    "obj_strained_", sample, "_*.rds"))
  )
)

obj_mock <- obj_list[stringr::str_which(samples, "MOCK")]
```

## 2 数据整合

我们选择 Seurat RPCA 方法来整合样本，因为 0~3DPI 的 MOCK 反应着胚芽鞘的生长发育，样本细胞之间不需要太 “对齐” 。参数 `k.anchor=5` 也选择默认值。

```{r message=FALSE, warning=FALSE}
obj_mock_combined <- merge(
  x = obj_mock[[1]],
  y = obj_mock[-1],
  add.cell.ids = names(obj_mock)
)

obj_mock_combined <- obj_mock_combined %>%
  Seurat::NormalizeData(verbose = FALSE) %>%
  Seurat::FindVariableFeatures(selection.method = "vst", nfeatures = 2000) %>% 
  Seurat::ScaleData(verbose = FALSE) %>% 
  Seurat::RunPCA(features = NULL, npcs = 20, verbose = FALSE)
```

```{r fig.height=5, fig.width=12}
p1 <- Seurat::DimPlot(object = obj_mock_combined, reduction = "pca", pt.size = .1, group.by = "sample")
p2 <- Seurat::VlnPlot(object = obj_mock_combined, features = "PC_1", group.by = "sample", pt.size = .1)
p1 + p2
```

### 运行 Harmony

```{r fig.height=2.5, fig.width=6}
obj_mock_combined <- obj_mock_combined %>% 
    harmony::RunHarmony(
      group.by.vars = c("time", "sample"),
      theta = c(4, 2),
      kmeans_init_nstart=20, kmeans_init_iter_max=100,
      epsilon.cluster=-Inf, epsilon.harmony=-Inf,
      plot_convergence = TRUE)
```

```{r fig.height=5, fig.width=12}
p1 <- Seurat::DimPlot(object = obj_mock_combined, reduction = "harmony", pt.size = .1, group.by = "sample")
p2 <- Seurat::VlnPlot(object = obj_mock_combined, features = "harmony_1", group.by = "sample", pt.size = .1)
p1 + p2
```

## 3 降维聚类

```{r}
obj_mock_combined <- obj_mock_combined %>%
    Seurat::RunUMAP(reduction = "harmony", dims = 1:20, verbose = FALSE) %>%
    Seurat::RunTSNE(reduction = "harmony", dims = 1:20, verbose = FALSE) %>%
    Seurat::FindNeighbors(reduction = "harmony", dims = 1:20, verbose = FALSE) %>%
    Seurat::FindClusters(resolution = 0.6, verbose = FALSE, random.seed = 8964)
```

### 调整分辨率

```{r}
library(clustree)

obj_mock_combined <- xfun::cache_rds(
  file = "obj_mock_harmony_clustree.rds",
  rerun = FALSE,
  dir = "../results/ObjectCache/IntegrationAndAnnotation/",
  expr = local({
    obj_mock_combined <- Seurat::FindClusters(
      obj_mock_combined, resolution = seq(0, 1.6, 0.2), verbose = FALSE)
    obj_mock_combined <- choose_indent_res(obj_mock_combined, "RNA_snn_res.0.6")
    obj_mock_combined
  })
)
```

```{r fig.height=14, fig.width=10}
clustree::clustree(obj_mock_combined, prefix = "RNA_snn_res.")
```

### 将聚类树覆盖到降维空间中 {.tabset}

#### t-SNE

```{r fig.height=10, fig.width=14}
clustree::clustree_overlay(
  obj_mock_combined,
  prefix = "RNA_snn_res.",
  assay = "RNA",
  red_dim = "tsne",
  x_value = "tsne1",
  y_value = "tsne2",
  use_colour = "points"
) + ggplot2::coord_fixed()
```

#### UMAP

```{r fig.height=10, fig.width=14}
clustree::clustree_overlay(
  obj_mock_combined,
  prefix = "RNA_snn_res.",
  assay = "RNA",
  red_dim = "umap",
  x_value = "umap1",
  y_value = "umap2",
  use_colour = "points"
) + ggplot2::coord_fixed()
```


### 降维图 {.tabset}

```{r}
ident_cols <- Seurat::DiscretePalette(length(levels(Seurat::Idents(obj_mock_combined))), palette = NULL)
```

#### UMAP

```{r fig.height=8, fig.width=16}
p1 <- Seurat::DimPlot(
        obj_mock_combined, reduction = "umap", cols = ident_cols,
        label = TRUE, label.box = TRUE, label.color = "black", label.size = 2) +
  ggplot2::scale_fill_manual(values = rep("white", length(ident_cols))) +
  ggplot2::coord_fixed()
p2 <- Seurat::DimPlot(obj_mock_combined, reduction = "umap", group.by = "sample", pt.size = .001) +
  #ggthemes::scale_color_tableau("Tableau 20") +
  ggplot2::coord_fixed()
p1 + p2
```

```{r fig.height=5, fig.width=18}
Seurat::DimPlot(
    obj_mock_combined, reduction = "umap",
    group.by = "sample", split.by = "time",
    pt.size = .1) +
  ggthemes::scale_color_tableau("Tableau 20") +
  ggplot2::coord_fixed()
```

#### t-SNE

```{r fig.height=8, fig.width=16}
p1 <- Seurat::DimPlot(
        obj_mock_combined, reduction = "tsne", cols = ident_cols,
        label = TRUE, label.box = TRUE, label.color = "black", label.size = 2) +
  ggplot2::scale_fill_manual(values = rep("white", length(ident_cols))) +
  ggplot2::coord_fixed()
p2 <- Seurat::DimPlot(obj_mock_combined, reduction = "tsne", group.by = "sample", pt.size = .001) +
  #ggthemes::scale_color_tableau("Tableau 20") +
  ggplot2::coord_fixed()
p1 + p2
```


```{r fig.height=5, fig.width=18}
Seurat::DimPlot(
    obj_mock_combined, reduction = "tsne",
    group.by = "sample", split.by = "time",
    pt.size = .1) +
  ggthemes::scale_color_tableau("Tableau 20") +
  ggplot2::coord_fixed()
```

## 4 标志基因矩阵

```{r fig.width=15, fig.height=7}
Seurat::DefaultAssay(obj_mock_combined) <- "RNA"
plot_markers(obj_mock_combined, cluster.idents = TRUE)
```


## 5 细胞种群的标志基因

```{r}
marker_cosg <- COSG::cosg(
 obj_mock_combined,
 groups = 'all',
 assay = 'RNA',
 slot = 'data',
 mu = 1,
 n_genes_user = 300
)
```

```{r eval=FALSE}
markers_df <- Seurat::FindAllMarkers(
    obj_mock_combined, only.pos = TRUE, min.pct = 0.25,
    logfc.threshold = 0.25, verbose = FALSE)
```

## 6 激光显微切割反卷积

```{r}
LCM_design <- c(
  "VC_1" = "vascular",
  "VC_2" = "vascular",
  "VC_3" = "vascular",
  "CC_1" = "cortex",
  "CC_2" = "cortex",
  "CC_3" = "cortex",
  "MC_1" = "mesophyll",
  "MC_2" = "mesophyll",
  "MC_3" = "mesophyll",
  "EC_1" = "epidermis",
  "EC_2" = "epidermis",
  "EC_3" = "epidermis",
  "MC3_1" = "collenchyma",
  "MC3_2" = "collenchyma",
  "MC3_3" = "collenchyma"
)

CIBER <- deconvLCM(
  seurat = obj_mock_combined,
  lcm_file = "../results/LCMSeq/gene_quanti/counts/all.featureCounts",
  markers = unique(unlist(marker_cosg$names)),
  design = LCM_design,
  mc.cores = 4
  )
```

```{r fig.height=6, fig.width=8, dev='svglite'}
deconvScatter(CIBER, LCM_design)
```

```{r fig.height=5, fig.width=4}
deconvHeatmap(CIBER)
```

## 7 细胞类型注释

### 注释

```{r}
obj_mock_annotated <- xfun::cache_rds(
  file = "obj_mock_annotated.rds",
  dir = "../results/ObjectCache/IntegrationAndAnnotation/",
  rerun = FALSE,
  expr = local({
    Seurat::DefaultAssay(obj_mock_combined) <- "RNA"
    obj_mock_combined <- Seurat::RenameIdents(
      obj_mock_combined,

      # Vascular Cells
      `10` = "CC",    # Companion Cells
      `7`  = "BS",    # Bundle Sheath
      `6`  = "MPV",   # Midvein Provascular Cells
      `5`  = "Va_1",
      `12` = "Va_2",  # Sieve
      `9`  = "Va_3",
      `2`  = "Va_4",

      # Mesophyll Cells
      `3`  = "Me_1",
      `4`  = "Me_2",
      `0`  = "Me_3",
      `1`  = "Me_4",
      `8`  = "Me_5",

      # Epidermal Cells
      `11` = "Ep_1",
      `13` = "Ep_2",

      # Guardian Cells
      `14` = "Gu"
    )

    obj_mock_combined
  })
)
```

### 标志基因

```{r fig.width=15, fig.height=7}
Seurat::DefaultAssay(obj_mock_annotated) <- "RNA"
plot_markers(obj_mock_annotated, cluster.idents = TRUE)
```

### 降维图 {.tabset}

#### UMAP

```{r fig.height=8, fig.width=16}
p1 <- Seurat::DimPlot(
        obj_mock_annotated, reduction = "umap", cols = ident_cols,
        label = TRUE, label.box = TRUE, label.color = "black", label.size = 2) +
  ggplot2::scale_fill_manual(values = rep("white", length(ident_cols))) +
  ggplot2::coord_fixed()
p2 <- Seurat::DimPlot(obj_mock_annotated, reduction = "umap", group.by = "sample") +
  #ggthemes::scale_color_tableau("Tableau 20") +
  ggplot2::coord_fixed()
p1 + p2
```

#### t-SNE

```{r fig.height=8, fig.width=16}
p1 <- Seurat::DimPlot(
        obj_mock_annotated, reduction = "tsne", cols = ident_cols,
        label = TRUE, label.box = TRUE, label.color = "black", label.size = 2) +
  ggplot2::scale_fill_manual(values = rep("white", length(ident_cols))) +
  ggplot2::coord_fixed()
p2 <- Seurat::DimPlot(obj_mock_annotated, reduction = "tsne", group.by = "sample") +
  #ggthemes::scale_color_tableau("Tableau 20") +
  ggplot2::coord_fixed()
p1 + p2
```

## 8 细胞 3D 降维图 {.tabset}

二维嵌入和三维嵌入会产生不一样的结果，下面这个交互式的 3D 散点图就只在需要的时候执行了。我们主要使用其他 R 包截取 3D 散点图的几个侧面，用来刻画某几个视角就够了。

```{r message=FALSE, eval=TRUE}
obj_mock_annotated <- Seurat::RunTSNE(
  obj_mock_annotated, dims = 1:20, dim.embed = 3, check_duplicates = FALSE, verbose = FALSE)
obj_mock_annotated <- Seurat::RunUMAP(obj_mock_annotated, dims = 1:20, n.components = 3, verbose = FALSE)

gg_color_hue <- function(n) {
  hues <- seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

Dim3DPlot <- function(obj_annotated, dim_prefix, cols) {
  d1 <- paste0(dim_prefix, "1")
  d2 <- paste0(dim_prefix, "2")
  d3 <- paste0(dim_prefix, "3")

  df_to_plot <- Seurat::FetchData(obj_annotated, vars = c(d1, d2, d3, "ident"))
  
  plotly::plot_ly(
    df_to_plot,
    x = df_to_plot[[d1]], y = df_to_plot[[d2]], z = df_to_plot[[d3]],
    color = ~ ident,
    colors = cols,
    type = "scatter3d",
    mode = "markers",
    marker = list(size = 4)
  )
}
```

### UMAP

```{r}
Dim3DPlot(obj_mock_annotated, "UMAP_", cols = ident_cols)
```

### t-SNE

```{r}
Dim3DPlot(obj_mock_annotated, "tSNE_", cols = ident_cols)
```


## 8 细胞类型比例

```{r}
rhapsodykit::barplot_cluster_abundance(obj_mock_annotated) +
  ggplot2::scale_fill_discrete(type = ident_cols)
```

```{r fig.height=7, fig.width=14}
rhapsodykit::barplot_cluster_abundance(obj_mock_annotated, position = "dodge") +
  ggplot2::theme(
    strip.text.x = ggplot2::element_text(size = 16)
  )
```

## 9 特征基因的功能法分析

```{r message=FALSE, warning=FALSE, results="hide"}
library(org.Taestivum.iwgsc.db)
orgdb <- org.Taestivum.iwgsc.db
background <- rownames(Seurat::GetAssayData(obj_mock_annotated, assay = "RNA", slot = "count"))
```

```{r}
markerlist <- COSG::cosg(
 obj_mock_annotated,
 groups = 'all',
 assay = 'RNA',
 slot = 'data',
 mu = 1,
 n_genes_user = 300
)

markerlist <- markerlist$names
```

### 维管束

```{r}
vascular_clusters <- c(paste0("Va_", 1:4), "MPV", "BS", "CC")
```

#### 富集分析

```{r}
enr <- performMarkerCompareORA(
  markerlist,
  vascular_clusters,
  background
)
```

```{r fig.height=14, fig.width=12, message=FALSE, warning=FALSE}
p <- enr %>%
  enrichplot::pairwise_termsim() %>%
  enrichplot::treeplot(
    showCategory = 40, nCluster = 12,
    size = "count",
    offset = 70, offset_tiplab = 30,
    label_format_cladelab = 5,
    geneClusterPanel = "dotplot", nWords = 0) +
  ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = 0, add = 2)) +
  ggplot2::coord_cartesian()
p
```

#### 标志基因表格 {.tabset}

```{r results='asis'}
print_enrich_table(enr, "#####")
```


### 叶肉细胞

```{r}
mesophyll_clusters <- paste0("Me_", 1:5)
```

#### 富集分析

```{r}
enr <- performMarkerCompareORA(
  markerlist,
  mesophyll_clusters,
  background
)
```

```{r fig.height=14, fig.width=12, message=FALSE, warning=FALSE}
p <- enr %>%
  enrichplot::pairwise_termsim() %>%
  enrichplot::treeplot(
    showCategory = 40, nCluster = 12,
    size = "count",
    offset = 40, offset_tiplab = 20,
    label_format_cladelab = 5,
    geneClusterPanel = "dotplot", cex_category = 6, nWords = 0) +
  ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = 0, add = 2)) +
  ggplot2::coord_cartesian()
p
```

#### 标志基因表格 {.tabset}

```{r results='asis'}
print_enrich_table(enr, "#####")
```

### 其他细胞

```{r}
other_clusters <- c("Ep_1", "Ep_2", "Gu")
```

#### 富集分析

```{r}
enr <- performMarkerCompareORA(
  markerlist,
  other_clusters,
  background
)
```

```{r fig.height=9, fig.width=12, message=FALSE, warning=FALSE}
p <- enr %>%
  enrichplot::pairwise_termsim() %>%
  enrichplot::treeplot(
    showCategory = 40, nCluster = 12,
    size = "count",
    offset = 40, offset_tiplab = 15,
    label_format_cladelab = 5,
    geneClusterPanel = "dotplot", nWords = 0) +
  ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = 0, add = 2)) +
  ggplot2::coord_cartesian()
p
```

#### 标志基因表格 {.tabset}

```{r results='asis'}
print_enrich_table(enr, "#####")
```


