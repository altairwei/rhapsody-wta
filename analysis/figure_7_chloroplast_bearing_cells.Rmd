---
title: "Slides for Paper Figures"
author: "Altair Wei"
date: "2023-08-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(magrittr)
library(ggtree, include.only = "%<+%")
source("../scripts/LoadUtils.R", chdir = TRUE)

options(ggrastr.default.dpi=300)
PT = 1/2.13
FT = 6/17.1
```

## Load Data Objects

### Seurat Objects

#### All samples

```{r}
obj <- readRDS(Sys.glob("../results/ObjectCache/IntegrationAndAnnotation/obj_annotated_*.rds"))
sce <- Seurat::as.SingleCellExperiment(obj, assay = "RNA")
sce <- muscat::prepSCE(sce,
  kid = "ident", # subpopulation assignments
  gid = "group", # group IDs (ctrl/stim)
  sid = "sample", # sample IDs (ctrl/stim.1234)
  drop = FALSE
)
```

```{r}
all_celltypes <- c(
   "Gu", "Ep_1", "Ep_2",
  "Me_1", "Me_2", "Me_3", "Me_4", "Me_5", "Me_6",
  "Va_1", "Va_2", "Va_3", "Va_4",
  "BS", "CC", "MPV_1", "MPV_2")

all_celltype_colors <- c(
  Gu    = "#4E79A7", Ep_1  = "#A0CBE8", Ep_2  = "#F28E2B",
  Me_1  = "#59A14F", Me_2  = "#8CD17D", Me_3  = "#499894",
  Me_4  = "#B6992D", Me_5  = "#D37295", Me_6  = "#FFBE7D",
  Va_1  = "#BAB0AC", Va_2  = "#FABFD2", Va_3  = "#86BCB6",
  Va_4  = "#B07AA1", BS    = "#E15759", CC    = "#FF9D9A",
  MPV_1 = "#79706E", MPV_2 = "#F1CE63"
)
```

```{r}
all_body_layers <- c(
  "Gu"    = "L1",
  "Ep_1"  = "L1",
  "Ep_2"  = "L1",
  "Me_1"  = "L2",
  "Me_2"  = "L2",
  "Me_3"  = "L2",
  "Me_4"  = "L2",
  "Me_5"  = "L2",
  "Me_6"  = "L2",
  "Va_1"  = "L2",
  "Va_2"  = "L2",
  "Va_3"  = "L2",
  "Va_4"  = "L2",
  "BS"    = "L3",
  "CC"    = "L3",
  "MPV_1" = "L3",
  "MPV_2" = "L3"
)

all_tissues <- c(
  Gu   = "Stomata",
  Ep_1 = "Epidermis",
  Ep_2 = "Epidermis",
  Me_1 = "Chlorenchyma",
  Me_2 = "Chlorenchyma",
  Me_3 = "Chlorenchyma",
  Me_4 = "Parenchyma",
  Me_5 = "Parenchyma",
  Me_6 = "Parenchyma",
  Va_1 = "Chlorenchyma",
  Va_2 = "Outer sheath",
  Va_3 = "Outer sheath",
  Va_4 = "Outer sheath",
  BS = "Inner sheath",
  CC = "Phloem",
  MPV_1 = "Procambium",
  MPV_2 = "Procambium"
)

all_tissues_colors <- structure(
  names = c("Stomata",      "Epidermis",    "Chlorenchyma", "Parenchyma",
            "Outer sheath", "Inner sheath", "Phloem",       "Procambium"),
  .Data = c("#4e79a7",      "#f28e2b",      "#8cd17d",      "#b6992d",
            "#86bcb6",      "#e15759",      "#ff9d9a",      "#79706e")
)


obj$tissue <- do.call(
  dplyr::recode, c(list(.x = Seurat::Idents(obj)), as.list(all_tissues)))
```

```{r}
sce$cluster_id <- forcats::fct_relevel(sce$cluster_id, all_celltypes)
Seurat::Idents(obj) <- forcats::fct_relevel(Seurat::Idents(obj), all_celltypes)
sce$body_layer <- do.call(
  dplyr::recode, c(list(.x = sce$cluster_id), as.list(all_body_layers)))
sce$tissue <- do.call(
  dplyr::recode, c(list(.x = sce$cluster_id), as.list(all_tissues)))
```

```{r}
all_cluster_num <- data.frame(
    names = as.character(Seurat::Idents(obj)),
    values = as.character(obj$RNA_snn_res.0.6)) |>
  dplyr::distinct() |>
  tibble::deframe()

all_cluster_num
```

## Figure 7 Chloroplast-bearing cells

### DA Measure

```{r}
sce_chl_all <- readRDS(Sys.glob(
  "../results/ObjectCache/TrajectoryInference/sce_all_slingshot_chl_all_*.rds"))
```

```{r}
da_chl_all <- rhapsodykit::findDiffAbundantCells(
  subset(obj, cells = colnames(sce_chl_all)),
  stim = paste(1:3, "DPI-PNR2", sep = ""),
  ctrl = paste(1:3, "DPI-TR4", sep = ""),
  reduction = "harmony", npc = 30,
  k.vector = seq(50, 1000, 50)
)
```

```{r fig.height=7, fig.width=8.9}
p1 <- local({
  df_to_plot <- reducedDim(sce_chl_all, "PHATE") |>
    as.data.frame() |>
    tibble::rownames_to_column("cell")

  da_df <- data.frame(
    cell = rownames(da_chl_all$embeddings$pca),
    score = da_chl_all$cells$da.pred)

  df_to_plot <- dplyr::left_join(df_to_plot, da_df) |>
    dplyr::arrange(!is.na(score), abs(score))

  p <-  ggplot2::ggplot(df_to_plot) +
    ggplot2::geom_point(
      mapping = ggplot2::aes(x = PHATE1, y = PHATE2, col = score),
      size = 0.5) +
    ggplot2::scale_color_gradientn(colours = c("blue", "white", "red"))

  p <- ggrastr::rasterise(p)

  p <- p +
      ggplot2::coord_fixed() +
      ggplot2::ggtitle("PNR2 vs. TR4") +
      ggplot2::labs(x = "PHATE_1", y = "PHATE_2") +
      ggplot2::guides(color = ggplot2::guide_colorbar(
        title = "DA Score", title.position = "top")) +
      cowplot::theme_cowplot(font_size = 22, font_family = "Arial") +
      theme_dimred(linesize = 1.5 * PT) +
      ggplot2::theme(
        axis.title = ggplot2::element_text(size = 22),
        plot.title = ggplot2::element_text(size = 22, face = "plain", hjust = 0.5),
        legend.title = ggplot2::element_text(size = 20),
        legend.text = ggplot2::element_text(size = 18),
        legend.key.width = grid::unit(1.2, "cm"),
        legend.key.height = grid::unit(0.7, "cm"),
        legend.direction = "horizontal",
        legend.title.align = 0.5,
        legend.position = c(0.5, 0.1))

  p
})

p1
```

```{r eval=FALSE, include=FALSE}
plotpowerpoint(p1, "../data/Figure.pptx",
  location = grid::unit(c(2.5, 4.49, 19.89, 15.63), "cm"),
  fonts = list(sans = "Arial", serif = "Arial", mono = "Courier"))
```

### Trajectories

```{r fig.height=7, fig.width=12.9}
p2 <- local({
  lapply(1:2, function(i) {
    plotLineageCurveOnReduc(
        sce_chl_all, i, dimred = "PHATE",
        linewidth = 1, point_size = 0.5,
        rasterise = TRUE, point_alpha = 1) +
      ggplot2::scale_color_viridis_c(labels = scales::number_format(accuracy = 0.1)) +
      ggplot2::coord_fixed() +
      ggplot2::labs(x = "PHATE_1", y = "PHATE_2") +
      ggplot2::ggtitle(paste("Branch", i)) +
      ggplot2::guides(color = ggplot2::guide_colorbar(
        title = "Pseudotime", title.position = "top")) +
      cowplot::theme_cowplot(font_size = 22, font_family = "Arial") +
      theme_dimred(linesize = 1.5 * PT) +
      ggplot2::theme(
        axis.title = ggplot2::element_text(size = 22),
        plot.title = ggplot2::element_text(size = 22, hjust = 0.5, face = "plain"),
        legend.key.width = grid::unit(1.2, "cm"),
        legend.key.height = grid::unit(0.7, "cm"),
        legend.text = ggplot2::element_text(size = 18),
        legend.title = ggplot2::element_text(size = 20),
        legend.direction = "horizontal",
        legend.title.align = 0.5,
        legend.position = c(0.5, 0.1))
  })
})

patchwork::wrap_plots(p2)
```

```{r fig.height=6, fig.width=22}
(p12 <- p1 + p2)
```

```{r eval=FALSE, include=FALSE}
plotpowerpoint(p12, "../data/Figure.pptx",
  location = grid::unit(c(2.5, 4.49, 49.01, 13.5), "cm"),
  fonts = list(sans = "Arial", serif = "Arial", mono = "Courier"))
```

### Gene Dynamic Expression

```{r}
tradeSce_chl_all <- readRDS(Sys.glob(
  "../results/ObjectCache/TrajectoryInference/tradeseq_gam_chl_all_*.rds"))

patternRes_chl_all <- readRDS(Sys.glob(
  "../results/ObjectCache/TrajectoryInference/tradeseq_patternRes_chl_all_*.rds"))
```

```{r}
yhatkm <- local({
  patternRes_df <- patternRes_chl_all |>
    tibble::rownames_to_column("gene") |>
    dplyr::mutate(fdr = p.adjust(pvalue, "fdr"))

  patternGenes <- patternRes_df |>
    dplyr::filter(fdr <= 0.01) |>
    dplyr::pull(gene) |>
    unique()

  yhatSmooth <- tradeSeq::predictSmooth(tradeSce_chl_all, gene = patternGenes, nPoints = 100, tidy = FALSE)
  yhatSmoothScaled <- t(scale(t(yhatSmooth)))

  set.seed(1124)
  fit_km <- kmeans(yhatSmoothScaled, 4, nstart = 25)

  avgtime <- split(
    x = as.data.frame(t(fit_km$centers)),
    f = stringr::str_match(
      colnames(fit_km$centers), "(lineage\\d)_")[, 2]) |>
  vapply(
    FUN.VALUE = numeric(nrow(fit_km$centers)),
    FUN = function(df) apply(df, 2, which.max)) |>
  base::rowMeans()

  row_split <- factor(
    x = paste0("G", fit_km$cluster),
    levels = paste0("G", names(sort(avgtime))))
  
  list(
    mtx = yhatSmoothScaled,
    km = fit_km,
    cluster = row_split
  )
})
```

```{r}
p3fun <- local({
  row_split <- yhatkm$cluster
  mtx <- yhatkm$mtx
  palette <- colorRamps::matlab.like

  # Calculate color bar
  mtx_uni <- unique(mtx)
  if (length(mtx_uni) < 100)
    q <- max(abs(mtx))
  else
    q <- stats::quantile(abs(mtx), probs = .99)

  bks <- seq(-q, q, length.out = 9)
  col_fun <- circlize::colorRamp2(
    breaks = bks,
    colors = palette(length(bks))
  )

  # Reverse first half of pseudotime expression matrix
  n_cols <- ncol(mtx)
  half_n_cols <- n_cols / 2
  new_order <- c(seq(half_n_cols, 1), seq(half_n_cols + 1, n_cols))
  mtx <- mtx[, new_order]

  ph_res <- ComplexHeatmap::Heatmap(
    mtx,

    use_raster = TRUE,

    # Keep original row/col order
    column_order = colnames(mtx),
    col = col_fun,

    cluster_rows = TRUE,
    show_row_names = FALSE,
    row_split = row_split,
    row_title_rot = 0,
    show_row_dend = FALSE,
    cluster_row_slices = FALSE,
    row_title_gp = grid::gpar(fontsize = 20, fontfamily = "Arial"),

    cluster_columns = FALSE,
    show_column_names = FALSE,
    show_column_dend = FALSE,
    column_split = stringr::str_match(
      colnames(mtx), "(lineage\\d)_")[, 2],
    column_title = paste("Branch", 1:2),
    column_title_gp = grid::gpar(fontsize = 20, fontfamily = "Arial"),

    heatmap_legend_param = list(
      title = "Gene Expression",
      legend_direction = "horizontal",
      legend_width = grid::unit(7, "cm"),
      title_position = "topcenter",
      title_gp = grid::gpar(fontsize = 20,fontfamily = "Arial"),
      labels_gp = grid::gpar(fontsize = 16, fontfamily = "Arial")
    )
  )

  function(...) {
    suppressWarnings(
      ComplexHeatmap::draw(
        ph_res, heatmap_legend_side = "bottom",
        align_heatmap_legend = "heatmap_left",
        legend_gap = grid::unit(1.5, "cm"),
        ...)
    )
  }
})

p3 <- p3fun()
```

```{r eval=FALSE, include=FALSE}
plotpowerpoint(p3, "../data/Figure.pptx", fun = p3fun,
  location = grid::unit(c(2.5, 18.32, 15, 15.63), "cm"),
  fonts = list(sans = "Arial", serif = "Arial", mono = "Courier"))
```

```{r eval=FALSE, include=FALSE}
split(names(yhatkm$km$cluster), paste0("G", yhatkm$km$cluster)) |>
  tibble::enframe("Module", "Gene") |>
  tidyr::unnest(cols = Gene) |>
  openxlsx::write.xlsx("../results/DataPlots/chlorenchyma_pseudotime_deg.xlsx")
```

### Enrichment of Gene Cluster

```{r}
p4data <- local({
  gene_list <- split(names(yhatkm$km$cluster), paste0("G", yhatkm$km$cluster))
  gene_list <- gene_list[levels(yhatkm$cluster)]

  clusterProfiler::compareCluster(
      gene_list,
      fun = "enrichGO",
      OrgDb = "org.Taestivum.iwgsc.db",
      keyType = "GID",
      ont = "BP",
      universe = rownames(tradeSce_chl_all))
})
```

```{r eval = FALSE}
p <- p4data |>
  enrichplot::pairwise_termsim(
    showCategory = NULL) |>
  enrichplot::treeplot(
    showCategory = NULL,
    size = "count",
    clusterPanel.params = list(
      clusterPanel = "dotplot"),
    cluster.params = list(
      n = 12, label_words_n = 0, label_format = 5),
    offset.params = list(bar_tree = 60, tiplab = 40),
    hilight.params = list()) +
  ggplot2::scale_y_continuous(
    expand = ggplot2::expansion(mult = c(0, 0), add = c(15, 0))) +
  NULL

plotpowerpoint(
  ggobj = p,
  file = "../results/DataPlots/chlorenchyma_pseudotime_deg.pptx",
  template = "../data/60x120.pptx")
```

```{r}
# Get representive GO terms
reprterms <- p4data |>
  as.data.frame() |>
  dplyr::select(Description, ID) |>
  dplyr::distinct() |>
  tibble::deframe()

reprterms <- reprterms[
  extractMarkedTerms("../results/DataPlots/chlorenchyma_pseudotime_deg.pptx")]

p4data |>
  dplyr::filter(ID %in% reprterms) |>
  printCompareORATable()
```

```{r fig.height=7, fig.width=8}
(p4 <- p4data |>
  dplyr::filter(ID %in% reprterms) |>
  enrichplot::dotplot(
    showCategory = 8,
    by = "count", label_format = 50) +
   ggplot2::ggtitle("Top GO biological process") +
   ggplot2::xlab("Gene Cluster") +
   ggplot2::theme(plot.title = ggplot2::element_text(size = 20, hjust = 0.1),
                  plot.title.position = "plot",
                  axis.title = ggplot2::element_text(size = 20),
                  axis.text.x = ggplot2::element_text(size = 16),
                  axis.text.y = ggplot2::element_text(size = 16),
                  legend.title = ggplot2::element_text(size = 18),
                  legend.text = ggplot2::element_text(size = 16),
                  legend.background = ggplot2::element_blank(),
                  #legend.position = c(0.18, 0.25),
                  axis.ticks = ggplot2::element_line(linewidth = 1.5 * PT),
                  panel.border = ggplot2::element_rect(linewidth = 1.5 * PT))
)
```

```{r eval=FALSE, include=FALSE}
plotpowerpoint(p4, "../data/Figure.pptx",
  location = grid::unit(c(17.65, 18.32, 22.83, 15.63), "cm"),
  fonts = list(sans = "Arial", serif = "Arial", mono = "Courier"))
```


### Selected Gene Dynamics

```{r fig.height=13, fig.width=7}
p5 <- local({
  genedf <- data.frame(
    cluster = yhatkm$cluster,
    gene = names(yhatkm$km$cluster)
  )

  exprdf <- yhatkm$mtx |>
    as.data.frame() |>
    tibble::rownames_to_column("gene") |>
    tidyr::pivot_longer(cols = !gene,
                        names_pattern = "lineage(\\d+)_(\\d+)",
                        names_to = c("lineage", "pseudotime"),
                        values_to = "expression") |>
    dplyr::mutate(pseudotime = as.numeric(pseudotime),
                  lineage = paste("Branch", lineage))

  df_to_plot <- dplyr::left_join(exprdf, genedf, by = "gene") |>
    dplyr::select(gene, cluster, dplyr::everything()) |>
    dplyr::mutate(group = paste(gene, lineage))

  df_to_plot |>
    dplyr::filter(gene %in% c("TraesCS5A02G257700", "TraesCS2B02G549600",
                              "TraesCS2D02G200700", "TraesCS5B02G039000")) |>
    ggplot2::ggplot(ggplot2::aes(
      x = pseudotime, y = expression)) +
    ggplot2::geom_line(
      mapping = ggplot2::aes(
        group = group, color = lineage),
      linewidth = 1.5) +
    ggplot2::scale_color_brewer(type = "qual", palette = "Dark2") +
    ggplot2::scale_y_continuous(breaks = scales::breaks_extended(n = 4)) +
    ggplot2::facet_wrap(~ gene, ncol = 1, scales = "free_y") +
    ggplot2::labs(x = "Pseudotime", y = "Normalized Expression", color = "Branch") +
    ggplot2::theme_bw(base_size = 22) +
    ggplot2::theme(
      panel.grid = ggplot2::element_blank(),
      strip.text = ggplot2::element_text(
        size = 16, vjust = 0.2, margin = ggplot2::margin(t = 4, b = 4)),
      axis.text.x = ggplot2::element_text(
        size = 16, angle = 0, hjust = 0.5, vjust = 0.5, color = "black"),
      axis.text.y = ggplot2::element_text(size = 16, color = "black"),
      axis.ticks = ggplot2::element_line(linewidth = 1.5 * PT),
      strip.background = ggplot2::element_rect(linewidth = 1.5 * PT),
      panel.border = ggplot2::element_rect(linewidth = 1.5 * PT),
      legend.position = c(0.25, 0.13),
      legend.background = ggplot2::element_blank(),
      legend.title = ggplot2::element_blank())
})

p5
```

```{r eval=FALSE, include=FALSE}
plotpowerpoint(p5, "../data/Figure.pptx",
  location = grid::unit(c(40.75, 18.32, 10.75, 15.63), "cm"),
  fonts = list(sans = "Arial", serif = "Arial", mono = "Courier"))
```

### ISH Gene Expression

```{r}
p6 <- local({
  scater::plotReducedDim(
      sce_chl_all, "PHATE",
      colour_by = "TraesCS5B02G039000",
      order_by = "TraesCS5B02G039000",
      point_alpha = 1, point_size = 0.5,
      rasterise = TRUE) +
    ggplot2::scale_color_gradient(low = "grey", high = "blue") +
    ggplot2::coord_fixed() +
    ggplot2::ggtitle("TraesCS5B02G039000") +
    ggplot2::labs(x = "PHATE_1", y = "PHATE_2") +
    ggplot2::guides(color = ggplot2::guide_colorbar(
      title = "Expression Level", title.position = "top")) +
    cowplot::theme_cowplot(font_size = 22, font_family = "Arial") +
    theme_dimred(linesize = 1.5 * PT) +
    ggplot2::theme(
      axis.title = ggplot2::element_text(size = 22),
      plot.title = ggplot2::element_text(size = 22, face = "plain", hjust = 0.5),
      legend.title = ggplot2::element_text(size = 20),
      legend.text = ggplot2::element_text(size = 18),
      legend.key.width = grid::unit(1.2, "cm"),
      legend.key.height = grid::unit(0.7, "cm"),
      legend.direction = "horizontal",
      legend.title.align = 0.5,
      legend.position = c(0.5, 0.1))
})

p6
```

```{r eval=FALSE, include=FALSE}
plotpowerpoint(p6, "../data/Figure.pptx",
  location = grid::unit(c(2.5, 34.6, 15.05, 15.63), "cm"),
  fonts = list(sans = "Arial", serif = "Arial", mono = "Courier"))
```

## Supplementary Figure 8

```{r}
theme_dim_chl <- function() {
  theme_dimred(linesize = 1.5 * PT) +
  ggplot2::theme(
    axis.title = ggplot2::element_text(size = 22),
    plot.title = ggplot2::element_text(size = 22, face = "plain", hjust = 0.5),
    legend.title = ggplot2::element_text(size = 20),
    legend.text = ggplot2::element_text(size = 18),
    legend.key.width = grid::unit(1.2, "cm"),
    legend.key.height = grid::unit(0.5, "cm"),
    legend.direction = "horizontal",
    legend.title.align = 0.5,
    legend.position = c(0.45, 0.02)
  )
}
```

### Photosynthesis Activity

```{r}
filelist <- paste0("../data/pathways/Photosyn", c("Ant", "Cfix", "PSEA"), ".txt")
names(filelist) <- basename(filelist) |> stringr::str_remove(stringr::fixed(".txt"))
photosyn <- lapply(filelist, function(filename) {
  genes <- stringr::str_trim(readLines(filename))
  genes[genes != ""]
})
```

```{r}
colData(sce_chl_all)[, names(photosyn)] <- as.data.frame(t(
  calculateModuleScore(logcounts(sce_chl_all), features = photosyn)))
```

```{r fig.height=5, fig.width=17}
piclist <- lapply(names(photosyn), function(pa) {
  p <- scater::plotReducedDim(
      sce_chl_all, dimred = "PHATE", order_by = pa,
      #order_by = I(sample(seq_len(ncol(sce_chl_all)))),
      colour_by = pa, point_size = 0.5, theme_size = 22) +
    ggplot2::ggtitle(pa) +
    ggplot2::scale_color_gradient(low = "grey", high = "blue", n.breaks = 3) +
    ggplot2::guides(color = ggplot2::guide_colorbar(
        title = "Module Score", title.position = "top")) +
    ggplot2::coord_fixed() +
    theme_dim_chl()
  ggrastr::rasterise(p)
})

p1 <- patchwork::wrap_plots(piclist, nrow = 1)

p1
```

### CNA of Chlorenchyma

```{r}
sce_chl_list <- lapply(
  c(MOCK = "MOCK", PNR2 = "PNR2", TR4 = "TR4"),
  function(treat) {
    sce_chl_treat <- sce_chl_all[, sce_chl_all$treatment == treat 
                                    | sce_chl_all$time == "0DPI"]
    sce_chl_treat$slingshot <- NULL

    sce_chl_treat$time_val <- as.numeric(factor(
      sce_chl_treat$time, levels = c("0DPI", "1DPI", "2DPI", "3DPI")))
    sce_chl_treat$sample <- as.character(sce_chl_treat$sample_id)

    sce_chl_treat <- association.SingleCellExperiment(
      sce_chl_treat, test_var = "time_val", samplem_key = "sample_id", dimred = "HARMONY")

    sce_chl_treat
  })
```

```{r}
blue_to_orange <- rev(ggthemes::ggthemes_data[[
  c("tableau", "color-palettes", "ordered-diverging", "Orange-Blue Diverging")]][["value"]])
```

```{r fig.height=5, fig.width=17}
plist <- purrr::imap(
  .x = sce_chl_list,
  .f = function(sce_treat, name) {
    p <- scater::plotReducedDim(
        sce_treat, dimred = "PHATE",
        colour_by = "cna_ncorrs",
        order_by = I(sample(seq_len(ncol(sce_treat)))),
        point_size = 1,
        theme_size = 12) +
      ggplot2::scale_color_gradientn(colours = blue_to_orange) +
      ggplot2::guides(color = ggplot2::guide_colorbar(
          title = "Coefficient", title.position = "top")) +
      ggplot2::coord_fixed() +
      ggplot2::ggtitle(name) +
      center_plot_title(face = "plain") +
      theme_dim_chl()
    ggrastr::rasterise(p)
  })

(p2 <- patchwork::wrap_plots(plist))
```

### Subpopulations of Chlorenchyma

```{r}
sce_chl_all$cluster.idnum <- factor(
  sce_chl_all$RNA_snn_res.0.6, levels = all_cluster_num[all_celltypes])
```

```{r fig.height=5, fig.width=7}
p3 <- scater::plotReducedDim(
    sce_chl_all,
    dimred = "PHATE",
    colour_by = "cluster.idnum",
    text_by = "cluster.idnum",
    text_size = 16 * FT,
    point_size = 0.5,
    theme_size = 22) +
  ggplot2::scale_color_manual(
    values = setNames(all_celltype_colors, all_cluster_num[all_celltypes])) +
  ggplot2::ggtitle("Subpopulations") +
  legend_override("color", list(size = 4, alpha = 1)) +
  ggplot2::coord_fixed() +
  theme_dimred(linesize = 1.5 * PT) +
  ggplot2::theme(legend.title = ggplot2::element_blank(),
                 legend.text = ggplot2::element_text(size = 18),
                 legend.key.size = grid::unit(4, "mm"),
                 plot.title = ggplot2::element_text(size = 22, hjust = 0.5, face = "plain"),
                 legend.position = c(0.85, 0.8))

(p3 <- ggrastr::rasterise(p3))
```

### CNA Score Distribution

```{r fig.height=5, fig.width=12}
df_ncorrs <- purrr::imap(
  .x = sce_chl_list,
  .f = function(sce_treat, name) data.frame(
      time_ncorrs = sce_treat$cna_ncorrs,
      cellType = sce_treat$RNA_snn_res.0.6,
      treatment = name
    )
  ) |> dplyr::bind_rows()

df_ncorrs$cellType <- forcats::fct_relevel(
  df_ncorrs$cellType, c("1", "3", "6", "0"))

fdr_df <- purrr::imap(
  .x = sce_chl_list,
  .f = function(x, treat) {
    fdr <- metadata(x)$cnaRes$fdr_5p_t
    data.frame(
      treatment = treat,
      posfdr = fdr,
      negfdr = -fdr)
  }) |> dplyr::bind_rows()

p4 <- ggplot2::ggplot(df_ncorrs, ggplot2::aes(
    x = time_ncorrs, y = cellType, fill = cellType)) +
  ggplot2::ylab("Subpopulation") +
  ggplot2::xlab("Neighborhood Coefficient") +
  ggridges::geom_density_ridges(scale = 4) +
  ggplot2::geom_vline(
    data = fdr_df, mapping = ggplot2::aes(xintercept = posfdr),
    linetype = "dashed") +
  ggplot2::geom_vline(
    data = fdr_df, mapping = ggplot2::aes(xintercept = negfdr),
    linetype = "dashed") +
  ggplot2::facet_wrap(~ treatment) +
  ggplot2::scale_fill_manual(
    values = setNames(all_celltype_colors, all_cluster_num[all_celltypes])) +
  ggplot2::scale_y_discrete(limits=rev, expand = ggplot2::expansion(add = c(0, 4))) +
  ggridges::theme_ridges(22) +
  empty_strip(
    strip.text = ggplot2::element_text(size = 22)) +
  remove_legend()

p4
```

```{r fig.height=5, fig.width=17}
(p34 <- p3 + p4 + patchwork::plot_layout(widths = c(1, 2)))
```

### DA-seq of 1 DPI Chlorenchyma

```{r}
da_chl_1dpi_pnr2 <- rhapsodykit::findDiffAbundantCells(
  subset(obj, cells = colnames(sce_chl_all)),
  stim = "1DPI-PNR2",
  ctrl = "1DPI-MOCK",
  reduction = "harmony", npc = 30,
  k.vector = seq(50, 1000, 50)
)

da_chl_1dpi_tr4 <- rhapsodykit::findDiffAbundantCells(
  subset(obj, cells = colnames(sce_chl_all)),
  stim = "1DPI-TR4",
  ctrl = "1DPI-MOCK",
  reduction = "harmony", npc = 30,
  k.vector = seq(50, 1000, 50)
)
```

```{r fig.height=5, fig.width=12}
p5 <- local({
  df_phate <- reducedDim(sce_chl_all[, sce_chl_all$time == "1DPI"], "PHATE") |>
    as.data.frame() |>
    tibble::rownames_to_column("cell")

  plist <- purrr::imap(
    .x = list(
      "PNR2 vs. MOCK at 1DPI" = da_chl_1dpi_pnr2,
      "TR4 vs. MOCK at 1DPI" = da_chl_1dpi_tr4),
    .f = function(da_chl_all, index) {
      da_df <- data.frame(
        cell = rownames(da_chl_all$embeddings$pca),
        score = da_chl_all$cells$da.pred)

      df_to_plot <- dplyr::left_join(df_phate, da_df) |>
        dplyr::arrange(!is.na(score), abs(score))

      p <-  ggplot2::ggplot(df_to_plot) +
        ggplot2::geom_point(
          mapping = ggplot2::aes(x = PHATE1, y = PHATE2, col = score),
          size = 0.5) +
        ggplot2::scale_color_gradientn(colours = c("blue", "white", "red"))

      p <- ggrastr::rasterise(p)

      p <- p +
          ggplot2::coord_fixed() +
          ggplot2::labs(x = "PHATE_1", y = "PHATE_2") +
          ggplot2::ggtitle(index) +
          ggplot2::guides(color = ggplot2::guide_colorbar(
            title = "DA Score", title.position = "top")) +
          cowplot::theme_cowplot(font_size = 22, font_family = "Arial") +
          theme_dim_chl()

      ggrastr::rasterise(p)
    })

  plist
})

patchwork::wrap_plots(p5)
```

### RNA Molecular Distribution

```{r fig.height=5, fig.width=7}
p6 <- scater::plotReducedDim(
    sce_chl_all, dimred = "PHATE",
    colour_by = "nCount_RNA",
    order_by = "nCount_RNA",
    point_size = 1,
    theme_size = 22) +
  ggplot2::coord_fixed() +
  ggplot2::scale_color_viridis_c(
    trans = "log10", labels = scales::label_log(digits = 2)) +
  ggplot2::guides(color = ggplot2::guide_colorbar(
    title = "RNA Count", title.position = "top")) +
  center_plot_title(face = "plain") +
  remove_legend_title() +
  theme_dim_chl()

(p6 <- ggrastr::rasterise(p6))
```

```{r fig.height=5, fig.width=17}
(p56 <- p5[[1]] + p5[[2]] + p6)
```

### Combine All Plots

```{r fig.height=20, fig.width=17}
(p <- p1 / p2 / p34 / p56)
```

```{r eval=FALSE, include=FALSE}
plotpowerpoint(p, "../data/Figure.pptx",
  location = grid::unit(c(2.5, 4.49, 49.01, 57.66), "cm"),
  fonts = list(sans = "Arial", serif = "Arial", mono = "Courier"))
```

### Leaf Senescence Genes

> Li, J., Qiao, H., Yin, P., Liu, M., Yang, Y., Li, K., Yang, L., Yang, C., Zhao, L., Zhou, S., et al. (2023). Increasingly amplified stimulation mediated by TaNAC69-B is crucial for the leaf senescence in wheat. The Plant Journal 114, 570–590. 10.1111/tpj.16154.


```{r}
local({
  scater::plotReducedDim(
      sce_chl_all, "PHATE",
      colour_by = "TraesCS5B02G142100",
      order_by = "TraesCS5B02G142100",
      point_alpha = 1, point_size = 0.5,
      rasterise = TRUE) +
    ggplot2::scale_color_gradient(low = "grey", high = "blue") +
    ggplot2::coord_fixed() +
    ggplot2::ggtitle("TaNAC69-B") +
    ggplot2::labs(x = "PHATE_1", y = "PHATE_2") +
    ggplot2::guides(color = ggplot2::guide_colorbar(
      title = "Expression Level", title.position = "top")) +
    cowplot::theme_cowplot(font_size = 22, font_family = "Arial") +
    theme_dimred(linesize = 1.5 * PT) +
    ggplot2::theme(
      axis.title = ggplot2::element_text(size = 22),
      plot.title = ggplot2::element_text(size = 22, face = "plain", hjust = 0.5),
      legend.title = ggplot2::element_text(size = 20),
      legend.text = ggplot2::element_text(size = 18),
      legend.key.width = grid::unit(1.2, "cm"),
      legend.key.height = grid::unit(0.7, "cm"),
      legend.direction = "horizontal",
      legend.title.align = 0.5,
      legend.position = c(0.5, 0.1))
})
```

```{r}
local({
  scater::plotReducedDim(
      sce_chl_all, "PHATE",
      colour_by = "TraesCS2B02G270600",
      order_by = "TraesCS2B02G270600",
      point_alpha = 1, point_size = 0.5,
      rasterise = TRUE) +
    ggplot2::scale_color_gradient(low = "grey", high = "blue") +
    ggplot2::coord_fixed() +
    ggplot2::ggtitle("TaAO3-B") +
    ggplot2::labs(x = "PHATE_1", y = "PHATE_2") +
    ggplot2::guides(color = ggplot2::guide_colorbar(
      title = "Expression Level", title.position = "top")) +
    cowplot::theme_cowplot(font_size = 22, font_family = "Arial") +
    theme_dimred(linesize = 1.5 * PT) +
    ggplot2::theme(
      axis.title = ggplot2::element_text(size = 22),
      plot.title = ggplot2::element_text(size = 22, face = "plain", hjust = 0.5),
      legend.title = ggplot2::element_text(size = 20),
      legend.text = ggplot2::element_text(size = 18),
      legend.key.width = grid::unit(1.2, "cm"),
      legend.key.height = grid::unit(0.7, "cm"),
      legend.direction = "horizontal",
      legend.title.align = 0.5,
      legend.position = c(0.5, 0.1))
})
```

```{r}
list(
  PAO = c(
    "TraesCS4A02G411000",
    "TraesCS4B02G311100",
    "TraesCS4D02G309000" #
  ),
  PPH = c(
    "TraesCS7A02G338900",
    "TraesCS7B02G250200",
    "TraesCS7D02G346100"
  ),
  NYC1 = c(
    "TraesCS3A02G151900",
    "TraesCS3B02G179100",
    "TraesCS3D02G159800"
  ),
  SGR1 = c(
    "TraesCS5A02G319900",
    "TraesCS5B02G320200",
    "TraesCS5D02G325900" #
  )
)
```

```{r}
local({
  scater::plotReducedDim(
      sce, "UMAP",
      colour_by = "TraesCS5A02G319900",
      order_by = "TraesCS5A02G319900",
      point_alpha = 1, point_size = 0.5,
      rasterise = TRUE) +
    ggplot2::scale_color_gradient(low = "grey", high = "blue") +
    ggplot2::coord_fixed() +
    ggplot2::ggtitle("PAO") +
    #ggplot2::labs(x = "PHATE_1", y = "PHATE_2") +
    ggplot2::guides(color = ggplot2::guide_colorbar(
      title = "Expression Level", title.position = "top")) +
    cowplot::theme_cowplot(font_size = 22, font_family = "Arial") +
    theme_dimred(linesize = 1.5 * PT) +
    ggplot2::theme(
      axis.title = ggplot2::element_text(size = 22),
      plot.title = ggplot2::element_text(size = 22, face = "plain", hjust = 0.5))
})
```

```{r}
local({
  scater::plotReducedDim(
      sce_chl_all, "PHATE",
      colour_by = "TraesCS5D02G325900",
      order_by = "TraesCS5D02G325900",
      point_alpha = 1, point_size = 0.5,
      rasterise = TRUE) +
    ggplot2::scale_color_gradient(low = "grey", high = "blue") +
    ggplot2::coord_fixed() +
    #ggplot2::ggtitle("PAO") +
    ggplot2::labs(x = "PHATE_1", y = "PHATE_2") +
    ggplot2::guides(color = ggplot2::guide_colorbar(
      title = "Expression Level", title.position = "top")) +
    cowplot::theme_cowplot(font_size = 22, font_family = "Arial") +
    theme_dimred(linesize = 1.5 * PT) +
    ggplot2::theme(
      axis.title = ggplot2::element_text(size = 22),
      plot.title = ggplot2::element_text(size = 22, face = "plain", hjust = 0.5),
      legend.title = ggplot2::element_text(size = 20),
      legend.text = ggplot2::element_text(size = 18),
      legend.key.width = grid::unit(1.2, "cm"),
      legend.key.height = grid::unit(0.7, "cm"),
      legend.direction = "horizontal",
      legend.title.align = 0.5,
      legend.position = c(0.5, 0.1))
})
```

```{r}
local({
  genedf <- data.frame(
    cluster = yhatkm$cluster,
    gene = names(yhatkm$km$cluster)
  )

  exprdf <- yhatkm$mtx |>
    as.data.frame() |>
    tibble::rownames_to_column("gene") |>
    tidyr::pivot_longer(cols = !gene,
                        names_pattern = "lineage(\\d+)_(\\d+)",
                        names_to = c("lineage", "pseudotime"),
                        values_to = "expression") |>
    dplyr::mutate(pseudotime = as.numeric(pseudotime),
                  lineage = paste("Branch", lineage))

  df_to_plot <- dplyr::left_join(exprdf, genedf, by = "gene") |>
    dplyr::select(gene, cluster, dplyr::everything()) |>
    dplyr::mutate(group = paste(gene, lineage))

  df_to_plot |>
    dplyr::filter(gene %in% c(
    "TraesCS5A02G319900",
    "TraesCS5B02G320200",
    "TraesCS5D02G325900"
    )) |>
    ggplot2::ggplot(ggplot2::aes(
      x = pseudotime, y = expression)) +
    ggplot2::geom_line(
      mapping = ggplot2::aes(
        group = group, color = lineage),
      linewidth = 1.5) +
    ggplot2::scale_color_brewer(type = "qual", palette = "Dark2") +
    ggplot2::scale_y_continuous(breaks = scales::breaks_extended(n = 4)) +
    ggplot2::facet_wrap(~ gene, ncol = 1, scales = "free_y") +
    ggplot2::labs(x = "Pseudotime", y = "Normalized Expression", color = "Branch") +
    ggplot2::theme_bw(base_size = 22) +
    ggplot2::theme(
      panel.grid = ggplot2::element_blank(),
      strip.text = ggplot2::element_text(
        size = 16, vjust = 0.2, margin = ggplot2::margin(t = 4, b = 4)),
      axis.text.x = ggplot2::element_text(
        size = 16, angle = 0, hjust = 0.5, vjust = 0.5, color = "black"),
      axis.text.y = ggplot2::element_text(size = 16, color = "black"),
      axis.ticks = ggplot2::element_line(linewidth = 1.5 * PT),
      strip.background = ggplot2::element_rect(linewidth = 1.5 * PT),
      panel.border = ggplot2::element_rect(linewidth = 1.5 * PT),
      legend.position = c(0.25, 0.13),
      legend.background = ggplot2::element_blank(),
      legend.title = ggplot2::element_blank())
})
```

## Supplementary Figure 9

### SERN family

```{r}
SERNs <- c(
  "TraesCS7D02G124000",
  "TraesCS7D02G256100",
  "TraesCS1D02G178700",
  "TraesCS2B02G002300",
  "TraesCS3B02G189500",
  "TraesCS4D02G150400",
  "TraesCS3A02G405700",
  "TraesCS4A02G155200",
  "TraesCS5B02G423500",
  "TraesCS1D02G212600",
  "TraesCS5D02G345900",
  "TraesCS7D02G255100",
  "TraesCS1A02G343500",
  "TraesCS5D02G345100",
  "TraesCS5B02G096700",
  "TraesCS3A02G485300",
  "TraesCS1B02G413100",
  "TraesCS2B02G521400",
  "TraesCS1D02G183600",
  "TraesCSU02G243900",
  "TraesCS5B02G040100",
  "TraesCS2B02G331800",
  "TraesCS2A02G240700",
  "TraesCS2A02G240400",
  "TraesCS2B02G601100",
  "TraesCS5D02G221000",
  "TraesCS1B02G406200",
  "TraesCS1D02G387400",
  "TraesCS3A02G430500",
  "TraesCS2B02G252400",
  "TraesCS7B02G396300",
  "TraesCS7A02G289000",
  "TraesCS4A02G155900",
  "TraesCS5B02G039000",
  "TraesCS5D02G488100",
  "TraesCS2A02G242400",
  "TraesCS6B02G402800",
  "TraesCS4A02G272300",
  "TraesCS3B02G066800"
)

length(SERNs)
```

```{r}
sum(SERNs %in% names(yhatkm$km$cluster))
```

```{r}
yhatkm$km$cluster[SERNs] |> unique()
```

### Pseudotime Expression

```{r}
local({
  genedf <- data.frame(
    cluster = yhatkm$cluster,
    gene = names(yhatkm$km$cluster)
  )

  exprdf <- yhatkm$mtx |>
    as.data.frame() |>
    tibble::rownames_to_column("gene") |>
    tidyr::pivot_longer(cols = !gene,
                        names_pattern = "lineage(\\d+)_(\\d+)",
                        names_to = c("lineage", "pseudotime"),
                        values_to = "expression") |>
    dplyr::mutate(pseudotime = as.numeric(pseudotime),
                  lineage = paste("Branch", lineage))

  df_to_plot <- dplyr::left_join(exprdf, genedf, by = "gene") |>
    dplyr::select(gene, cluster, dplyr::everything()) |>
    dplyr::mutate(group = paste(gene, lineage))

  df_to_plot |>
    dplyr::filter(gene %in% SERNs) |>
    ggplot2::ggplot(ggplot2::aes(
      x = pseudotime, y = expression)) +
    ggplot2::geom_line(
      mapping = ggplot2::aes(
        group = group, color = lineage),
      linewidth = 1.5) +
    ggplot2::scale_color_brewer(type = "qual", palette = "Dark2") +
    ggplot2::scale_y_continuous(breaks = scales::breaks_extended(n = 4)) +
    #ggplot2::facet_wrap(~ gene, ncol = 1, scales = "free_y") +
    ggplot2::labs(x = "Pseudotime", y = "Normalized Expression", color = "Branch") +
    ggplot2::theme_bw(base_size = 22) +
    ggplot2::theme(
      panel.grid = ggplot2::element_blank(),
      strip.text = ggplot2::element_text(
        size = 16, vjust = 0.2, margin = ggplot2::margin(t = 4, b = 4)),
      axis.text.x = ggplot2::element_text(
        size = 16, angle = 0, hjust = 0.5, vjust = 0.5, color = "black"),
      axis.text.y = ggplot2::element_text(size = 16, color = "black"),
      axis.ticks = ggplot2::element_line(linewidth = 1.5 * PT),
      strip.background = ggplot2::element_rect(linewidth = 1.5 * PT),
      panel.border = ggplot2::element_rect(linewidth = 1.5 * PT),
      legend.position = c(0.15, 0.9),
      legend.background = ggplot2::element_blank(),
      legend.title = ggplot2::element_blank())
})
```

### Average Expression Pct


