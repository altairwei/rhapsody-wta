---
title: "Geneset Analysis"
author: "Altair Wei"
output: html_document
---

```{r setup, include=FALSE}
library(magrittr)
library(patchwork)
knitr::opts_chunk$set(echo = TRUE)
```

## 1 差异状态基因集的富集分析

首先读取差异分析的结果：

```{r}
ds_res <- readRDS(Sys.glob("../output/ds_res_*.rds"))
```

### 1.1 基于 GO 注释的功能分析

#### 1.1.1 加载注释数据

首先我们要拿到小麦 GO 注释数据：

```{r read-go-data, eval=FALSE}
# Get GO Data
# quote="" argument is neccessary for reading the complete table,
# because it disables quoting.
go_data <- read.table(
  "../data/GOData.tsv", header = TRUE, sep = "\t", quote = "") %>%
  tibble::as_tibble()

go_data <- go_data %>%
  dplyr::filter(GO_ID != "")

go2gene <- go_data %>%
  dplyr::select(GO_ID, Gene_ID)
go2name <- go_data %>%
  dplyr::select(GO_ID, GO_Name)
```

不过我们现在已经构建出了[小麦的 OrgDb](https://github.com/altairwei/org.Taestivum.iwgsc.db) ，试用一下：

```{r results="hide"}
library(org.Taestivum.iwgsc.db)
orgdb <- org.Taestivum.iwgsc.db
```

数据库里拥有的数据类型：

```{r}
keytypes(orgdb)
```

我们来看看一共有多少个基因：

```{r}
length(keys(orgdb, keytype = "GID"))
```

这与 Ensemble Plants 上的数量一致。

#### 1.1.2 对差异状态基因做富集分析

关于富集分析的背景选择，我们可以考虑将 scRNA-Seq 能检测到的基因作为背景，而不使用全基因组。不过这里也可以考虑用某个 cluster 在 DS 分析时检测到的基因作为背景，因为不同的细胞类型会表达的基因是有很大的差别的。

要做富集分析我们首先要拿到一个基因列表。

##### ORA 工具函数

```{r}
performDSEnrichORA <- function(
  ds, contrasts, cluster,
  ont = c("BP", "MF", "CC", "ALL"),
  simplify = TRUE
) {
  ont <- match.arg(ont)

  # We use all detected genes in DS analysis of given cluster as background
  background <- rhapsodykit::diff_state_pull(
    ds, contrasts, cluster, "gene")

  sig_genes <- ds %>%
    rhapsodykit::diff_state_significant()
  genes <- sig_genes %>%
    rhapsodykit::diff_state_pull(contrasts, cluster, "gene")
  fc <- sig_genes %>%
    rhapsodykit::diff_state_pull(contrasts, cluster, "logFC")
  names(fc) <- genes

  enr <- clusterProfiler::enrichGO(
      genes,
      org.Taestivum.iwgsc.db,
      keyType = "GID",
      ont = ont,
      universe = background
    )

  if (simplify && ont != "ALL")
    enr <- clusterProfiler::simplify(enr, cutoff = 0.5)

  list(
    enr = enr,
    fc = fc
  )
}

performDSCompareORA <- function(
  ds, contrasts, clusters,
  ont = c("BP", "MF", "CC", "ALL"),
  simplify = TRUE
) {
  ont <- match.arg(ont)

  if (is.null(names(contrasts)))
    names(contrasts) <- contrasts
  if (is.null(names(clusters)))
    names(clusters) <- clusters

  background <- purrr::imap(clusters, function(clr, clr_name) {
      purrr::imap(contrasts, function(con, con_name) {
        ds %>% rhapsodykit::diff_state_pull(con, clr, "gene")
      })
    }) %>%
    unlist() %>%
    unique()

  compare_df <- purrr::imap(clusters, function(clr, clr_name) {
      purrr::imap(contrasts, function(con, con_name) {
        df <- ds %>%
          rhapsodykit::diff_state_significant() %>%
          rhapsodykit::diff_state_pull(con, clr, c("gene", "logFC"))
        df$gene
        data.frame(
          gene = df$gene,
          contrast = con_name,
          cluster = clr_name
        )
      })
    }) %>%
    unlist(recursive = FALSE) %>%
    dplyr::bind_rows()

  compare_df$cluster <- factor(compare_df$cluster, levels = names(clusters))
  compare_df$contrast <- factor(compare_df$contrast, levels = names(contrasts))

  comp_enr <- clusterProfiler::compareCluster(
      gene ~ cluster + contrast,
      data = compare_df,
      fun = "enrichGO",
      OrgDb = org.Taestivum.iwgsc.db,
      keyType = "GID",
      ont = ont,
      universe = background
    )

  if (simplify && ont != "ALL")
    comp_enr <- clusterProfiler::simplify(comp_enr, cutoff = 0.5)

  comp_enr
}
```

##### 嵌字条形图

```{r enrich-barplot, fig.height=5, fig.width=10}
enr1 <- performDSEnrichORA(
  ds_res$DESeq2,
  "X1DPI.PNR2-X1DPI.MOCK", "VCs_5",
  ont = "BP"
)

enr2 <- performDSEnrichORA(
  ds_res$DESeq2,
  "X1DPI.PNR2-X1DPI.MOCK", "VCs_5",
  ont = "MF"
)

p1 <- enr1$enr %>%
  brookite::enrich_barplot(
    x = "Count", show_category = 20,
    title = "VCs_5 of 1DPI-PNR2 vs. 1DPI-MOCK"
  )

p2 <-  enr2$enr %>% 
  brookite::enrich_barplot(
    x = "Count", show_category = 20,
    title = "VCs_5 of 1DPI-PNR2 vs. 1DPI-MOCK"
  )

p1 + p2
```

##### GO 父子关系图

```{r fig.height=7, fig.width=10}
clusterProfiler::goplot(enr1$enr, showCategory = 40)
```

```{r fig.height=7, fig.width=10}
enr <- performDSEnrichORA(
  ds_res$DESeq2,
  "X1DPI.PNR2-X1DPI.MOCK", "MCs_5",
  ont = "BP"
)

enrichplot::goplot(enr$enr, showCategory = 60)
```

##### 基因与 GO 词条的关系图

现在我们可以从基因与 GO 的关系绘图：

```{r cnetplot, fig.height=8, fig.width=16}
enr1 <- performDSEnrichORA(ds_res$DESeq2, "X1DPI.PNR2-X1DPI.MOCK", "VCs_5", ont = "BP")
enr2 <- performDSEnrichORA(ds_res$DESeq2, "X1DPI.PNR2-X1DPI.MOCK", "VCs_5", ont = "MF")

brookite::enrich_cnetplot(enr1$enr, fold_change = enr1$fc, show_category = 30) +
brookite::enrich_cnetplot(enr2$enr, fold_change = enr2$fc, show_category = 30)
```

##### GO 词条关系图

如果我们不将基因显示为 node ，而是将 GO 词条之间的链接定义为重叠基因的数量，也就是说 GO 词条之间重叠基因越多他们在图上的距离也就越近。这个功能叫做 Enrichment Map 。

```{r emapplot, fig.height=6, fig.width=12}
p1 <- enr1$enr %>%
  enrichplot::pairwise_termsim() %>%
  enrichplot::emapplot(cex_label_category = 0.6, showCategory = 20)
p2 <- enr2$enr %>%
  enrichplot::pairwise_termsim() %>%
  enrichplot::emapplot(cex_label_category = 0.6, showCategory = 20)

p1 + p2
```

##### 语义相似性进化树

```{r fig.height=6, fig.width=12}
enr1$enr %>%
  enrichplot::pairwise_termsim() %>%
  enrichplot::treeplot(splot=TRUE, nWords = 1, nCluster = 4)
```

##### 富集热图

当要展示很多 GO 词条时，网络图就会变得非常复杂，我们可以试试 clusterProfiler 的 Heatmap-like functional classification 功能。不过这个热图似乎没有聚类，也就不是很方便人类阅读和理解了。TODO:

```{r heatmap, fig.height=6, fig.width=12}
p1 <- enr1$enr %>%
  clusterProfiler::heatplot(foldChange = enr1$fc)

p2 <- enr2$enr %>%
  clusterProfiler::heatplot(foldChange = enr1$fc)

p1 + p2
```

##### 集合交集图

使用 UpSet 图似乎看起来更有意义。

```{r upsetplot, fig.height=6, fig.width=12}
p1 <- enr1$enr %>% enrichplot::upsetplot()
p2 <- enr2$enr %>% enrichplot::upsetplot()

p1 + p2
```

##### 生物主题比较

我们可以试试 clusterProfiler 生物主题比较功能：

TODO: 将 dotplot 按照 cluster 来 facet 化，然后 x 轴显示 contrast 就好了。 
TODO: 将 enrichplot::dotplot 与 ggupset 结合到一起，看看能否提供更方便快捷的理解方式。

参考资料：

-   [Biological theme comparison](http://yulab-smu.top/clusterProfiler-book/chapter11.html)
-   [biological-theme-comparison](https://yulab-smu.top/biomedical-knowledge-mining-book/enrichplot.html#biological-theme-comparison)
-   Yu, G., Wang, L.-G., Han, Y., & He, Q.-Y. (2012). clusterProfiler: An R Package for Comparing Biological Themes Among Gene Clusters. OMICS: A Journal of Integrative Biology, 16(5), 284--287. <https://doi.org/10.1089/omi.2011.0118>

然后看看 GO 词条之间的关联。

VCs_5 和 MCs_5 的生物主题比较：

```{r 1dpi-ora-compare-cluster, dev="png", fig.height=12, fig.width=8, fig.keep="last"}
comp_enr <- performDSCompareORA(ds_res$DESeq2,
  contrasts = c(
    "PNR2_1DPI" = "X1DPI.PNR2-X1DPI.MOCK",
    "TR4_1DPI" = "X1DPI.TR4-X1DPI.MOCK"
  ),
  clusters = c(
    "VCs_5" = "VCs_5",
    "MCs_5" = "MCs_5"
  )
)

comp_enr@compareClusterResult$cluster <- factor(comp_enr@compareClusterResult$cluster, c("VCs_5", "MCs_5"))
enrichplot::dotplot(
    comp_enr, x = "contrast",
    showCategory = 40, by = "count", label_format = 60) +
  ggplot2::facet_grid(~cluster) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
```

```{r fig.height=7, fig.width=10}
comp_enr %>%
  enrichplot::pairwise_termsim() %>%
  enrichplot::emapplot(legend_n = 3)
```

```{r fig.height=7, fig.width=10}
comp_enr %>% enrichplot::cnetplot(showCategory = 30, node_label = "category")
```

```{r fig.height=8, fig.width=12}
p <- comp_enr %>%
  enrichplot::pairwise_termsim() %>%
  enrichplot::treeplot(
    showCategory = 40, nCluster = 12,
    offset = 2, offset_tiplab = 1.8,
    label_format_cladelab = 5,
    geneClusterPanel = "dotplot", cex_category = 6, nWords = 0) +
  ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = 0, add = 5.5))
p
```

#### 1.1.3 对差异状态基因做 GSEA 分析

##### GSEA 工具函数

GSEA 不能过滤出显著的 DEGs ，我们直接计算出所有基因的 Log Fold Change 就行了 了。如果筛选差异基因的话，你看的只是差异基因在哪些通路上，这有可能是一种终末端的效应。如果一条通路上所有基因都上调 20% ，它们都不是差异基因，但这条通路激活效应就非常强了，比通路中一两个差异基因上调几十倍造成的效应都强。GSEA 的理念就是不去筛选差异基因，只看这条通路上的基因是不是一致上调和一致下调。

基于差异基因表达的富集分析可以找到差异较大的基因，但它发现不了那些虽然差异较小的，但在一组相关基因中以协调的方式得到证明的基因。因此 Gene Set Enrichment Analysis (GSEA) 直接关注这个问题。

GSEA 将一个基因集内各基因的统计数据聚合起来，因此有可能检测到一个预定义的基因集中所有基因以小而协调的方式变化的情况。因为许多相关的表型差异很可能是由一组基因中微小但一致的变化表现出来的。

基因是根据其表型进行排名的。给定一个预先的基因集 S (例如，共享相同 DO 类别的基因) ，GSEA 的目标是确定 S 的成员是随机分布在整个排序好的基因列表 (L)，还是主要存在于顶部或底部。.

For gene set enrichment analysis, we need a ranked list of genes. Suppose you are importing your own data from a csv file and the file contains two columns, one for gene ID (no duplicated allowed) and another one for fold change, you can prepare your own geneList via the following command:

```{r gsea-data, results="hide"}
performDSEnrichGSEA <- function(
  ds, contrasts, clusters,
  ont = c("BP", "MF", "CC", "ALL"),
  simplify = TRUE
) {
  ont <- match.arg(ont)

  ## 我们不需要依据 FDR 来筛选基因，只需要 logFC 来排序
  gsea_df <- ds %>%
    rhapsodykit::diff_state_pull(contrasts, clusters, c("gene", "logFC"))

  ## feature 1: numeric vector
  geneList <- gsea_df[, 2]

  ## feature 2: named vector
  names(geneList) <- as.character(gsea_df[, 1])

  ## feature 3: decreasing order
  geneList <- sort(geneList, decreasing = TRUE)

  gsea <- clusterProfiler::gseGO(
    geneList,
    ont = ont,
    OrgDb = org.Taestivum.iwgsc.db,
    keyType = "GID"
  )

  if (simplify && ont != "ALL")
    gsea <- clusterProfiler::simplify(gsea)
  
  list(
    gsea = gsea,
    fc = geneList
  )

}

performDSCompareGSEA <- function(
  ds, contrasts, clusters,
  ont = c("BP", "MF", "CC", "ALL"),
  simplify = TRUE
) {
  ont <- match.arg(ont)

  if (is.null(names(contrasts)))
    names(contrasts) <- contrasts
  if (is.null(names(clusters)))
    names(clusters) <- clusters

  compare_df <- purrr::imap(clusters, function(clr, clr_name) {
      purrr::imap(contrasts, function(con, con_name) {
        df <- ds %>%
          rhapsodykit::diff_state_pull(con, clr, c("gene", "logFC"))
        geneList <- df[, 2]
        names(geneList) <- as.character(df[, 1])
        geneList <- sort(geneList, decreasing = TRUE)
        data.frame(
          gene = names(geneList),
          fc = geneList,
          cluster = clr_name,
          contrast = con_name
        )
      })
    }) %>%
    unlist(recursive = FALSE) %>%
    dplyr::bind_rows()

  compare_df$cluster <- factor(compare_df$cluster, levels = names(clusters))
  compare_df$contrast <- factor(compare_df$contrast, levels = names(contrasts))

  comp_enr <- clusterProfiler::compareCluster(
      gene | fc ~ cluster + contrast,
      data = compare_df,
      OrgDb = org.Taestivum.iwgsc.db,
      fun = "gseGO",
      keyType = "GID",
      ont = ont
    )

  if (simplify && ont != "ALL")
    comp_enr <- clusterProfiler::simplify(comp_enr, cutoff = 0.5)

  comp_enr
}
```

```{r results="hide"}
gsea1 <- performDSEnrichGSEA(ds_res$DESeq2, "X1DPI.PNR2-X1DPI.MOCK", "VCs_5", ont = "BP")
gsea2 <- performDSEnrichGSEA(ds_res$DESeq2, "X1DPI.PNR2-X1DPI.MOCK", "VCs_5", ont = "MF")
```

问题是从哪里去找通路数据库呢？似乎 [Plant Reactome](https://plantreactome.gramene.org/) 很不错的样子。

似乎可以用 `clusterProfiler::GSEA()` 函数：

##### 基因-词条关系图

```{r gsea-cnetplot, fig.height=6, fig.width=14}
brookite::enrich_cnetplot(gsea1$gsea, fold_change = gsea1$fc, show_category = 20) +
brookite::enrich_cnetplot(gsea2$gsea, fold_change = gsea2$fc, show_category = 20)
```

##### 词条之间关系图

```{r gsea-emapplot, fig.height=7, fig.width=7}
gsea1$gsea %>%
  enrichplot::pairwise_termsim() %>%
  enrichplot::emapplot(cex_label_category = 0.6)
```

##### 集合交集图

```{r gsea-upset, fig.height=7, fig.width=10}
gsea1$gsea %>%
  enrichplot::upsetplot()
```

##### 山丘图

```{r gsea-ridgetplot, fig.height=7, fig.width=14}
gsea1$gsea %>%
  enrichplot::ridgeplot()
```

##### GSEA 分数

```{r gsea-gseaplot}
gsea1$gsea %>%
  enrichplot::gseaplot(geneSetID = 3, title = gsea1$gsea$Description[3])
```

```{r gseaplot2, fig.height=7, fig.width=14}
gsea1$gsea %>%
  enrichplot::gseaplot2(geneSetID = 1:5)
```

```{r gsearank}
gsea1$gsea %>%
  enrichplot::gsearank(geneSetID = 3, title = gsea1$gsea$Description[3])
```

##### 生物主题比较

最新 devel 版的 {clusterProfiler} 和 {enrichplot} 支持 GSEA 版本的 `compareCluster` 了！

```{r 1dpi-gsea-compare-cluster, dev="png", fig.height=15, fig.width=10, fig.keep="last"}
comp_enr <- performDSCompareGSEA(ds_res$DESeq2,
  contrasts = c(
    "PNR2_1DPI" = "X1DPI.PNR2-X1DPI.MOCK",
    "TR4_1DPI" = "X1DPI.TR4-X1DPI.MOCK"
  ),
  clusters = c(
    "VCs_5" = "VCs_5",
    "MCs_5" = "MCs_5"
  ),
  simplify = TRUE
)

comp_enr@compareClusterResult$cluster <- factor(comp_enr@compareClusterResult$cluster, c("VCs_5", "MCs_5"))
enrichplot::dotplot(comp_enr, x = "contrast", showCategory = 40, label_format = 80) +
  ggplot2::facet_grid(~cluster) +
  ggplot2::theme(
      axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
```

```{r fig.height=7, fig.width=10}
comp_enr %>%
  enrichplot::pairwise_termsim() %>%
  enrichplot::emapplot(legend_n = 3, cex_line = 0.4)
```

```{r fig.height=10, fig.width=14}
comp_enr %>% enrichplot::cnetplot(
    showCategory = 20, cex_line = 0.2, cex_category = 3,
    node_label = "category"
  )
```

```{r fig.height=10, fig.width=16}
p <- comp_enr %>%
  enrichplot::pairwise_termsim() %>%
  enrichplot::treeplot(
    showCategory = 40, nCluster = 12,
    offset = 1.4, offset_tiplab = 1.8,
    label_format_cladelab = 5,
    geneClusterPanel = "dotplot", cex_category = 20, nWords = 0) +
  ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = c(0, 0), add = c(6, 0)))
p
```

### 1.2 其他注释的功能分析

比如 KEGG 或 [Plant Reactome](https://plantreactome.gramene.org/)

## 2 侵染早期（1DPI）差异状态基因的富集分析

### DA 分析中特别的亚群 VCs_3 和 Un_1

加载 1DPI 的 DA 亚群标志基因：

```{r}
da_1dpi_marker <- readRDS(Sys.glob("../output/da_marker_1dpi_*.rds"))
```

```{r}
make_DA_enrich <- function(da, contrast, subpopulation,
  ont = c("BP", "MF", "CC", "ALL"),
  simplify = TRUE
) {
  ont <- match.arg(ont)
  df <- da[[contrast]]$da.markers[[subpopulation]]

  enr <- df %>%
    dplyr::filter(p_value < 0.01) %>%
    dplyr::pull(gene) %>%
    clusterProfiler::enrichGO(
      orgdb, keyType = "GID",
      ont = ont
    )

  if (simplify && ont != "ALL")
  enr <- clusterProfiler::simplify(enr, cutoff = 0.5)

  enr
}

make_DA_compare <- function(da, sets,
  ont = c("BP", "MF", "CC", "ALL"),
  simplify = TRUE
) {
  stopifnot(is.list(sets) && !is.null(names(sets)) && length(sets) > 1)

  compare_list <- sets %>%
    lapply(function(set) {
      da[[ set[[1]] ]]$da.markers[[ set[[2]] ]] %>%
        dplyr::filter(p_value < 0.01) %>%
        dplyr::pull(gene)
    })

  comp_enr <- clusterProfiler::compareCluster(
    compare_list, fun = "enrichGO",
    OrgDb = orgdb, keyType = "GID",
    ont = ont)

  if (simplify && ont != "ALL")
    comp_enr <- clusterProfiler::simplify(comp_enr, cutoff = 0.5)

  comp_enr
}

PNR2_da2 <- da_1dpi_marker[["PNR2 vs. MOCK - 1DPI"]]$da.markers[[2]]
head(PNR2_da2)
```

#### PNR2 诱导的应激态亚群

由于 DA 亚群标志基因的 P value 都非常小，所以我们没法直接推断出背景。

```{r fig.height=6, fig.width=12}
p1 <- make_DA_enrich(da_1dpi_marker, "PNR2 vs. MOCK - 1DPI", 1, ont = "BP") %>%
  brookite::enrich_barplot(
    x = "Count", show_category = 20,
    title = "PNR2 induced DA1"
  )

p2 <- make_DA_enrich(da_1dpi_marker, "PNR2 vs. MOCK - 1DPI", 2, ont = "BP") %>%
  brookite::enrich_barplot(
    x = "Count", show_category = 20,
    title = "PNR2 induced DA2"
  )

p1 + p2
```

#### TR4 诱导的应激态亚群

```{r fig.height=6, fig.width=18}
p1 <- make_DA_enrich(da_1dpi_marker, "TR4 vs. MOCK - 1DPI", 1, ont = "BP") %>%
  brookite::enrich_barplot(
    x = "Count", show_category = 20,
    title = "TR4 induced DA1"
  )

p2 <- make_DA_enrich(da_1dpi_marker, "TR4 vs. MOCK - 1DPI", 3, ont = "BP") %>%
  brookite::enrich_barplot(
    x = "Count", show_category = 20,
    title = "TR4 induced DA3"
  )

p3 <- make_DA_enrich(da_1dpi_marker, "TR4 vs. MOCK - 1DPI", 4, ont = "BP") %>%
  brookite::enrich_barplot(
    x = "Count", show_category = 20,
    title = "TR4 induced DA4"
  )

p1 + p2 + p3
```

做一下主题比较：

```{r fig.height=12, fig.width=7, fig.keep="last"}
comp_enr <- make_DA_compare(da_1dpi_marker,
  list(
    "TR4 induced DA1" = list("TR4 vs. MOCK - 1DPI", 1),
    "TR4 induced DA3" = list("TR4 vs. MOCK - 1DPI", 3),
    "TR4 induced DA4" = list("TR4 vs. MOCK - 1DPI", 4)
  )
)

enrichplot::dotplot(comp_enr, showCategory = 20, by = "count", label_format = 60) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
```

```{r fig.height=7, fig.width=10}
comp_enr %>%
  enrichplot::pairwise_termsim() %>%
  enrichplot::emapplot(legend_n = 3)
```


#### PNR2 与 TR4 特征相反的亚群

##### ORA 分析

直接比较 PNR2 和 TR4 两个相反的亚群：

```{r fig.height=6, fig.width=12}
p1 <- make_DA_enrich(da_1dpi_marker, "PNR2 vs. MOCK - 1DPI", 2, ont = "BP") %>%
  brookite::enrich_barplot(
    x = "Count", show_category = 20,
    title = "PNR2 induced DA2"
  )

p2 <- make_DA_enrich(da_1dpi_marker, "TR4 vs. MOCK - 1DPI", 6, ont = "BP") %>%
  brookite::enrich_barplot(
    x = "Count", show_category = 20,
    title = "TR4 induced DA6"
  )

p1 + p2
```

这两个基因集做一下生物主题比较：

```{r fig.height=7, fig.width=6, fig.keep="last"}
comp_enr <- make_DA_compare(da_1dpi_marker,
  list(
    "PNR2 induced DA2" = list("PNR2 vs. MOCK - 1DPI", 2),
    "TR4 induced DA6" = list("TR4 vs. MOCK - 1DPI", 6)
  )
)

enrichplot::dotplot(comp_enr, showCategory = 20, by = "count", label_format = 60) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
```

```{r fig.height=7, fig.width=10}
comp_enr %>%
  enrichplot::pairwise_termsim() %>%
  enrichplot::emapplot(legend_n = 3)
```

##### GSEA 分析

好像 DA 亚群的特征基因做不了 GSEA 分析，因为这些 marker 都是筛选过的。

### DS 分析中显著的 MCs_5 和 VCs_5 细胞群集

#### ORA 分析

获取重叠部分的基因：

```{r}
diff_state_intersections <- function(ds) {
  sets_list <- ds$table %>%
    purrr::map(function(x) {
      purrr::map(x, "gene") %>%
        purrr::compact()
    })

  sets_metadata <- sets_list %>%
    purrr::imap(function(contrast, key) {
      cbind(
        sets = sprintf("%s [%s]", key, names(contrast)),
        contrast = key,
        cluster = names(contrast)
      )
    }) %>%
    do.call(rbind, .) %>%
    as.data.frame()

  sets_to_plot <- sets_list %>%
    unlist(recursive = FALSE)
  
  names(sets_to_plot) <- sets_metadata$sets

  bin <- sets_to_plot %>%
    rhapsodykit::from_list_to_upset()

  list(
    binary = bin,
    metadata = sets_metadata
  )
}

intersection_query <- function(itsc, contrasts, clusters) {
  sets_comb <- expand.grid(contrast = contrasts, cluster = clusters)
  sets <- apply(sets_comb, 1, function(x) {
    with(itsc$metadata,
      sets[contrast == x["contrast"] & cluster == x["cluster"]])
  })

  belongs <- apply(itsc$binary, 1, function(x) {
    all(x[sets] == 1) && sum(x) == length(sets)
  })

  names(belongs)[belongs]
}

itsc <- ds_res$DESeq2 %>%
  rhapsodykit::diff_state_significant() %>%
  rhapsodykit::diff_state_subset(
    contrast = c("X1DPI.PNR2-X1DPI.MOCK", "X1DPI.TR4-X1DPI.MOCK")
  ) %>%
  diff_state_intersections()

query_annotation <- function(genes, go_data) {
  dplyr::filter(go_data, Gene_ID %in% genes)
}

intersection_query(itsc,
  c("X1DPI.PNR2-X1DPI.MOCK", "X1DPI.TR4-X1DPI.MOCK"),
  c("VCs_5")
)
```

对这几十个基因做一下简单的富集：

```{r}
intersection_query(itsc,
  c("X1DPI.PNR2-X1DPI.MOCK", "X1DPI.TR4-X1DPI.MOCK"),
  c("VCs_5")
)
```

简单拉取一下注释，然后输出一张表格：

```{r}
mart_info <- list(
  host = "https://plants.ensembl.org",
  mart = "plants_mart",
  dataset = "taestivum_eg_gene"
)

intersection_query(itsc,
  c("X1DPI.PNR2-X1DPI.MOCK", "X1DPI.TR4-X1DPI.MOCK"),
  c("VCs_5")
) %>%
  brookite::pull_annotation(mart_info)
```

VCs_5 和 MCs_5 的生物主题比较：

![A nice plot.](`r knitr::fig_chunk('1dpi-ora-compare-cluster', 'png', 1)`)

#### GSEA 分析

前面已经做过了，这里就不复制代码了，直接引用图片就行了。

![A nice plot.](`r knitr::fig_chunk('1dpi-gsea-compare-cluster', 'png', 1)`)

## 3 侵染中期（2DPI）差异状态基因的富集分析

```{r}
ds_2dpi <- readRDS(Sys.glob("../output/ds_2dpi_*.rds"))
```

### ORA

```{r 2dpi-ora-compare-cluster, dev="png", fig.height=12, fig.width=8, fig.keep="last"}
comp_enr <- performDSCompareORA(ds_2dpi$DESeq2,
  contrasts = c(
    "PNR2_2DPI" = "X2DPI.PNR2-X2DPI.MOCK",
    "TR4_2DPI" = "X2DPI.TR4-X2DPI.MOCK"
  ),
  clusters = c(
    "VCs_5" = "VCs_5",
    "MCs_5" = "MCs_5"
  )
)

comp_enr@compareClusterResult$cluster <- factor(comp_enr@compareClusterResult$cluster, c("VCs_5", "MCs_5"))
enrichplot::dotplot(
    comp_enr, x = "contrast",
    showCategory = 40, by = "count", label_format = 60) +
  ggplot2::facet_grid(~cluster) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
```

```{r fig.height=8, fig.width=12}
p <- comp_enr %>%
  enrichplot::pairwise_termsim() %>%
  enrichplot::treeplot(
    showCategory = 40, nCluster = 9,
    offset = 2.3, offset_tiplab = 1.8,
    label_format_cladelab = 5,
    geneClusterPanel = "dotplot", cex_category = 6, nWords = 0) +
  ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = 0, add = 5.5))
p
```

### GSEA

```{r 2dpi-gsea-compare-cluster, dev="png", fig.height=15, fig.width=10, fig.keep="last"}
comp_enr <- performDSCompareGSEA(ds_2dpi$DESeq2,
  contrasts = c(
    "PNR2_2DPI" = "X2DPI.PNR2-X2DPI.MOCK",
    "TR4_2DPI" = "X2DPI.TR4-X2DPI.MOCK"
  ),
  clusters = c(
    "VCs_5" = "VCs_5",
    "MCs_5" = "MCs_5"
  ),
  simplify = TRUE
)

comp_enr@compareClusterResult$cluster <- factor(comp_enr@compareClusterResult$cluster, c("VCs_5", "MCs_5"))
enrichplot::dotplot(comp_enr, x = "contrast", showCategory = 40, label_format = 80) +
  ggplot2::facet_grid(~cluster) +
  ggplot2::theme(
      axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
```

```{r fig.height=10, fig.width=16}
p <- comp_enr %>%
  enrichplot::pairwise_termsim() %>%
  enrichplot::treeplot(
    showCategory = 40, nCluster = 10,
    offset = 2, offset_tiplab = 1.8,
    label_format_cladelab = 5,
    geneClusterPanel = "dotplot", cex_category = 20, nWords = 0) +
  ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = c(0, 0), add = c(6, 0)))
p
```

## 4 侵染后期（3DPI）差异状态基因

```{r}
ds_3dpi <- readRDS(Sys.glob("../output/ds_3dpi_*.rds"))
```

### ORA

```{r 3dpi-ora-compare-cluster, dev="png", fig.height=12, fig.width=8, fig.keep="last"}
comp_enr <- performDSCompareORA(ds_3dpi$DESeq2,
  contrasts = c(
    "PNR2_3DPI" = "X3DPI.PNR2-X3DPI.MOCK",
    "TR4_3DPI" = "X3DPI.TR4-X3DPI.MOCK"
  ),
  clusters = c(
    "VCs_5" = "VCs_5",
    "MCs_5" = "MCs_5"
  )
)

comp_enr@compareClusterResult$cluster <- factor(comp_enr@compareClusterResult$cluster, c("VCs_5", "MCs_5"))
enrichplot::dotplot(
    comp_enr, x = "contrast",
    showCategory = 40, by = "count", label_format = 60) +
  ggplot2::facet_grid(~cluster) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
```

```{r fig.height=8, fig.width=12}
p <- comp_enr %>%
  enrichplot::pairwise_termsim() %>%
  enrichplot::treeplot(
    showCategory = 40, nCluster = 7,
    offset = 2, offset_tiplab = 1.8,
    label_format_cladelab = 5,
    geneClusterPanel = "dotplot", cex_category = 6, nWords = 0) +
  ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = 0, add = 5.5))
p
```

### GSEA

```{r 3dpi-gsea-compare-cluster, dev="png", fig.height=15, fig.width=10, fig.keep="last"}
comp_enr <- performDSCompareGSEA(ds_3dpi$DESeq2,
  contrasts = c(
    "PNR2_3DPI" = "X3DPI.PNR2-X3DPI.MOCK",
    "TR4_3DPI" = "X3DPI.TR4-X3DPI.MOCK"
  ),
  clusters = c(
    "VCs_5" = "VCs_5",
    "MCs_5" = "MCs_5"
  ),
  simplify = TRUE
)

comp_enr@compareClusterResult$cluster <- factor(comp_enr@compareClusterResult$cluster, c("VCs_5", "MCs_5"))
enrichplot::dotplot(comp_enr, x = "contrast", showCategory = 40, label_format = 80) +
  ggplot2::facet_grid(~cluster) +
  ggplot2::theme(
      axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
```

```{r fig.height=10, fig.width=16}
p <- comp_enr %>%
  enrichplot::pairwise_termsim() %>%
  enrichplot::treeplot(
    showCategory = 40, nCluster = 11,
    offset = 2, offset_tiplab = 1.8,
    label_format_cladelab = 5,
    geneClusterPanel = "dotplot", cex_category = 20, nWords = 0) +
  ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = c(0, 0), add = c(7, 0)))
p
```

## 3 给定基因集的表达异质性分析