---
title: "Figure 6 Pathogen-responsive cells"
author: "Altair Wei"
date: "2023-11-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(magrittr)
library(ggtree, include.only = "%<+%")
source("../scripts/LoadUtils.R", chdir = TRUE)

options(ggrastr.default.dpi=300)
PT = 1/2.13
FT = 6/17.1
```

## Load Data Objects

### Seurat Objects

#### MOCK samples

```{r}
obj_mock <- readRDS(Sys.glob("../results/ObjectCache/IntegrationAndAnnotation/obj_mock_annotated_*.rds"))
sce_mock <- Seurat::as.SingleCellExperiment(obj_mock, assay = "RNA")
sce_mock <- muscat::prepSCE(sce_mock,
  kid = "ident", # subpopulation assignments
  gid = "group", # group IDs (ctrl/stim)
  sid = "sample", # sample IDs (ctrl/stim.1234)
  drop = FALSE
)
```

```{r}
mock_celltypes <- c(
  "Gu", "Ep_α", "Ep_β",
  "Me_α", "Me_β", "Me_ε", "Me_γ", "Va_δ", "Me_δ",
  "Va_β", "BS", "CC", "MPV", "Va_α", "Va_γ")

mock_celltype_colors <- ggthemes::tableau_color_pal("Tableau 20")(length(mock_celltypes))
names(mock_celltype_colors) <- mock_celltypes
```

```{r}
mock_body_layers <- c(
  "Gu"   = "L1",
  "Ep_α" = "L1",
  "Ep_β" = "L1",
  "Me_α" = "L2",
  "Me_β" = "L2",
  "Me_γ" = "L2",
  "Me_δ" = "L2",
  "Me_ε" = "L2",
  "BS"   = "L3",
  "CC"   = "L3",
  "Va_α" = "L3",
  "Va_β" = "L3",
  "Va_γ" = "L3",
  "Va_δ" = "L3",
  "MPV"  = "L3"
)
```

```{r}
sce_mock$cluster_id <- forcats::fct_relevel(sce_mock$cluster_id, mock_celltypes)
sce_mock$body_layer <- do.call(
  dplyr::recode, c(list(.x = sce_mock$cluster_id), as.list(mock_body_layers)))
Seurat::Idents(obj_mock) <- forcats::fct_relevel(Seurat::Idents(obj_mock), mock_celltypes)
```

#### All samples

```{r}
obj <- readRDS(Sys.glob("../results/ObjectCache/IntegrationAndAnnotation/obj_annotated_*.rds"))
sce <- Seurat::as.SingleCellExperiment(obj, assay = "RNA")
sce <- muscat::prepSCE(sce,
  kid = "ident", # subpopulation assignments
  gid = "group", # group IDs (ctrl/stim)
  sid = "sample", # sample IDs (ctrl/stim.1234)
  drop = FALSE
)
```

```{r}
all_celltypes <- c(
   "Gu", "Ep_1", "Ep_2",
  "Me_1", "Me_2", "Me_3", "Me_4", "Me_5", "Me_6",
  "Va_1", "Va_2", "Va_3", "Va_4",
  "BS", "CC", "MPV_1", "MPV_2")

all_celltype_colors <- ggthemes::tableau_color_pal("Tableau 20")(length(all_celltypes))
names(all_celltype_colors) <- all_celltypes
```

```{r}
all_body_layers <- c(
  "Gu"    = "L1",
  "Ep_1"  = "L1",
  "Ep_2"  = "L1",
  "Me_1"  = "L2",
  "Me_2"  = "L2",
  "Me_3"  = "L2",
  "Me_4"  = "L2",
  "Me_5"  = "L2",
  "Me_6"  = "L2",
  "Va_1"  = "L2",
  "Va_2"  = "L2",
  "Va_3"  = "L2",
  "Va_4"  = "L2",
  "BS"    = "L3",
  "CC"    = "L3",
  "MPV_1" = "L3",
  "MPV_2" = "L3"
)

all_tissues <- c(
  Gu   = "Stomata",
  Ep_1 = "Epidermis",
  Ep_2 = "Epidermis",
  Me_1 = "Chlorenchyma",
  Me_2 = "Chlorenchyma",
  Me_3 = "Chlorenchyma",
  Me_4 = "Parenchyma",
  Me_5 = "Parenchyma",
  Me_6 = "Parenchyma",
  Va_1 = "Chlorenchyma",
  Va_2 = "Outer sheath",
  Va_3 = "Outer sheath",
  Va_4 = "Outer sheath",
  BS = "Inner sheath",
  CC = "Phloem",
  MPV_1 = "Procambium",
  MPV_2 = "Procambium"
)

all_tissues_colors <- structure(
  names = c("Stomata",      "Epidermis",    "Chlorenchyma", "Parenchyma",
            "Outer sheath", "Inner sheath", "Phloem",       "Procambium"),
  .Data = c("#4e79a7",      "#f28e2b",      "#8cd17d",      "#b6992d",
            "#86bcb6",      "#e15759",      "#ff9d9a",      "#79706e")
)


obj$tissue <- do.call(
  dplyr::recode, c(list(.x = Seurat::Idents(obj)), as.list(all_tissues)))
```

```{r}
sce$cluster_id <- forcats::fct_relevel(sce$cluster_id, all_celltypes)
Seurat::Idents(obj) <- forcats::fct_relevel(Seurat::Idents(obj), all_celltypes)
sce$body_layer <- do.call(
  dplyr::recode, c(list(.x = sce$cluster_id), as.list(all_body_layers)))
sce$tissue <- do.call(
  dplyr::recode, c(list(.x = sce$cluster_id), as.list(all_tissues)))
```

```{r}
all_cluster_num <- data.frame(
    names = as.character(Seurat::Idents(obj)),
    values = as.character(obj$RNA_snn_res.0.6)) |>
  dplyr::distinct() |>
  tibble::deframe()

all_cluster_num
```

### DS Results

```{r}
logfc_data <- readRDS(Sys.glob(
  "../results/ObjectCache/DifferentialState/ds_deg_logfc_data_*.rds"))

ds_res <- readRDS(Sys.glob("../results/ObjectCache/DifferentialState/ds_res_*.rds"))

ds_sig <- ds_res$DESeq2 %>%
  rhapsodykit::diff_state_significant(fdr_limit = 0.05, logfc_limit = 0)
```

### Pseudobulk CPM

```{r}
pseudobulk_cpm_mean <- readRDS(Sys.glob(
  "../results/ObjectCache/Pseudobulk/pseudobulk_cpm_mean_*.rds"))
```

```{r}
cpm_se <- local({
  cpm_df <- as.data.frame(pseudobulk_cpm_mean) |>
      tibble::rownames_to_column("Gene") |>
      tidyr::pivot_longer(-Gene, names_to = "bulk", values_to = "cpm") |>
      tidyr::separate(bulk, sep = "\\.", into = c("treatment", "time", "cellType"))
  
  cpm_df_0 <- dplyr::filter(cpm_df, time == "0DPI")
  
  cpm_df <- cpm_df |>
    dplyr::add_row(dplyr::mutate(cpm_df_0, treatment = "PNR2")) |>
    dplyr::add_row(dplyr::mutate(cpm_df_0, treatment = "TR4"))
  
  cpm_df$cellType <- factor(cpm_df$cellType, levels = TISSUE_TYPES)
  cpm_df$treatment <- factor(cpm_df$treatment, levels = c("MOCK", "PNR2", "TR4"))
  cpm_df$time <- factor(cpm_df$time, levels = c("0DPI", "1DPI", "2DPI", "3DPI"))
  
  cpm_df <- cpm_df |>
    dplyr::select(cellType, treatment, time, Gene, cpm) |>
    dplyr::arrange(cellType, treatment, time)
  
  cpm_coldata <- cpm_df |>
    dplyr::group_by(cellType, treatment, time) |>
    dplyr::summarise(.groups = "drop")
  
  cpm_mtx <- cpm_df |>
    tidyr::pivot_wider(names_from = c(cellType, treatment, time),
                       values_from = cpm, names_sep = "#") |>
    tibble::column_to_rownames("Gene") |>
    as.matrix()
  
  SummarizedExperiment(
    assays = list(
      raw = cpm_mtx,
      scaled = t(scale(t(cpm_mtx)))),
    colData = cpm_coldata)
})
```

## Figure 6 Pathogen-responsive cells

```{r}
sce_os_all <- readRDS(Sys.glob("../results/ObjectCache/TrajectoryInference/sce_all_slingshot_os_all_*.rds"))
```

### Trajectory Inference

```{r fig.height=7, fig.width=9}
p1 <- local({
  plotSlingshotCurveOnReduc(sce_os_all, dimred = "PHATE",
                      linewidth = 1, point_size = 0.5, rasterise = TRUE,
                      lineage_label_size = 20 * FT, point_alpha = 1,
                      lineage_rename = c("Lineage1" = "Branch 1",
                                         "Lineage2" = "Branch 2",
                                         "Lineage3" = "Branch 3")) +
    ggplot2::coord_fixed() +
    ggplot2::labs(x = "PHATE_1", y = "PHATE_2") +
    ggplot2::guides(color = ggplot2::guide_colorbar(
      title = "Pseudotime", title.position = "top")) +
    cowplot::theme_cowplot(font_size = 22, font_family = "Arial") +
    theme_dimred(linesize = 1.5 * PT) +
    ggplot2::theme(
      axis.title = ggplot2::element_text(size = 22),
      plot.title = ggplot2::element_text(size = 22, face = "plain", hjust = 0.5),
      legend.title = ggplot2::element_text(size = 20),
      legend.text = ggplot2::element_text(size = 18),
      legend.key.width = grid::unit(1.2, "cm"),
      legend.key.height = grid::unit(0.7, "cm"),
      legend.direction = "horizontal",
      legend.title.align = 0.5,
      legend.position = c(0.55, 0))
})

p1
```

### Differential Abundance v1

```{r}
da_os_all_pnr2 <- rhapsodykit::findDiffAbundantCells(
  subset(obj, cells = colnames(sce_os_all)),
  stim = paste(1:3, "DPI-PNR2", sep = ""),
  ctrl = paste(0:3, "DPI-MOCK", sep = ""),
  reduction = "harmony", npc = 30,
  k.vector = seq(50, 1000, 50)
)

da_os_all_tr4 <- rhapsodykit::findDiffAbundantCells(
  subset(obj, cells = colnames(sce_os_all)),
  stim = paste(1:3, "DPI-TR4", sep = ""),
  ctrl = paste(0:3, "DPI-MOCK", sep = ""),
  reduction = "harmony", npc = 30,
  k.vector = seq(50, 1000, 50)
)
```

试试先把 NA 排到地步，然后再随机排布红蓝色。

```{r fig.height=7, fig.width=11.3}
p2 <- local({
  df_phate <- reducedDim(sce_os_all, "PHATE") |>
    as.data.frame() |>
    tibble::rownames_to_column("cell")

  plist <- purrr::imap(
    .x = list(
      "PNR2 vs. MOCK" = da_os_all_pnr2,
      "TR4 vs. MOCK" = da_os_all_tr4),
    .f = function(da_os_all, index) {
      da_df <- data.frame(
        cell = rownames(da_os_all$embeddings$pca),
        score = da_os_all$cells$da.pred)

      df_to_plot <- dplyr::left_join(df_phate, da_df) |>
        dplyr::arrange(!is.na(score), abs(score))

      p <-  ggplot2::ggplot(df_to_plot) +
        ggplot2::geom_point(
          mapping = ggplot2::aes(x = PHATE1, y = PHATE2, col = score),
          size = 0.5) +
        ggplot2::scale_color_gradientn(colours = c("blue", "white", "red"))

      p <- ggrastr::rasterise(p)

      p <- p +
          ggplot2::coord_fixed() +
          ggplot2::labs(x = "PHATE_1", y = "PHATE_2") +
          ggplot2::ggtitle(index) +
          ggplot2::guides(color = ggplot2::guide_colorbar(
            title = "DA Score", title.position = "top")) +
          cowplot::theme_cowplot(font_size = 22, font_family = "Arial") +
          theme_dimred(linesize = 1.5 * PT) +
          ggplot2::theme(
            axis.title = ggplot2::element_text(size = 22),
            plot.title = ggplot2::element_text(size = 22, face = "plain", hjust = 0.5, margin = ggplot2::margin()),
            legend.title = ggplot2::element_text(size = 20),
            legend.text = ggplot2::element_text(size = 18),
            legend.key.width = grid::unit(1.2, "cm"),
            legend.key.height = grid::unit(0.7, "cm"),
            legend.direction = "horizontal",
            legend.title.align = 0.5,
            legend.position = c(0.55, 0))

      p
      
    })

  plist
})

patchwork::wrap_plots(p2)
```

```{r fig.height=7, fig.width=20.9}
(p12 <- patchwork::wrap_plots(p1, p2[[1]] + p2[[2]], widths = c(1, 2)) &
   ggplot2::theme(plot.margin = ggplot2::margin(1, 2, 2, 2)))
```

```{r eval=FALSE, include=FALSE}
plotpowerpoint(p12, "../data/Figure.pptx",
  location = grid::unit(c(2.5, 4.49, 49.01, 16.34), "cm"),
  fonts = list(sans = "Arial", serif = "Arial", mono = "Courier"))
```

### Differential Abundance v2

```{r}
da_os_all <- rhapsodykit::findDiffAbundantCells(
  subset(obj, cells = colnames(sce_os_all)),
  stim = paste(1:3, "DPI-PNR2", sep = ""),
  ctrl = paste(1:3, "DPI-TR4", sep = ""),
  reduction = "harmony", npc = 30,
  k.vector = seq(50, 1000, 50)
)
```

```{r fig.height=7, fig.width=8.9}
p2 <- local({
  df_to_plot <- reducedDim(sce_os_all, "PHATE") |>
    as.data.frame() |>
    tibble::rownames_to_column("cell")

  da_df <- data.frame(
    cell = rownames(da_os_all$embeddings$pca),
    score = da_os_all$cells$da.pred)

  df_to_plot <- dplyr::left_join(df_to_plot, da_df) |>
    dplyr::arrange(!is.na(score), abs(score))

  p <-  ggplot2::ggplot(df_to_plot) +
    ggplot2::geom_point(
      mapping = ggplot2::aes(x = PHATE1, y = PHATE2, col = score),
      size = 0.5) +
    ggplot2::scale_color_gradientn(colours = c("blue", "white", "red"))

  p <- ggrastr::rasterise(p)

  p <- p +
      ggplot2::coord_fixed() +
      ggplot2::ggtitle("PNR2 vs. TR4") +
      ggplot2::labs(x = "PHATE_1", y = "PHATE_2") +
      ggplot2::guides(color = ggplot2::guide_colorbar(
        title = "DA Score", title.position = "top")) +
      cowplot::theme_cowplot(font_size = 22, font_family = "Arial") +
      theme_dimred(linesize = 1.5 * PT) +
      ggplot2::theme(
        axis.title = ggplot2::element_text(size = 22),
        plot.title = ggplot2::element_text(size = 22, face = "plain", hjust = 0.5),
        legend.title = ggplot2::element_text(size = 20),
        legend.text = ggplot2::element_text(size = 18),
        legend.key.width = grid::unit(1.2, "cm"),
        legend.key.height = grid::unit(0.7, "cm"),
        legend.direction = "horizontal",
        legend.title.align = 0.5,
        legend.position = c(0.55, 0))

  p
})

p1
```

### Gene Dynamic Expression

```{r}
tradeSce_os_all <- readRDS(Sys.glob(
  "../results/ObjectCache/TrajectoryInference/tradeseq_gam_os_all_*.rds"))

patternRes_os_all <- readRDS(Sys.glob(
  "../results/ObjectCache/TrajectoryInference/tradeseq_patternRes_os_all_*.rds"))
```

```{r}
yhatkm <- local({
  patternRes_df <- patternRes_os_all |>
    tibble::rownames_to_column("gene") |>
    dplyr::mutate(fdr = p.adjust(pvalue, "fdr"))

  patternGenes <- patternRes_df |>
    dplyr::filter(fdr <= 0.01) |>
    dplyr::pull(gene) |>
    unique()

  yhatSmooth <- tradeSeq::predictSmooth(tradeSce_os_all, gene = patternGenes, nPoints = 100, tidy = FALSE)
  yhatSmoothScaled <- t(scale(t(yhatSmooth)))

  set.seed(1124)
  fit_km <- kmeans(yhatSmoothScaled, 6, nstart = 25)

  avgtime <- split(
    x = as.data.frame(t(fit_km$centers)),
    f = stringr::str_match(
      colnames(fit_km$centers), "(lineage\\d)_")[, 2]) |>
  vapply(
    FUN.VALUE = numeric(nrow(fit_km$centers)),
    FUN = function(df) apply(df, 2, which.max)) |>
  base::rowMeans()

  row_split <- factor(
    x = paste0("G", fit_km$cluster),
    levels = paste0("G", names(sort(avgtime))))
  
  list(
    mtx = yhatSmoothScaled,
    km = fit_km,
    cluster = row_split
  )
})
```

```{r}
p4fun <- local({
  row_split <- yhatkm$cluster
  mtx <- yhatkm$mtx
  palette <- colorRamps::matlab.like

  # Calculate color bar
  mtx_uni <- unique(mtx)
  if (length(mtx_uni) < 100)
    q <- max(abs(mtx))
  else
    q <- stats::quantile(abs(mtx), probs = .99)

  bks <- seq(-q, q, length.out = 9)
  col_fun <- circlize::colorRamp2(
    breaks = bks,
    colors = palette(length(bks))
  )

  ph_res <- ComplexHeatmap::Heatmap(
    mtx,

    # Remove name from fill legend
    use_raster = TRUE,

    # Keep original row/col order
    column_order = colnames(mtx),
    col = col_fun,

    cluster_rows = TRUE,
    show_row_names = FALSE,
    row_split = row_split,
    row_title_rot = 0,
    show_row_dend = FALSE,
    cluster_row_slices = FALSE,
    row_title_gp = grid::gpar(fontsize = 20, fontfamily = "Arial"),

    cluster_columns = FALSE,
    show_column_names = FALSE,
    show_column_dend = FALSE,
    column_split = stringr::str_match(
      colnames(mtx), "(lineage\\d)_")[, 2],
    column_title = paste("Branch", 1:3),
    column_title_gp = grid::gpar(fontsize = 20, fontfamily = "Arial"),

    heatmap_legend_param = list(
      title = "Gene Expression",
      legend_direction = "horizontal",
      legend_width = grid::unit(7, "cm"),
      title_position = "topcenter",
      title_gp = grid::gpar(fontsize = 20,fontfamily = "Arial"),
      labels_gp = grid::gpar(fontsize = 16, fontfamily = "Arial")
    )
  )

  function(...) {
    suppressWarnings(
      ComplexHeatmap::draw(
        ph_res, heatmap_legend_side = "bottom",
        align_heatmap_legend = "heatmap_left",
        legend_gap = grid::unit(1.5, "cm"),
        ...)
    )
  }
})

p4 <- p4fun()
```

```{r eval=FALSE, include=FALSE}
plotpowerpoint(p4, "../data/Figure.pptx", fun = p4fun,
  location = grid::unit(c(2.5, 21.87, 25.39, 15.65), "cm"),
  fonts = list(sans = "Arial", serif = "Arial", mono = "Courier"))
```

```{r}
local({
  genedf <- data.frame(
    cluster = yhatkm$cluster,
    gene = names(yhatkm$km$cluster)
  )

  exprdf <- yhatkm$mtx |>
    as.data.frame() |>
    tibble::rownames_to_column("gene") |>
    tidyr::pivot_longer(cols = !gene,
                        names_pattern = "(lineage\\d+)_(\\d+)",
                        names_to = c("lineage", "pseudotime"),
                        values_to = "expression") |>
    dplyr::mutate(pseudotime = as.numeric(pseudotime))

  df_to_plot <- dplyr::left_join(exprdf, genedf, by = "gene") |>
    dplyr::select(gene, cluster, dplyr::everything()) |>
    dplyr::mutate(group = paste(gene, lineage))

  df_to_plot |>
    dplyr::sample_frac() |>
    ggplot2::ggplot(ggplot2::aes(
      x = pseudotime, y = expression)) +
    ggplot2::geom_line(
      mapping = ggplot2::aes(
        group = group, color = lineage)) +
    ggplot2::facet_wrap(~ cluster, scales = "free_y")
})
```

### Enrichment of Gene Cluster

```{r}
p5data <- local({
  gene_list <- split(names(yhatkm$km$cluster), paste0("G", yhatkm$km$cluster))
  gene_list <- gene_list[levels(yhatkm$cluster)]

  clusterProfiler::compareCluster(
      gene_list,
      fun = "enrichGO",
      OrgDb = "org.Taestivum.iwgsc.db",
      keyType = "GID",
      ont = "BP",
      universe = rownames(tradeSce_os_all))
})
```

```{r eval = FALSE}
p <- p5data |>
  enrichplot::pairwise_termsim(
    showCategory = NULL) |>
  enrichplot::treeplot(
    showCategory = NULL,
    size = "count",
    clusterPanel.params = list(
      clusterPanel = "dotplot"),
    cluster.params = list(
      n = 12, label_words_n = 0, label_format = 5),
    offset.params = list(bar_tree = 60, tiplab = 32),
    hilight.params = list()) +
  ggplot2::scale_y_continuous(
    expand = ggplot2::expansion(mult = c(0, 0), add = c(15, 0))) +
  NULL

plotpowerpoint(
  ggobj = p,
  file = "../results/DataPlots/outersheath_pseudotime_deg.pptx",
  template = "../data/60x120.pptx")
```

```{r}
# Get representive GO terms
reprterms <- p5data |>
  as.data.frame() |>
  dplyr::select(Description, ID) |>
  dplyr::distinct() |>
  tibble::deframe()

reprterms <- reprterms[
  extractMarkedTerms("../results/DataPlots/outersheath_pseudotime_deg.pptx")]

p5data |>
  dplyr::filter(ID %in% reprterms) |>
  printCompareORATable()
```

```{r fig.height=7, fig.width=10.4}
(p5 <- p5data |>
  dplyr::filter(ID %in% reprterms) |>
  enrichplot::dotplot(
    showCategory = 6,
    by = "count", label_format = 50) +
   ggplot2::ggtitle("Top GO biological process") +
   ggplot2::xlab("Gene Cluster") +
   ggplot2::theme(plot.title = ggplot2::element_text(size = 20, hjust = 0.22),
                  plot.title.position = "plot",
                  axis.title = ggplot2::element_text(size = 20),
                  axis.text.x = ggplot2::element_text(size = 16),
                  axis.text.y = ggplot2::element_text(size = 16),
                  legend.title = ggplot2::element_text(size = 18),
                  legend.text = ggplot2::element_text(size = 16),
                  legend.background = ggplot2::element_blank(),
                  axis.ticks = ggplot2::element_line(linewidth = 1.5 * PT),
                  panel.border = ggplot2::element_rect(linewidth = 1.5 * PT))
)
```

```{r eval=FALSE, include=FALSE}
plotpowerpoint(p5, "../data/Figure.pptx",
  location = grid::unit(c(28.21, 21.87, 23.29, 15.65), "cm"),
  fonts = list(sans = "Arial", serif = "Arial", mono = "Courier"))
```

### Selected Gene Dynamics

Plot Z-score expression directly:

```{r fig.height=7, fig.width=4}
p6 <- local({
  genedf <- data.frame(
    cluster = yhatkm$cluster,
    gene = names(yhatkm$km$cluster)
  )

  exprdf <- yhatkm$mtx |>
    as.data.frame() |>
    tibble::rownames_to_column("gene") |>
    tidyr::pivot_longer(cols = !gene,
                        names_pattern = "lineage(\\d+)_(\\d+)",
                        names_to = c("lineage", "pseudotime"),
                        values_to = "expression") |>
    dplyr::mutate(pseudotime = as.numeric(pseudotime),
                  lineage = paste("Branch", lineage))

  df_to_plot <- dplyr::left_join(exprdf, genedf, by = "gene") |>
    dplyr::select(gene, cluster, dplyr::everything()) |>
    dplyr::mutate(group = paste(gene, lineage))

  selected <- c(
    "TraesCS7D02G161200" = "TaPR1-79",
    "TraesCS7B02G417700" = "TaTLP14-B5",
    "TraesCS5D02G487900" = "TaCYP71F53",
    "TraesCS5B02G148300" = "TaUGT12887"
  )

  df_to_plot |>
    dplyr::filter(gene %in% names(selected)) |>
    dplyr::mutate(name = factor(selected[gene], levels = selected)) |>
    ggplot2::ggplot(ggplot2::aes(
      x = pseudotime, y = expression)) +
    ggplot2::geom_line(
      mapping = ggplot2::aes(
        group = group, color = lineage),
      linewidth = 1.5) +
    ggplot2::scale_color_manual(values = c(
      "Branch 1" = "#FF7F0E", "Branch 2" = "#1F77B4", "Branch 3" = "#2CA02C")) +
    ggplot2::facet_wrap(~ name, ncol = 1, scales = "free_y") +
    ggplot2::labs(x = "Pseudotime", y = "Normalized Expression", color = "Branch") +
    ggplot2::theme_bw(base_size = 22) +
    ggplot2::theme(
      panel.grid = ggplot2::element_blank(),
      strip.text = ggplot2::element_text(
        size = 16, vjust = 0.2, face = "italic",
        margin = ggplot2::margin(t = 4, b = 4)),
      axis.text.x = ggplot2::element_text(
        size = 16, angle = 0, hjust = 0.5, vjust = 0.5, color = "black"),
      axis.text.y = ggplot2::element_text(size = 16, color = "black"),
      axis.ticks = ggplot2::element_line(linewidth = 1.5 * PT),
      strip.background = ggplot2::element_rect(linewidth = 1.5 * PT),
      panel.border = ggplot2::element_rect(linewidth = 1.5 * PT),
      legend.position = c(0.25, 0.94),
      legend.background = ggplot2::element_blank(),
      legend.title = ggplot2::element_blank())
})

p6
```

```{r eval=FALSE, include=FALSE}
plotpowerpoint(p6, "../data/Figure.pptx",
  location = grid::unit(c(2.91, 38.17, 10.74, 18.91), "cm"),
  fonts = list(sans = "Arial", serif = "Arial", mono = "Courier"))
```

### ISH Gene Expression

```{r fig.height=7, fig.width=7}
p7 <- local({
  scater::plotReducedDim(
      sce_os_all, "PHATE",
      colour_by = "TraesCS3D02G305300",
      order_by = "TraesCS3D02G305300",
      point_alpha = 1, point_size = 0.5,
      rasterise = TRUE) +
    ggplot2::scale_color_gradient(low = "grey", high = "blue") +
    ggplot2::coord_fixed() +
    ggplot2::ggtitle("TraesCS3D02G305300") +
    ggplot2::labs(x = "PHATE_1", y = "PHATE_2") +
    ggplot2::guides(color = ggplot2::guide_colorbar(
      title = "Expression Level", title.position = "top")) +
    cowplot::theme_cowplot(font_size = 22, font_family = "Arial") +
    theme_dimred(linesize = 1.5 * PT) +
    ggplot2::theme(
      axis.title = ggplot2::element_text(size = 22),
      plot.title = ggplot2::element_text(size = 22, face = "plain", hjust = 0.5),
      legend.title = ggplot2::element_text(size = 20),
      legend.text = ggplot2::element_text(size = 18),
      legend.key.width = grid::unit(1.2, "cm"),
      legend.key.height = grid::unit(0.7, "cm"),
      legend.direction = "horizontal",
      legend.title.align = 0.5,
      legend.position = c(0.55, 0))
})

p7
```

```{r eval=FALSE, include=FALSE}
plotpowerpoint(p7, "../data/Figure.pptx",
  location = grid::unit(c(13.95, 38.17, 18.79, 18.91), "cm"),
  fonts = list(sans = "Arial", serif = "Arial", mono = "Courier"))
```

## SuppFigure 7 Cell-level Analysis

### PAGA Connectivity

```{r}
p1_adata <- runPAGA(
  sce, group_key = "RNA_snn_res.0.6",
  assay.X = "logcounts", use.dimred = "HARMONY"
)

p1_adata$obs$tissue <- sce$tissue


p1_adata$obsm$update(list(
  X_umap = reducedDim(sce, "UMAP")
))
```

```{r fig.height=7, fig.width=7}
p1 <- local({
  adata <- p1_adata
  basis <- "umap"
  threshold <- 0
  colour_by <- "group"
  edge_cex = 6
  node_cex = 4

  paga <- createPagaObject(adata, basis = basis)
  
  # Inspired by https://romanhaa.github.io/blog/paga_to_r/
  paga_edges <- tibble::tibble(
    group1 = rownames(paga$connectivities)[row(paga$connectivities)[upper.tri(paga$connectivities)]],
    group2 = colnames(paga$connectivities)[col(paga$connectivities)[upper.tri(paga$connectivities)]],
    weight = paga$connectivities[upper.tri(paga$connectivities)]
  ) %>%
    dplyr::mutate(
      x1 = paga$position$x[match(.$group1, rownames(paga$position))],
      y1 = paga$position$y[match(.$group1, rownames(paga$position))],
      x2 = paga$position$x[match(.$group2, rownames(paga$position))],
      y2 = paga$position$y[match(.$group2, rownames(paga$position))]
    )

  paga_edges_sig <- dplyr::filter(paga_edges, weight >= threshold)
  paga_edges_und <- dplyr::filter(paga_edges, weight < threshold)

  paga$embeddings[["tissue"]] <- adata$obs[["tissue"]]
  paga$position[["tissue"]] <- all_tissues[names(all_cluster_num)[
    match(paga$position$group, all_cluster_num)]]
  
  p <- ggplot2::ggplot(
      paga$position, ggplot2::aes(x, y))
  
  # Cell Points
  p <- p +
    ggplot2::geom_point(
      data = paga$embeddings,
      mapping = ggplot2::aes_string(
        x = "Dim_1", y = "Dim_2", color = "tissue"),
      shape = 19,
      alpha = 0.1,
      show.legend = FALSE) +
    ggplot2::scale_color_manual(values = all_tissues_colors)

  # Connections
  p <- p +
    ggplot2::geom_segment(
      data = paga_edges_und,
      mapping = ggplot2::aes(
        x = x1, y = y1, xend = x2, yend = y2),
      linetype = "dashed",
      color = "grey",
      linewidth = paga_edges_und$weight*edge_cex,
      show.legend = FALSE
    ) +
    ggplot2::geom_segment(
      data = paga_edges_sig,
      mapping = ggplot2::aes(
        x = x1, y = y1, xend = x2, yend = y2),
      linetype = "solid",
      color = "black",
      linewidth = paga_edges_sig$weight*edge_cex,
      show.legend = FALSE
    ) +
    ggplot2::geom_point(
      ggplot2::aes(fill = tissue), shape = 21,
      size = 3*node_cex, alpha = 1, show.legend = FALSE) +
    ggplot2::scale_fill_manual(values = all_tissues_colors) +
    ggplot2::geom_text(ggplot2::aes(label = group),
                             color = "black", size = 16 * FT) +
    ggplot2::coord_fixed() +
    ggplot2::labs(x = "UMAP_1", y = "UMAP_2", fill = "Cell Types") +
    ggplot2::guides(
      color = "none", fill = ggplot2::guide_legend(override.aes = list(size = 6))) +
    cowplot::theme_cowplot(font_size = 22, font_family = "Arial") +
    theme_dimred(linesize = 1.5 * PT) +
    ggplot2::theme(
      axis.title = ggplot2::element_text(size = 22),
      legend.text = ggplot2::element_text(size = 18))

  ggrastr::rasterise(p)
})

p1
```

### RNA Velocity

```{r}
scv <- reticulate::import("scvelo")
plt <- reticulate::import("matplotlib.pyplot")
```

```{r}
adata_all_mock <- readPickle(Sys.glob(
  "../results/ObjectCache/TrajectoryInference/unitvelo_adata_mock_*.pickle"))
adata_all_pnr2 <- readPickle(Sys.glob(
  "../results/ObjectCache/TrajectoryInference/unitvelo_adata_pnr2_*.pickle"))
adata_all_tr4 <- readPickle(Sys.glob(
  "../results/ObjectCache/TrajectoryInference/unitvelo_adata_tr4_*.pickle"))
```

```{r}
sce_sub_list <- lapply(
  X = list(
    MOCK = adata_all_mock,
    PNR2 = adata_all_pnr2,
    TR4  = adata_all_tr4),
  FUN = function(adata) {
    sce_sub <- sce[, adata$obs_names$to_list()]
    adata$obsm$update(list(X_umap = reducedDim(sce_sub, "UMAP")))
    scv$tl$velocity_embedding(adata, basis = "umap")
    reducedDim(sce_sub, "velocity_umap") <- adata$obsm["velocity_umap"]
    sce_sub
  })
```

```{r fig.height=8, fig.width=14}
plist <- purrr::imap(sce_sub_list, function(sce_sub, name) {
  colnames(reducedDim(sce_sub, "UMAP")) <- NULL
  vector_df <- velociraptor::gridVectors(
      reducedDim(sce_sub, "UMAP"),
      reducedDim(sce_sub, "velocity_umap"),
      resolution = 30)
  p <- scater::plotReducedDim(
      sce_sub,
      colour_by = "tissue",
      dimred = "UMAP",
      point_size = 0.8,
      point_alpha = 1,
      theme_size = 22) +
    ggplot2::scale_color_manual(values = all_tissues_colors) +
    ggplot2::geom_segment(
      data = vector_df,
      mapping = ggplot2::aes_string(
        x = "start.1",
        y = "start.2", 
        xend = "end.1",
        yend = "end.2"),
      arrow = grid::arrow(
        length = grid::unit(0.06, "inches"),
        angle = 25,
        type = "open"),
      size = 0.5) +
    ggplot2::coord_fixed() +
    ggplot2::ggtitle(name) +
    center_plot_title(face = "plain") +
    theme_dimred(linesize = 1.5 * PT) +
    remove_legend()
  ggrastr::rasterise(p)
})

(p2 <- patchwork::wrap_plots(plist))
```

```{r fig.height=7, fig.width=20}
(p12 <- p1 + p2 + patchwork::plot_layout(width = c(1, 2)))
```

### Outer Sheath Prediction

```{r}
df <- colData(sce)[, c("prediction.score.Va_β", "prediction.score.max",
                       "cluster_id", "RNA_snn_res.0.6", "tissue", "time", "treatment")] |>
  as.data.frame() |>
  dplyr::filter(tissue == "Outer sheath")

(p3 <- ggplot2::ggplot(df, ggplot2::aes(x = prediction.score.Va_β, color = RNA_snn_res.0.6)) +
  ggplot2::geom_density(linewidth = 1, alpha = 0.1, fill = "lightgrey") +
  ggplot2::labs(x = "Prediction Score of Outer Sheath", y = "Density", color = "Cluster") +
  ggplot2::theme_bw(base_size = 22, base_family = "Arial") +
  ggplot2::theme(
    panel.grid = ggplot2::element_blank(),
    legend.position = c(0.4, 0.9),
    legend.direction = "horizontal",
    legend.title = ggplot2::element_text(vjust = 1))
)
```

### Co-varying neighbourhood analysis

```{r}
sce_list <- lapply(
  c(MOCK = "MOCK", PNR2 = "PNR2", TR4 = "TR4"),
  function(treat) {
    sce_all_treat <- sce[, sce$treatment == treat | sce$time == "0DPI"]
    
    sce_all_treat$time_val <- as.numeric(factor(
      sce_all_treat$time, levels = c("0DPI", "1DPI", "2DPI", "3DPI")))
    sce_all_treat$sample <- as.character(sce_all_treat$sample_id)
    
    sce_all_treat <- association.SingleCellExperiment(
      sce_all_treat, test_var = "time_val", samplem_key = "sample_id", dimred = "HARMONY")
    
    sce_all_treat
  })
```

```{r}
blue_to_orange <- rev(ggthemes::ggthemes_data[[
  c("tableau", "color-palettes", "ordered-diverging", "Orange-Blue Diverging")]][["value"]])
```

```{r fig.height=7, fig.width=16}
plist <- purrr::imap(
  .x = sce_list,
  .f = function(sce_treat, name) {
    sce_treat <- centerPopulationStimData(sce_treat)
    p <- scater::plotReducedDim(
      sce_treat, dimred = "UMAP",
      colour_by = "cna_ncorrs",
      order_by = I(sample(seq_len(ncol(sce_treat)))),
      point_size = 1,
      theme_size = 22) +
    ggplot2::scale_color_gradientn(colours = blue_to_orange, breaks = c(-0.5, 0, 0.5)) +
    ggplot2::coord_fixed() +
    ggplot2::ggtitle(name) +
    center_plot_title(face = "plain") +
    ggplot2::guides(color = ggplot2::guide_colorbar(
      title = "Coefficient", title.position = "top")) +
    theme_dimred(linesize = 1.5 * PT) +
    ggplot2::theme(
      legend.title = ggplot2::element_text(size = 18, hjust = 0.5),
      legend.text = ggplot2::element_text(size = 18, hjust = 0.5),
      legend.position = c(0.5, 0.01),
      legend.direction = "horizontal",
      legend.key.height = grid::unit(0.4, "cm")
    )
    ggrastr::rasterise(p)
  })

gc()

(p4 <- patchwork::wrap_plots(plist))
```

```{r fig.height=7, fig.width=20}
(p34 <- p3 + p4 + patchwork::plot_layout(width = c(1, 2)))
```

### Each Trajectories

```{r fig.height=7, fig.width=18}
p <- local({
  lapply(1:3, function(i) {
    p <- plotLineageCurveOnReduc(
        sce_os_all, i, dimred = "PHATE",
        linewidth = 1, point_size = 0.5,
        rasterise = TRUE, point_alpha = 1) +
      ggplot2::scale_color_viridis_c(labels = scales::number_format(accuracy = 0.1), n.breaks = 4) +
      ggplot2::coord_fixed() +
      ggplot2::labs(x = "PHATE_1", y = "PHATE_2") +
      ggplot2::ggtitle(paste("Branch", i)) +
      ggplot2::guides(color = ggplot2::guide_colorbar(
        title = "Pseudotime", title.position = "top")) +
      cowplot::theme_cowplot(font_size = 22, font_family = "Arial") +
      theme_dimred(linesize = 1.5 * PT) +
      ggplot2::theme(
        axis.title = ggplot2::element_text(size = 22),
        plot.title = ggplot2::element_text(size = 22, hjust = 0.5, face = "plain"),
        legend.key.width = grid::unit(0.8, "cm"),
        legend.key.height = grid::unit(0.5, "cm"),
        legend.text = ggplot2::element_text(size = 18),
        legend.title = ggplot2::element_text(size = 20),
        legend.direction = "horizontal",
        legend.title.align = 0.5,
        legend.position = c(0.53, 0.01))
    ggrastr::rasterise(p)
  })
})

(p5 <- patchwork::wrap_plots(p))
```

### Pseudotime Distribution

```{r}
cellinfo <- colData(sce_os_all)[, c("time", "treatment")] |>
  as.data.frame() |>
  tibble::rownames_to_column("cell")

trajectory <- slingshot::slingPseudotime(sce_os_all) |>
  as.data.frame() |>
  tibble::rownames_to_column("cell")

trjinfo <- dplyr::left_join(trajectory, cellinfo, by = "cell") |>
  tidyr::pivot_longer(cols = dplyr::starts_with("Lineage"),
                      names_to = "Lineage", values_to = "pseudotime")

trjinfo$Lineage <- factor(trjinfo$Lineage)
trjinfo$Lineage <- forcats::fct_recode(
  trjinfo$Lineage, Branch1 = "Lineage1", Branch2 = "Lineage2", Branch3 = "Lineage3")
```

```{r fig.height=7, fig.width=4}
p6 <- ggplot2::ggplot(trjinfo, ggplot2::aes(x = pseudotime, fill = time)) +
  ggplot2::geom_histogram(position = ggplot2::position_fill(), show.legend = TRUE) +
  ggplot2::facet_wrap(~ Lineage, scales = "free_x", ncol = 1) +
  ggplot2::scale_y_continuous(
    breaks = c(0, 0.5, 1), expand = ggplot2::expansion()) +
  ggplot2::scale_x_continuous(expand = ggplot2::expansion()) +
  ggplot2::labs(x = "Pseudotime", y = "Percent", fill = "Time") +
  ggplot2::theme_bw(base_size = 22) +
  ggplot2::theme(
    panel.grid = ggplot2::element_blank(),
    panel.border = ggplot2::element_blank(),
    #axis.title.y = ggplot2::element_blank(),
    legend.box.spacing = grid::unit(1, "mm"),
    #legend.position = "none",
    strip.background = ggplot2::element_blank(),
    strip.text = ggplot2::element_text(
      size = 18, vjust = 0.2, margin = ggplot2::margin(t = 4, b = 4))
  )

(p6 <- ggrastr::rasterise(p6))
```

```{r eval=FALSE, include=FALSE}
plotpowerpoint(p6, "../data/Figure.pptx",
  location = grid::unit(c(40.2, 38.1, 11.3, 14.68), "cm"),
  fonts = list(sans = "Arial", serif = "Arial", mono = "Courier"))
```

```{r fig.height=7, fig.width=20}
(p56 <- p5 - p6 + patchwork::plot_layout(widths = c(12, 1), nrow = 1))
```

### Combine All Plots

```{r fig.height=20, fig.width=20}
(p <- p12 / p34 / p56)
```


```{r eval=FALSE, include=FALSE}
plotpowerpoint(p, "../data/Figure.pptx",
  location = grid::unit(c(2.5, 4.49, 49.01, 49.01), "cm"),
  fonts = list(sans = "Arial", serif = "Arial", mono = "Courier"))
```

### RNA Velocity on DA Measure

```{r}
p2data <- local({
  scv <- reticulate::import("scvelo")

  adata_all_pnr2 <- readPickle(Sys.glob(
    "../results/ObjectCache/TrajectoryInference/unitvelo_adata_pnr2_*.pickle"))
  adata_all_tr4 <- readPickle(Sys.glob(
    "../results/ObjectCache/TrajectoryInference/unitvelo_adata_tr4_*.pickle"))

  sce_sub_list <- lapply(
    X = list(
      PNR2 = adata_all_pnr2,
      TR4  = adata_all_tr4),
    FUN = function(adata) {
      sce_sub <- sce[, adata$obs_names$to_list()]
      adata$obsm$update(list(X_umap = reducedDim(sce_sub, "UMAP")))
      scv$tl$velocity_embedding(adata, basis = "umap")
      reducedDim(sce_sub, "velocity_umap") <- adata$obsm["velocity_umap"]
      sce_sub
    })

  sce_sub_list
})

p2da <- local({
  da_ctr_all <- readRDS(Sys.glob(
    "../results/ObjectCache/DifferentialAbundance/da_ctr_all_*.rds"))
  list(
    PNR2 = da_ctr_all[["PNR2 vs. MOCK"]],
    TR4 = da_ctr_all[["TR4 vs. MOCK"]]
  )
})
```

```{r fig.height=7, fig.width=12}
p2 <- local({
  plist <- purrr::pmap(list(names(p2data), p2data, p2da), function(name, sce_sub, da) {
    # Plot DA measure
    embedding <- da$embeddings[["umap"]][da$cells$cell.idx, ]
    data_to_plot <- data.frame(
      Dim1 = embedding[, 1],
      Dim2 = embedding[, 2],
      clusters = da$info$ident[da$cells$cell.idx],
      score = da$cells$da.pred)

    p <-  ggplot2::ggplot(data_to_plot) +
      ggplot2::geom_point(
        mapping = ggplot2::aes(x = Dim1, y = Dim2, col = score),
        size = 0.2) +
      ggplot2::scale_color_gradientn(colours = c("blue", "white", "red"))

    p <- ggrastr::rasterise(p)

    # Plot RNA Velocity
    colnames(reducedDim(sce_sub, "UMAP")) <- NULL
    vector_df <- velociraptor::gridVectors(
        reducedDim(sce_sub, "UMAP"),
        reducedDim(sce_sub, "velocity_umap"),
        resolution = 20)
    p <- p +
      ggplot2::geom_segment(
        data = vector_df,
        mapping = ggplot2::aes_string(
          x = "start.1",
          y = "start.2", 
          xend = "end.1",
          yend = "end.2"),
        arrow = grid::arrow(
          length = grid::unit(7, "pt"),
          angle = 30,
          type = "open"),
        linewidth = 0.7) +
      ggplot2::coord_fixed() +
      ggplot2::ggtitle(paste0(name, " vs. MOCK")) +
      ggplot2::labs(x = "UMAP_1", y = "UMAP_2", color = "DA Score") +
      cowplot::theme_cowplot(font_size = 22, font_family = "Arial") +
      theme_dimred(linesize = 1.5 * PT) +
      ggplot2::theme(
        axis.title = ggplot2::element_text(size = 22),
        plot.title = ggplot2::element_text(size = 22, face = "plain", hjust = 0.5),
        legend.title = ggplot2::element_text(size = 20),
        legend.text = ggplot2::element_text(size = 18))

    p
  })

  plist
})
```

```{r fig.height=7, fig.width=19}
(p12 <- p1 + p2)
```

```{r eval=FALSE, include=FALSE}
plotpowerpoint(p12, "../data/Figure.pptx",
  location = grid::unit(c(2.5, 4.49, 49.01, 18.07), "cm"),
  fonts = list(sans = "Arial", serif = "Arial", mono = "Courier"))
```

## Supplementary Figure 8 Condition-specific Genes

```{r}
tradeSce_os_cond <- readRDS(Sys.glob(
  "../results/ObjectCache/TrajectoryInference/tradeseq_gam_os_condition_*.rds"))
```

```{r}
conditionRes_os_all <- readRDS(Sys.glob(
  "../results/ObjectCache/TrajectoryInference/tradeseq_conditionRes_os_pairlineages_*.rds"))
```

### Differential Progression

```{r fig.height=3, fig.width=7}
plotCurveTopology(tradeSce_os_cond)
```

```{r fig.height=5, fig.width=14}
plotPseudotimeDensity(tradeSce_os_cond)
```

### Generate Pseudotime Expression Matrix

```{r}
yhatSmoothDf <- tradeSeq::predictSmooth(
  tradeSce_os_cond, rownames(tradeSce_os_cond), nPoints = 100, tidy = FALSE)

str(yhatSmoothDf)
```

```{r}
yhatSmoothDf_list <- lapply(
  X = list(
    "Branch 1 - MOCK" = paste0("lineage1_conditionMOCK_point", 1:100),
    "Branch 1 - PNR2" = paste0("lineage1_conditionPNR2_point", 1:100),
    "Branch 1 - TR4"  = paste0("lineage1_conditionTR4_point", 1:100),

    "Branch 2 - MOCK" = paste0("lineage2_conditionMOCK_point", 1:100),
    "Branch 2 - PNR2" = paste0("lineage2_conditionPNR2_point", 1:100),
    "Branch 2 - TR4"  = paste0("lineage2_conditionTR4_point", 1:100),

    "Branch 3 - MOCK" = paste0("lineage3_conditionMOCK_point", 1:100),
    "Branch 3 - PNR2" = paste0("lineage3_conditionPNR2_point", 1:100),
    "Branch 3 - TR4"  = paste0("lineage3_conditionTR4_point", 1:100)
  ),
  FUN = function(cols) {
    mtx = yhatSmoothDf[, cols, drop=FALSE]
    mtx[!is.na(rowSums(mtx)), ]
  }
)

str(yhatSmoothDf_list)
```

```{r eval=FALSE, include=FALSE}
wb <- openxlsx::createWorkbook()

for (sheet in names(yhatSmoothDf_list)) {
  openxlsx::addWorksheet(wb, sheet)
  openxlsx::writeDataTable(wb, sheet,
    tibble::rownames_to_column(as.data.frame(yhatSmoothDf_list[[sheet]]), "Gene")
  )
}

openxlsx::saveWorkbook(
  wb, file = "../results/DataPlots/SupplementaryTable_X_traj_parenchyma_pseudotime_expr.xlsx",
  overwrite = TRUE)
```

### Condition-specific Genes

```{r}
levels(colData(tradeSce_os_cond)$tradeSeq$conditions)
```

```{r}
str(conditionRes_os_all)
```

### Branch 2 - PNR2 vs. TR4

```{r}
conditionRes_os_branch2 <- conditionRes_os_all[, c(
    "waldStat_lineage2_conds2vs3", "df_lineage2_conds2vs3",
    "pvalue_lineage2_conds2vs3")] |>
  dplyr::rename_with(\(x) stringr::str_remove(x, "_lineage2_conds2vs3")) |>
  tibble::rownames_to_column("gene") |>
  dplyr::filter(!is.na(waldStat)) |>
  dplyr::mutate(fdr = p.adjust(pvalue, "fdr"))
```

```{r}
conditionRes_os_branch2 |>
  dplyr::arrange(fdr) |>
  ggplot2::ggplot(ggplot2::aes(
    x = waldStat, y = -log(pvalue), color = fdr < 0.01)) +
  ggplot2::geom_point() +
  NULL
```

```{r}
conditionRes_os_branch2 <- conditionRes_os_branch2 |>
  dplyr::filter(fdr <= 0.01) |>
  dplyr::arrange(dplyr::desc(waldStat))

conditionRes_os_branch2
```


```{r}
length(conditionGenes_branch2 <- unique(dplyr::pull(conditionRes_os_branch2, gene)))
```

```{r}
yhatSmoothDf <- clustExpressionPatterns(
  tradeSce_os_cond, conditionGenes_branch2, k = 6, seed = 240203)

str(yhatSmoothDf)
```

```{r}
conditionGenes_branch2[116:120]
```

```{r fig.height=10, fig.width=7}
yhatSmoothDf |>
  dplyr::filter(gene %in% conditionGenes_branch2[116:120]) |>
  dplyr::mutate(gene = factor(gene, conditionGenes_branch2[116:120])) |>
  plotExpressionPatterns(yhatScaled) +
  ggplot2::scale_color_brewer(type = "qual", palette = "Dark2") +
  ggplot2::facet_grid(gene ~ lineage)
```

```{r fig.height=3, fig.width=7}
p <- plotPseudotimeExpression(
    tradeSce_os_cond, "TraesCS4B02G188200",
    color_by = condition, lwd = 1, bwd = 0.5) +
  ggplot2::facet_wrap(
    ~ sub("Lineage", "Branch", lineage, fixed = TRUE),
    scales = "free_x") +
  ggplot2::scale_color_brewer(type = "qual", palette = "Dark2") +
  ggplot2::ggtitle("ALD1-like") +
  theme_smoothers()

p
```

### PR1 Expression Dynamics

```{r}
df_rowanno <- ds_sig |>
  rhapsodykit::diff_state_format() |>
  dplyr::mutate(
    time = stringr::str_extract(contrast, "\\dDPI"),
    comparison = stringr::str_replace(contrast,
      "X(\\dDPI)\\.(.*)-X(\\dDPI)\\.(.*)", "\\2 vs. \\4")) |>
  dplyr::filter(comparison != "PNR2 vs. TR4")  |>
  dplyr::group_by(gene) |>
  dplyr::summarise(hits = dplyr::n(), regu_score = sum(logFC / abs(logFC)))

head(df_rowanno)
```

```{r fig.height=4, fig.width=12}
pFun <- local({
  df_genes <- readxl::read_xlsx("../data/immunity/TaPR1.xlsx") |>
    dplyr::filter(GeneID %in% rownames(cpm_se)) |>
    dplyr::left_join(df_rowanno, by = c(GeneID = "gene"))

  assay_use = "scaled"
  # Prepare expression matrix
  cpm_sesub <- cpm_se[df_genes$GeneID, ]
  rowData(cpm_sesub) <- df_genes
  mtx <- SummarizedExperiment::assay(cpm_sesub, assay_use)
  colHA <- makeColumnAnnotation(colData(cpm_sesub))
  rowHA <- makeRowAnnotation(rowData(cpm_sesub))
  col_fun <- makeColorFunction(
    SummarizedExperiment::assay(cpm_sesub, "scaled"),
    function(n) colorRampPalette(
      c("darkgrey", "grey", "white", "yellow", "red", "darkred"))(n))
  
  # Create heatmap
  p <- ComplexHeatmap::Heatmap(
    matrix = mtx,
    col = col_fun,
    use_raster = TRUE,
    border = TRUE,
    na_col = "grey",

    row_labels = rowData(cpm_sesub)[["Name"]],
    show_row_names = TRUE,
    row_names_gp = grid::gpar(fontsize = 7),
    cluster_row_slices = FALSE,
    cluster_row = TRUE,
    clustering_method_rows = "average",
    row_title_rot = 90,
    row_title_side = "left",
    row_title_gp = grid::gpar(fontsize = 16, fontfamily = "Arial"),
    row_split = rowData(cpm_sesub)[["Module"]],

    top_annotation = colHA,
    right_annotation = rowHA,
    column_split = colData(cpm_sesub)[["cellType"]],
    column_title = c("ST", "EP", "CH", "PA", "VOS", "VIS", "PH", "PR"),
    cluster_columns = FALSE,
    show_column_names = FALSE,
    column_title_gp = grid::gpar(fontsize = 16, fontfamily = "Arial"),

    heatmap_legend_param = list(
      title = switch(assay_use, raw = "CPM", scaled = "Z-score"),
      direction = "horizontal",
      title_position = "topleft",
      title_gp = grid::gpar(fontsize = 20,
                            fontfamily = "Arial"),
      labels_gp = grid::gpar(fontsize = 16, fontfamily = "Arial"),
      legend_width = unit(8, "cm"))
  )

  # Wrap drawing function
  function(...) {
    suppressWarnings(
      ComplexHeatmap::draw(p,
        merge_legend = TRUE,
        heatmap_legend_side = "top", 
        annotation_legend_side = "top",
        legend_gap = grid::unit(1.5, "cm"),
        align_heatmap_legend = "heatmap_left",
        align_annotation_legend = "heatmap_left",
        ...
      )
    )
  }
})

pFun(show_heatmap_legend = FALSE)
```

```{r fig.height=7, fig.width=14}
local({
  genedf <- data.frame(
    cluster = yhatkm$cluster,
    gene = names(yhatkm$km$cluster)
  )

  exprdf <- yhatkm$mtx |>
    as.data.frame() |>
    tibble::rownames_to_column("gene") |>
    tidyr::pivot_longer(cols = !gene,
                        names_pattern = "lineage(\\d+)_(\\d+)",
                        names_to = c("lineage", "pseudotime"),
                        values_to = "expression") |>
    dplyr::mutate(pseudotime = as.numeric(pseudotime),
                  lineage = paste("Branch", lineage))

  df_to_plot <- dplyr::left_join(exprdf, genedf, by = "gene") |>
    dplyr::select(gene, cluster, dplyr::everything()) |>
    dplyr::mutate(group = paste(gene, lineage))

  TaPR1 <- readxl::read_xlsx("../data/immunity/TaPR1.xlsx")

  df_to_plot <- df_to_plot |>
    dplyr::left_join(TaPR1, by = c("gene" = "GeneID")) |>
    dplyr::filter(!is.na(Name))

  df_to_plot |>
    ggplot2::ggplot(ggplot2::aes(
      x = pseudotime, y = expression)) +
    ggplot2::geom_line(
      mapping = ggplot2::aes(
        group = group, color = lineage),
      linewidth = 1.5) +
    ggplot2::facet_wrap(~ Name, scales = "free_y") +
    ggplot2::labs(x = "Pseudotime", y = "Normalized Expression", color = "Branch") +
    ggplot2::theme_bw(base_size = 22) +
    ggplot2::theme(
      panel.grid = ggplot2::element_blank(),
      strip.text = ggplot2::element_text(
        size = 16, vjust = 0.2, margin = ggplot2::margin(t = 4, b = 4),
        face = "italic"),
      axis.text.x = ggplot2::element_text(
        size = 16, angle = 0, hjust = 0.5, vjust = 0.5, color = "black"),
      axis.text.y = ggplot2::element_text(size = 16, color = "black"),
      axis.ticks = ggplot2::element_line(linewidth = 1.5 * PT),
      strip.background = ggplot2::element_rect(linewidth = 1.5 * PT),
      panel.border = ggplot2::element_rect(linewidth = 1.5 * PT),
      legend.position = c(0.9, 0.15),
      legend.background = ggplot2::element_blank(),
      legend.title = ggplot2::element_blank())
})
```

```{r fig.height=3, fig.width=7}
p <- plotPseudotimeExpression(
    tradeSce_os_cond, "TraesCS7D02G201300",
    color_by = condition, lwd = 1, bwd = 0.5) +
  ggplot2::facet_wrap(
    ~ sub("Lineage", "Branch", lineage, fixed = TRUE),
    scales = "free_x") +
  ggplot2::scale_color_brewer(type = "qual", palette = "Dark2") +
  ggplot2::ggtitle("TaPR1-80") +
  theme_smoothers()

p
```
### PR5 Expression Dynamics

```{r fig.height=7, fig.width=12}
pFun <- local({
  df_genes <- readxl::read_xlsx("../data/immunity/TaTLP.xlsx", sheet = "List2") |>
    dplyr::filter(Gene %in% rownames(cpm_se)) |>
    dplyr::left_join(df_rowanno, by = c(Gene = "gene"))

  assay_use = "scaled"
  # Prepare expression matrix
  cpm_sesub <- cpm_se[df_genes$Gene, ]
  rowData(cpm_sesub) <- df_genes
  mtx <- SummarizedExperiment::assay(cpm_sesub, assay_use)
  colHA <- makeColumnAnnotation(colData(cpm_sesub))
  rowHA <- makeRowAnnotation(rowData(cpm_sesub))
  col_fun <- makeColorFunction(
    SummarizedExperiment::assay(cpm_sesub, "scaled"),
    function(n) colorRampPalette(
      c("darkgrey", "grey", "white", "yellow", "red", "darkred"))(n))
  
  # Create heatmap
  p <- ComplexHeatmap::Heatmap(
    matrix = mtx,
    col = col_fun,
    use_raster = TRUE,
    border = TRUE,
    na_col = "grey",

    row_labels = rowData(cpm_sesub)[["Name"]],
    show_row_names = TRUE,
    row_names_gp = grid::gpar(fontsize = 7),
    cluster_row_slices = FALSE,
    cluster_row = TRUE,
    clustering_method_rows = "average",
    row_title_rot = 90,
    row_title_side = "left",
    row_title_gp = grid::gpar(fontsize = 16, fontfamily = "Arial"),
    row_split = rowData(cpm_sesub)[["Module"]],

    top_annotation = colHA,
    right_annotation = rowHA,
    column_split = colData(cpm_sesub)[["cellType"]],
    column_title = c("ST", "EP", "CH", "PA", "VOS", "VIS", "PH", "PR"),
    cluster_columns = FALSE,
    show_column_names = FALSE,
    column_title_gp = grid::gpar(fontsize = 16, fontfamily = "Arial"),

    heatmap_legend_param = list(
      title = switch(assay_use, raw = "CPM", scaled = "Z-score"),
      direction = "horizontal",
      title_position = "topleft",
      title_gp = grid::gpar(fontsize = 20,
                            fontfamily = "Arial"),
      labels_gp = grid::gpar(fontsize = 16, fontfamily = "Arial"),
      legend_width = unit(8, "cm"))
  )

  # Wrap drawing function
  function(...) {
    suppressWarnings(
      ComplexHeatmap::draw(p,
        merge_legend = TRUE,
        heatmap_legend_side = "top", 
        annotation_legend_side = "top",
        legend_gap = grid::unit(1.5, "cm"),
        align_heatmap_legend = "heatmap_left",
        align_annotation_legend = "heatmap_left",
        ...
      )
    )
  }
})

pFun(show_heatmap_legend = FALSE)
```

```{r fig.height=7, fig.width=14}
local({
  genedf <- data.frame(
    cluster = yhatkm$cluster,
    gene = names(yhatkm$km$cluster)
  )

  exprdf <- yhatkm$mtx |>
    as.data.frame() |>
    tibble::rownames_to_column("gene") |>
    tidyr::pivot_longer(cols = !gene,
                        names_pattern = "lineage(\\d+)_(\\d+)",
                        names_to = c("lineage", "pseudotime"),
                        values_to = "expression") |>
    dplyr::mutate(pseudotime = as.numeric(pseudotime),
                  lineage = paste("Branch", lineage))

  df_to_plot <- dplyr::left_join(exprdf, genedf, by = "gene") |>
    dplyr::select(gene, cluster, dplyr::everything()) |>
    dplyr::mutate(group = paste(gene, lineage))

  TaPR1 <- readxl::read_xlsx("../data/immunity/TaTLP.xlsx", sheet = "List2")

  df_to_plot <- df_to_plot |>
    dplyr::left_join(TaPR1, by = c("gene" = "Gene")) |>
    dplyr::filter(!is.na(Name))

  df_to_plot |>
    ggplot2::ggplot(ggplot2::aes(
      x = pseudotime, y = expression)) +
    ggplot2::geom_line(
      mapping = ggplot2::aes(
        group = group, color = lineage),
      linewidth = 1.5) +
    ggplot2::facet_wrap(~ Name, scales = "free_y") +
    ggplot2::labs(x = "Pseudotime", y = "Normalized Expression", color = "Branch") +
    ggplot2::theme_bw(base_size = 22) +
    ggplot2::theme(
      panel.grid = ggplot2::element_blank(),
      strip.text = ggplot2::element_text(
        size = 16, vjust = 0.2, margin = ggplot2::margin(t = 4, b = 4),
        face = "italic"),
      axis.text.x = ggplot2::element_text(
        size = 16, angle = 0, hjust = 0.5, vjust = 0.5, color = "black"),
      axis.text.y = ggplot2::element_text(size = 16, color = "black"),
      axis.ticks = ggplot2::element_line(linewidth = 1.5 * PT),
      strip.background = ggplot2::element_rect(linewidth = 1.5 * PT),
      panel.border = ggplot2::element_rect(linewidth = 1.5 * PT),
      legend.position = c(0.9, 0.12),
      legend.background = ggplot2::element_blank(),
      legend.title = ggplot2::element_blank())
})
```

```{r fig.height=3, fig.width=7}
p <- plotPseudotimeExpression(
    tradeSce_os_cond, "TraesCS5B02G016100",
    color_by = condition, lwd = 1, bwd = 0.5) +
  ggplot2::facet_wrap(
    ~ sub("Lineage", "Branch", lineage, fixed = TRUE),
    scales = "free_x") +
  ggplot2::scale_color_brewer(type = "qual", palette = "Dark2") +
  ggplot2::ggtitle("TaTLP14-B4") +
  theme_smoothers()

p
```

### Peroxidase Expression

```{r fig.height=3, fig.width=7}
p <- plotPseudotimeExpression(
    tradeSce_os_cond, "TraesCS2A02G573900",
    color_by = condition, lwd = 1, bwd = 0.5) +
  ggplot2::facet_wrap(
    ~ sub("Lineage", "Branch", lineage, fixed = TRUE),
    scales = "free_x") +
  ggplot2::scale_color_brewer(type = "qual", palette = "Dark2") +
  ggplot2::ggtitle("TaPRX-2A") +
  theme_smoothers()

p
```

```{r fig.height=3, fig.width=7}
p <- plotPseudotimeExpression(
    tradeSce_os_cond, "TraesCS3D02G305300",
    color_by = condition, lwd = 1, bwd = 0.5) +
  ggplot2::facet_wrap(
    ~ sub("Lineage", "Branch", lineage, fixed = TRUE),
    scales = "free_x") +
  ggplot2::scale_color_brewer(type = "qual", palette = "Dark2") +
  ggplot2::ggtitle("Peroxidase - TraesCS3D02G305300") +
  theme_smoothers()

p
```

```{r fig.height=3, fig.width=7}
p <- plotPseudotimeExpression(
    tradeSce_os_cond, "TraesCS3D02G407200",
    color_by = condition, lwd = 1, bwd = 0.5) +
  ggplot2::facet_wrap(
    ~ sub("Lineage", "Branch", lineage, fixed = TRUE),
    scales = "free_x") +
  ggplot2::scale_color_brewer(type = "qual", palette = "Dark2") +
  ggplot2::ggtitle("Peroxidase - TraesCS3D02G407200") +
  theme_smoothers()

p
```

### Lignin Expression Dynamics

```{r fig.height=3, fig.width=7}
p <- plotPseudotimeExpression(
    tradeSce_os_cond, "TraesCS3D02G080700",
    color_by = condition, lwd = 1, bwd = 0.5) +
  ggplot2::facet_wrap(
    ~ sub("Lineage", "Branch", lineage, fixed = TRUE),
    scales = "free_x") +
  ggplot2::scale_color_brewer(type = "qual", palette = "Dark2") +
  ggplot2::ggtitle("Dirigent protein - TraesCS3D02G080700") +
  theme_smoothers()

p
```

```{r fig.height=3, fig.width=7}
p <- plotPseudotimeExpression(
    tradeSce_os_cond, "TraesCS1B02G202400",
    color_by = condition, lwd = 1, bwd = 0.5) +
  ggplot2::facet_wrap(
    ~ sub("Lineage", "Branch", lineage, fixed = TRUE),
    scales = "free_x") +
  ggplot2::scale_color_brewer(type = "qual", palette = "Dark2") +
  ggplot2::ggtitle("F5H") +
  theme_smoothers()

p
```

```{r fig.height=3, fig.width=7}
p <- plotPseudotimeExpression(
    tradeSce_os_cond, "TraesCS6B02G201600",
    color_by = condition, lwd = 1, bwd = 0.5) +
  ggplot2::facet_wrap(
    ~ sub("Lineage", "Branch", lineage, fixed = TRUE),
    scales = "free_x") +
  ggplot2::scale_color_brewer(type = "qual", palette = "Dark2") +
  ggplot2::ggtitle("CAD") +
  theme_smoothers()

p
```

### Known Wheat Genes

```{r fig.height=3, fig.width=7}
p <- plotPseudotimeExpression(
    tradeSce_os_cond, "TraesCS5B02G148300",
    color_by = condition, lwd = 1, bwd = 0.5) +
  ggplot2::facet_wrap(
    ~ sub("Lineage", "Branch", lineage, fixed = TRUE),
    scales = "free_x") +
  ggplot2::scale_color_brewer(type = "qual", palette = "Dark2") +
  ggplot2::ggtitle("TaUGT12887") +
  theme_smoothers()

p
```

```{r fig.height=3, fig.width=7}
p <- plotPseudotimeExpression(
    tradeSce_os_cond, "TraesCS2A02G048600",
    color_by = condition, lwd = 1, bwd = 0.5) +
  ggplot2::facet_wrap(
    ~ sub("Lineage", "Branch", lineage, fixed = TRUE),
    scales = "free_x") +
  ggplot2::scale_color_brewer(type = "qual", palette = "Dark2") +
  ggplot2::ggtitle("TaSAM") +
  theme_smoothers()

p
```

```{r fig.height=3, fig.width=7}
p <- plotPseudotimeExpression(
    tradeSce_os_cond, "TraesCS4D02G319100",
    color_by = condition, lwd = 1, bwd = 0.5) +
  ggplot2::facet_wrap(
    ~ sub("Lineage", "Branch", lineage, fixed = TRUE),
    scales = "free_x") +
  ggplot2::scale_color_brewer(type = "qual", palette = "Dark2") +
  ggplot2::ggtitle("TaMlo-D1") +
  theme_smoothers()

p
```

```{r fig.height=3, fig.width=7}
p <- plotPseudotimeExpression(
    tradeSce_os_cond, "TraesCS4A02G201900",
    color_by = condition, lwd = 1, bwd = 0.5) +
  ggplot2::facet_wrap(
    ~ sub("Lineage", "Branch", lineage, fixed = TRUE),
    scales = "free_x") +
  ggplot2::scale_color_brewer(type = "qual", palette = "Dark2") +
  ggplot2::ggtitle("TaFROG") +
  theme_smoothers()

p
```

```{r fig.height=3, fig.width=7}
p <- plotPseudotimeExpression(
    tradeSce_os_cond, "TraesCS5D02G487900",
    color_by = condition, lwd = 1, bwd = 0.5) +
  ggplot2::facet_wrap(
    ~ sub("Lineage", "Branch", lineage, fixed = TRUE),
    scales = "free_x") +
  ggplot2::scale_color_brewer(type = "qual", palette = "Dark2") +
  ggplot2::ggtitle("TaCYP71F53") +
  theme_smoothers()

p
```

### Selected Representative Genes

```{r}
repr_genes <- c(
  "TaPR1-51" = "TraesCS5D02G446800",
  "TaPR1-79" = "TraesCS7D02G161200",
  "TaPR1-80" = "TraesCS7D02G201300",

  "TaPOD237" = "TraesCS2D02G107900",
  "TaPOD363" = "TraesCS3D02G407200",
  "TaPOD356" = "TraesCS3D02G305300",

  "TaTLP14-B5" = "TraesCS7B02G417700",
  "TaTLP16-A"  = "TraesCS5A02G018200",
  "TaTLP32-A"  = "TraesCS7A02G558500",

  "TaUGT12887" = "TraesCS5B02G148300",
  "TaCYP71F53" = "TraesCS5D02G487900",
  "TaSAM"      = "TraesCS2A02G048600",
  "TaACT"      = "TraesCS2D02G490400",
  "TaFROG"     = "TraesCS4A02G201900",

  "Glycosyltransferase" = "TraesCS2B02G040500",
  "Auxin-responsive protein" = "TraesCS1D02G119500",
  "Flavin-containing monooxygenase" = "TraesCSU02G099800"
)

plist <- mapply(
  repr_genes,
  names(repr_genes),
  SIMPLIFY = FALSE,
  FUN = function(gene, name) {
    p <- plotPseudotimeExpression(
        tradeSce_os_cond, gene,
        color_by = condition, lwd = 1, bwd = 0.5) +
      ggplot2::facet_wrap(
        ~ sub("Lineage", "Branch", lineage, fixed = TRUE),
        scales = "free_x") +
      ggplot2::labs(y = "Expr Level", color = "Treatment") +
      ggplot2::scale_color_brewer(type = "qual", palette = "Dark2") +
      ggplot2::ggtitle(name) +
      theme_smoothers(
        legend.title = ggplot2::element_text(size = 20),
        legend.text = ggplot2::element_text(size = 16)
      )

    ggrastr::rasterise(p)
})
```

```{r fig.height=14, fig.width=14}
p <- patchwork::wrap_plots(plist, ncol = 3, guides = "collect") +
  patchwork::guide_area()

p
```

```{r eval=FALSE, include=FALSE}
plotpowerpoint(p, "../data/Figure.pptx",
  location = grid::unit(c(2.5, 4.49, 49.01, 49.01), "cm"),
  fonts = list(sans = "Arial", serif = "Arial", mono = "Courier"))
```

## Supplementary Table 5

```{r}
df_pst <- split(names(yhatkm$km$cluster), paste0("G", yhatkm$km$cluster)) |>
  tibble::enframe("Module", "Gene") |>
  tidyr::unnest(cols = Gene)
```

```{r}
anno <- brookite::pull_annotation(
  unique(df_pst$Gene),
  mart_info = list(
    mart = "plants_mart",
    dataset = "taestivum_eg_gene",
    host = "https://plants.ensembl.org"
  ),
  dest_attrs = c(
    Description = "description",
    GO_ID = "go_id",
    GO_Name = "name_1006",
    GO_Level = "namespace_1003"
  ))

df_pst <- dplyr::left_join(df_pst, anno, by = c("Gene" = "ensembl_gene_id"))
```

```{r}
dplyr::sample_n(df_pst, 20)
```

```{r}
openxlsx::write.xlsx(df_pst, "../results/DataPlots/SupplementaryTable_5_OS_PST.xlsx")
```

